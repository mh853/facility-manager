# AWS Lambda ë³´ì¡°ê¸ˆ ê³µê³  í¬ë¡¤ëŸ¬
# ë§¤ì¼ ì˜¤ì „ 11ì‹œ (KST) ì‹¤í–‰ - 211ê°œ ì§ì ‘ URL í¬ë¡¤ë§

name: Lambda Subsidy Crawler

on:
  # ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ - KSTëŠ” +9ì‹œê°„)
  schedule:
    - cron: '0 2 * * *'   # ë§¤ì¼ 02:00 UTC = 11:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      batch_number:
        description: 'íŠ¹ì • ë°°ì¹˜ ë²ˆí˜¸ (1-77, ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''

env:
  # AWS Lambda Function URL
  LAMBDA_CRAWLER_URL: ${{ secrets.LAMBDA_CRAWLER_URL }}
  # Vercel (Supabase ì—…ë°ì´íŠ¸ìš©)
  API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://facility.blueon-iot.com' }}
  # ë°°ì¹˜ í¬ê¸° (Lambda 15ë¶„ íƒ€ì„ì•„ì›ƒ - ì¶©ë¶„í•¨)
  BATCH_SIZE: 3

jobs:
  # ============================================================
  # Job 1: í¬ë¡¤ë§ ì¤€ë¹„ ë° ìƒíƒœ í™•ì¸
  # ============================================================
  prepare:
    name: ì¤€ë¹„ ë° ìƒíƒœ í™•ì¸
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      total_urls: ${{ steps.check.outputs.total_urls }}
      total_batches: ${{ steps.check.outputs.total_batches }}
      run_id: ${{ steps.create_run.outputs.run_id }}

    steps:
      - name: ğŸ• í˜„ì¬ ì‹œê°„ í‘œì‹œ
        run: |
          echo "â° ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸ“ í¬ë¡¤ë§ ì‹¤í–‰ ê¸°ë¡ ìƒì„±
        id: create_run
        run: |
          # Phase ì´ë¦„ ìƒì„±
          PHASE_NAME="lambda_$(date -u +%Y-%m-%dT%H-%M-%S)"
          echo "phase_name=$PHASE_NAME" >> $GITHUB_OUTPUT

          # RUN_ID ìƒì„± (GitHub Actions ê³ ìœ  ID)
          RUN_ID="${{ github.run_id }}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          echo "âœ… RUN_ID: $RUN_ID"
          echo "âœ… Phase: $PHASE_NAME"

          # Supabaseì— ì‹¤í–‰ ê¸°ë¡ ìƒì„±
          RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/subsidy-crawler/runs" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.CRAWLER_SECRET }}" \
            -d "{
              \"run_id\": \"$RUN_ID\",
              \"phase\": \"$PHASE_NAME\",
              \"trigger_type\": \"${{ github.event_name == 'schedule' && 'scheduled' || 'manual' }}\",
              \"status\": \"running\"
            }")

          echo "Response: $RESPONSE"

      - name: ğŸ” URL ê°œìˆ˜ í™•ì¸
        id: check
        run: |
          # Supabaseì—ì„œ í™œì„± URL ê°œìˆ˜ ì¡°íšŒ
          RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/subsidy-crawler/urls?is_active=true")

          TOTAL_URLS=$(echo $RESPONSE | jq -r '.total')
          echo "total_urls=$TOTAL_URLS" >> $GITHUB_OUTPUT

          # ë°°ì¹˜ ê°œìˆ˜ ê³„ì‚°
          TOTAL_BATCHES=$(( ($TOTAL_URLS + ${{ env.BATCH_SIZE }} - 1) / ${{ env.BATCH_SIZE }} ))
          echo "total_batches=$TOTAL_BATCHES" >> $GITHUB_OUTPUT

          echo "âœ… ì´ URL: $TOTAL_URLSê°œ"
          echo "âœ… ë°°ì¹˜ í¬ê¸°: ${{ env.BATCH_SIZE }}ê°œ"
          echo "âœ… ì´ ë°°ì¹˜: $TOTAL_BATCHESê°œ"

  # ============================================================
  # Job 2: Lambda í¬ë¡¤ë§ (ë°°ì¹˜ë³„ ë³‘ë ¬ ì‹¤í–‰)
  # ============================================================
  crawl:
    name: ë°°ì¹˜ ${{ matrix.batch }} í¬ë¡¤ë§
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 20  # Lambda 15ë¶„ + ì—¬ìœ 

    strategy:
      max-parallel: 5  # LambdaëŠ” ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥
      fail-fast: false
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77]

    steps:
      - name: ğŸš€ ë°°ì¹˜ ${{ matrix.batch }} Lambda í¬ë¡¤ë§ ì‹œì‘
        id: crawl_batch
        run: |
          echo "ğŸ“¦ ë°°ì¹˜ ${{ matrix.batch }} ì‹œì‘"

          # Supabaseì—ì„œ ë°°ì¹˜ë³„ URL ê°€ì ¸ì˜¤ê¸°
          URLS_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/subsidy-crawler/urls?batch=${{ matrix.batch }}&batch_size=${{ env.BATCH_SIZE }}&is_active=true")

          URLS=$(echo $URLS_RESPONSE | jq -c '.urls | map(.source_url)')
          URL_COUNT=$(echo $URLS | jq '. | length')

          if [ "$URL_COUNT" -eq 0 ]; then
            echo "âš ï¸ ë°°ì¹˜ ${{ matrix.batch }}ì— URLì´ ì—†ìŠµë‹ˆë‹¤."
            echo "batch_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“‹ í¬ë¡¤ë§í•  URL: $URL_COUNTê°œ"

          # ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œì‘)
          curl -s -X POST "${{ env.API_BASE_URL }}/api/subsidy-crawler/batches" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.CRAWLER_SECRET }}" \
            -d "{
              \"run_id\": \"${{ needs.prepare.outputs.run_id }}\",
              \"batch_number\": ${{ matrix.batch }},
              \"status\": \"running\",
              \"urls_in_batch\": $URL_COUNT
            }"

          # AWS Lambda í˜¸ì¶œ
          BODY=$(cat <<EOF
          {
            "urls": $URLS,
            "secret": "${{ secrets.CRAWLER_SECRET }}",
            "batch_number": ${{ matrix.batch }},
            "run_id": "${{ needs.prepare.outputs.run_id }}"
          }
          EOF
          )

          echo "ğŸŒ Lambda í•¨ìˆ˜ í˜¸ì¶œ ì¤‘..."
          START_TIME=$(date +%s)

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ env.LAMBDA_CRAWLER_URL }}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Duration: ${DURATION}s"
          echo "Response: $BODY"

          # ì„±ê³µ ì—¬ë¶€ í™•ì¸
          if [ "$HTTP_CODE" = "200" ]; then
            SUCCESS_COUNT=$(echo $BODY | jq -r '.results.successful_urls // 0')
            FAILED_COUNT=$(echo $BODY | jq -r '.results.failed_urls // 0')
            ANNOUNCEMENTS=$(echo $BODY | jq -r '.results.total_announcements // 0')

            echo "âœ… ë°°ì¹˜ ${{ matrix.batch }} ì„±ê³µ"
            echo "  - ì„±ê³µ URL: $SUCCESS_COUNTê°œ"
            echo "  - ì‹¤íŒ¨ URL: $FAILED_COUNTê°œ"
            echo "  - ê³µê³  ìˆ˜: $ANNOUNCEMENTSê°œ"
            echo "  - ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

            # ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì™„ë£Œ)
            curl -s -X PUT "${{ env.API_BASE_URL }}/api/subsidy-crawler/batches" \
              -H "Content-Type: application/json" \
              -H "x-api-key: ${{ secrets.CRAWLER_SECRET }}" \
              -d "{
                \"run_id\": \"${{ needs.prepare.outputs.run_id }}\",
                \"batch_number\": ${{ matrix.batch }},
                \"status\": \"completed\",
                \"successful_urls\": $SUCCESS_COUNT,
                \"failed_urls\": $FAILED_COUNT,
                \"total_announcements\": $ANNOUNCEMENTS,
                \"avg_response_time_ms\": $((DURATION * 1000 / URL_COUNT))
              }"

            echo "batch_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë°°ì¹˜ ${{ matrix.batch }} ì‹¤íŒ¨"
            echo "  - HTTP Code: $HTTP_CODE"
            echo "  - Error: $BODY"

            # ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤íŒ¨)
            curl -s -X PUT "${{ env.API_BASE_URL }}/api/subsidy-crawler/batches" \
              -H "Content-Type: application/json" \
              -H "x-api-key: ${{ secrets.CRAWLER_SECRET }}" \
              -d "{
                \"run_id\": \"${{ needs.prepare.outputs.run_id }}\",
                \"batch_number\": ${{ matrix.batch }},
                \"status\": \"failed\",
                \"successful_urls\": 0,
                \"failed_urls\": $URL_COUNT
              }"

            echo "batch_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================================
  # Job 3: í¬ë¡¤ë§ ì™„ë£Œ ë° ê²°ê³¼ ì§‘ê³„
  # ============================================================
  finalize:
    name: ì™„ë£Œ ë° ê²°ê³¼ ì§‘ê³„
    runs-on: ubuntu-latest
    needs: [prepare, crawl]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š í¬ë¡¤ë§ ê²°ê³¼ ì§‘ê³„
        run: |
          echo "ğŸ‰ Lambda í¬ë¡¤ë§ ì™„ë£Œ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ì‹¤í–‰ ì •ë³´:"
          echo "  - RUN_ID: ${{ needs.prepare.outputs.run_id }}"
          echo "  - ì´ URL: ${{ needs.prepare.outputs.total_urls }}ê°œ"
          echo "  - ì´ ë°°ì¹˜: ${{ needs.prepare.outputs.total_batches }}ê°œ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ”„ ì‹¤í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
        run: |
          # ìµœì¢… ìƒíƒœ ê²°ì •
          STATUS="completed"
          if [ "${{ needs.crawl.result }}" = "failure" ]; then
            STATUS="partial"
          fi

          # Supabase ì—…ë°ì´íŠ¸
          curl -s -X PUT "${{ env.API_BASE_URL }}/api/subsidy-crawler/runs" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.CRAWLER_SECRET }}" \
            -d "{
              \"run_id\": \"${{ needs.prepare.outputs.run_id }}\",
              \"status\": \"$STATUS\"
            }"

          echo "âœ… ì‹¤í–‰ ìƒíƒœ: $STATUS"
