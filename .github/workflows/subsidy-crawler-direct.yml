# ì§ì ‘ URL ë³´ì¡°ê¸ˆ ê³µê³  í¬ë¡¤ëŸ¬
# ë§¤ì¼ ì˜¤ì „ 11ì‹œ (KST) ì‹¤í–‰ - 230ê°œ ì§ì ‘ URL í¬ë¡¤ë§

name: Direct URL Subsidy Crawler

on:
  # ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ - KSTëŠ” +9ì‹œê°„)
  schedule:
    - cron: '0 2 * * *'   # ë§¤ì¼ 02:00 UTC = 11:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      batch_number:
        description: 'íŠ¹ì • ë°°ì¹˜ ë²ˆí˜¸ (1-22, ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''
      retry_failed:
        description: 'ì‹¤íŒ¨í•œ URLë§Œ ì¬ì‹œë„'
        required: false
        default: 'false'
        type: boolean

env:
  # Vercel ë°°í¬ URL (í”„ë¡œë•ì…˜)
  API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://facility.blueon-iot.com' }}
  # ë°°ì¹˜ í¬ê¸° (Vercel 60ì´ˆ íƒ€ì„ì•„ì›ƒ ê³ ë ¤ - Playwright ì´ˆê¸°í™” 20-30ì´ˆ + í¬ë¡¤ë§ ì‹œê°„)
  BATCH_SIZE: 1

jobs:
  # ============================================================
  # Job 1: í¬ë¡¤ë§ ì¤€ë¹„ ë° ìƒíƒœ í™•ì¸
  # ============================================================
  prepare:
    name: ì¤€ë¹„ ë° ìƒíƒœ í™•ì¸
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      total_urls: ${{ steps.check.outputs.total_urls }}
      total_batches: ${{ steps.check.outputs.total_batches }}
      run_id: ${{ steps.create_run.outputs.run_id }}

    steps:
      - name: ğŸ• í˜„ì¬ ì‹œê°„ í‘œì‹œ
        run: |
          echo "â° ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸ“ í¬ë¡¤ë§ ì‹¤í–‰ ê¸°ë¡ ìƒì„±
        id: create_run
        run: |
          RUN_ID="run_$(date -u +%Y-%m-%d_%H:%M)"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "ğŸ†” Run ID: $RUN_ID"

          # í¬ë¡¤ë§ ì‹¤í–‰ ê¸°ë¡ ìƒì„±
          curl -X POST "${{ env.API_BASE_URL }}/api/subsidy-crawler/runs" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "{
              \"run_id\": \"$RUN_ID\",
              \"trigger_type\": \"${{ github.event_name == 'schedule' && 'scheduled' || 'manual' }}\",
              \"github_run_id\": \"${{ github.run_id }}\",
              \"total_batches\": 0
            }" || echo "âš ï¸ ì‹¤í–‰ ê¸°ë¡ ìƒì„± ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

      - name: ğŸ” í¬ë¡¤ëŸ¬ ìƒíƒœ í™•ì¸
        id: check
        run: |
          echo "ğŸ“¡ ì§ì ‘ URL í¬ë¡¤ëŸ¬ ìƒíƒœ í™•ì¸ ì¤‘..."

          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler/direct?limit=211")

          echo "ğŸ“¥ ì‘ë‹µ: $RESPONSE"

          TOTAL_URLS=$(echo $RESPONSE | jq -r '.total_urls // 0')
          TOTAL_BATCHES=$(( (TOTAL_URLS + ${{ env.BATCH_SIZE }} - 1) / ${{ env.BATCH_SIZE }} ))

          echo "total_urls=$TOTAL_URLS" >> $GITHUB_OUTPUT
          echo "total_batches=$TOTAL_BATCHES" >> $GITHUB_OUTPUT

          echo "âœ… í¬ë¡¤ë§ ëŒ€ìƒ URL: ${TOTAL_URLS}ê°œ"
          echo "ğŸ“¦ ë°°ì¹˜ ìˆ˜: ${TOTAL_BATCHES}ê°œ (ë°°ì¹˜ë‹¹ ${{ env.BATCH_SIZE }}ê°œ)"

          # ì‹¤í–‰ ê¸°ë¡ì— total_batches ì—…ë°ì´íŠ¸
          RUN_ID="${{ steps.create_run.outputs.run_id }}"
          curl -X PATCH "${{ env.API_BASE_URL }}/api/subsidy-crawler/runs/$RUN_ID" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "{
              \"total_batches\": $TOTAL_BATCHES,
              \"total_urls_crawled\": $TOTAL_URLS
            }" || echo "âš ï¸ ë°°ì¹˜ ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"

      - name: ğŸ“Š í†µê³„ ì¡°íšŒ
        run: |
          echo "ğŸ“Š ìµœê·¼ í¬ë¡¤ë§ í†µê³„ ì¡°íšŒ ì¤‘..."
          curl -s "${{ env.API_BASE_URL }}/api/subsidy-crawler/stats" | jq '.'

  # ============================================================
  # Job 2: ë°°ì¹˜ í¬ë¡¤ë§ (Matrix Strategy)
  # ============================================================
  crawl:
    name: ë°°ì¹˜ ${{ matrix.batch }} í¬ë¡¤ë§
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 10

    strategy:
      max-parallel: 1  # ìˆœì°¨ ì‹¤í–‰ (Chromium ë°”ì´ë„ˆë¦¬ ì¶©ëŒ ë°©ì§€)
      fail-fast: false  # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77]

    steps:
      - name: ğŸš€ ë°°ì¹˜ ${{ matrix.batch }} í¬ë¡¤ë§ ì‹œì‘
        id: crawl_batch
        run: |
          echo "ğŸ¤– [ë°°ì¹˜ ${{ matrix.batch }}/77] í¬ë¡¤ë§ ì‹œì‘ (ìµœëŒ€ ${{ env.BATCH_SIZE }}ê°œ URL)"

          # URL ê°€ì ¸ì˜¤ê¸° (offset ê³„ì‚°: (batch - 1) * batch_size)
          OFFSET=$(( (${{ matrix.batch }} - 1) * ${{ env.BATCH_SIZE }} ))

          echo "ğŸ“ Offset: $OFFSET, Limit: ${{ env.BATCH_SIZE }}"

          # API í˜¸ì¶œë¡œ URL ê°€ì ¸ì˜¤ê¸°
          URLS_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler/direct?limit=${{ env.BATCH_SIZE }}")

          URLS=$(echo $URLS_RESPONSE | jq -r '.urls | map(.url) | @json')
          URL_IDS=$(echo $URLS_RESPONSE | jq -r '.urls | map(.id) | @json')
          URL_COUNT=$(echo $URLS_RESPONSE | jq -r '.urls | length')

          echo "ğŸ“¥ ë°°ì¹˜ ${{ matrix.batch }} URL ìˆ˜: ${URL_COUNT}ê°œ"

          # URLì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if [ "$URL_COUNT" -eq 0 ]; then
            echo "âš ï¸ ë°°ì¹˜ ${{ matrix.batch }}ì— í¬ë¡¤ë§í•  URLì´ ì—†ìŠµë‹ˆë‹¤."
            echo "success=true" >> $GITHUB_OUTPUT
            echo "new_count=0" >> $GITHUB_OUTPUT
            echo "relevant_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # í¬ë¡¤ë§ ì‹¤í–‰
          BODY=$(jq -n --argjson urls "$URLS" '{direct_mode: true, urls: $urls}')

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler/direct")

          echo "ğŸ“¥ ë°°ì¹˜ ${{ matrix.batch }} ì‘ë‹µ: $RESPONSE"

          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')
          SUCCESSFUL_URLS=$(echo $RESPONSE | jq -r '.successful_urls // 0')
          FAILED_URLS=$(echo $RESPONSE | jq -r '.failed_urls // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT
          echo "successful_urls=$SUCCESSFUL_URLS" >> $GITHUB_OUTPUT
          echo "failed_urls=$FAILED_URLS" >> $GITHUB_OUTPUT
          echo "url_ids=$URL_IDS" >> $GITHUB_OUTPUT

          echo "âœ… ë°°ì¹˜ ${{ matrix.batch }} ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"
          echo "ğŸ“Š ì„±ê³µ: ${SUCCESSFUL_URLS}ê°œ URL, ì‹¤íŒ¨: ${FAILED_URLS}ê°œ URL"

      - name: ğŸ“ ë°°ì¹˜ ${{ matrix.batch }} ê²°ê³¼ ë¡œê¹…
        if: always()
        run: |
          RUN_ID="${{ needs.prepare.outputs.run_id }}"
          echo "ğŸ“ ë°°ì¹˜ ê²°ê³¼ ë¡œê¹…: $RUN_ID / ë°°ì¹˜ ${{ matrix.batch }}"

          # ë°°ì¹˜ ê²°ê³¼ ê³„ì‚°
          SUCCESSFUL="${{ steps.crawl_batch.outputs.successful_urls || 0 }}"
          FAILED="${{ steps.crawl_batch.outputs.failed_urls || 0 }}"
          URLS_IN_BATCH=$((SUCCESSFUL + FAILED))

          # URL IDs ê°€ì ¸ì˜¤ê¸° (í¬ë¡¤ë§ ë‹¨ê³„ì—ì„œ outputëœ ê°’)
          URL_IDS='${{ steps.crawl_batch.outputs.url_ids }}'

          echo "ğŸ“Š ë°°ì¹˜ ${{ matrix.batch }}: ì„±ê³µ=$SUCCESSFUL, ì‹¤íŒ¨=$FAILED, ì´=$URLS_IN_BATCH"
          echo "ğŸ“‹ ë°°ì¹˜ ${{ matrix.batch }} URL IDs: $URL_IDS"

          # jqë¡œ ì•ˆì „í•œ JSON ìƒì„±
          REQUEST_BODY=$(jq -n \
            --arg run_id "$RUN_ID" \
            --argjson batch_number "${{ matrix.batch }}" \
            --argjson url_ids "$URL_IDS" \
            --argjson urls_in_batch "$URLS_IN_BATCH" \
            --arg completed_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --argjson successful_urls "$SUCCESSFUL" \
            --argjson failed_urls "$FAILED" \
            --argjson total_announcements "${{ steps.crawl_batch.outputs.new_count || 0 }}" \
            --argjson new_announcements "${{ steps.crawl_batch.outputs.new_count || 0 }}" \
            --argjson relevant_announcements "${{ steps.crawl_batch.outputs.relevant_count || 0 }}" \
            --arg status "${{ steps.crawl_batch.outputs.success == 'true' && 'completed' || 'failed' }}" \
            '{
              run_id: $run_id,
              batch_number: $batch_number,
              url_ids: $url_ids,
              urls_in_batch: $urls_in_batch,
              completed_at: $completed_at,
              successful_urls: $successful_urls,
              failed_urls: $failed_urls,
              total_announcements: $total_announcements,
              new_announcements: $new_announcements,
              relevant_announcements: $relevant_announcements,
              status: $status
            }')

          # ë°°ì¹˜ ê²°ê³¼ ë¡œê¹…
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ env.API_BASE_URL }}/api/subsidy-crawler/batches" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$REQUEST_BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "ğŸ“¥ ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ğŸ“¥ ì‘ë‹µ ë³¸ë¬¸: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ë°°ì¹˜ ê²°ê³¼ ë¡œê¹… ì‹¤íŒ¨! (HTTP $HTTP_CODE)"
            echo "âš ï¸ ê³„ì† ì§„í–‰í•˜ì§€ë§Œ ì´ ë°°ì¹˜ ê²°ê³¼ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŒ"
          else
            echo "âœ… ë°°ì¹˜ ${{ matrix.batch }} ê²°ê³¼ ì €ì¥ ì™„ë£Œ"
          fi

      - name: âš ï¸ ë°°ì¹˜ ${{ matrix.batch }} ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
        if: steps.crawl_batch.outputs.success != 'true'
        id: retry_batch
        run: |
          echo "ğŸ”„ ë°°ì¹˜ ${{ matrix.batch }} ì¬ì‹œë„ ì¤‘..."
          sleep 10  # 10ì´ˆ ëŒ€ê¸°

          # ì¬ì‹œë„ API í˜¸ì¶œ (retry_failed=true)
          BODY='{"direct_mode": true, "retry_failed": true, "batch_size": ${{ env.BATCH_SIZE }}}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler/direct")

          echo "ğŸ“¥ ì¬ì‹œë„ ì‘ë‹µ: $RESPONSE"

          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… ë°°ì¹˜ ${{ matrix.batch }} ì¬ì‹œë„ ì„±ê³µ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"
          else
            echo "âŒ ë°°ì¹˜ ${{ matrix.batch }} ì¬ì‹œë„ ì‹¤íŒ¨"
          fi

      - name: ğŸ“ ë°°ì¹˜ ê²°ê³¼ ë¡œê·¸
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“‹ ë°°ì¹˜ ${{ matrix.batch }} ê²°ê³¼"
          echo "=================================="
          echo "âœ… ì„±ê³µ ì—¬ë¶€: ${{ steps.crawl_batch.outputs.success || steps.retry_batch.outputs.success }}"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : ${{ steps.crawl_batch.outputs.new_count || steps.retry_batch.outputs.new_count }}ê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : ${{ steps.crawl_batch.outputs.relevant_count || steps.retry_batch.outputs.relevant_count }}ê±´"
          echo "âœ… ì„±ê³µ URL: ${{ steps.crawl_batch.outputs.successful_urls || 0 }}ê°œ"
          echo "âŒ ì‹¤íŒ¨ URL: ${{ steps.crawl_batch.outputs.failed_urls || 0 }}ê°œ"
          echo "=================================="

  # ============================================================
  # Job 3: ê²°ê³¼ ì§‘ê³„ ë° ì•Œë¦¼
  # ============================================================
  summary:
    name: ê²°ê³¼ ì§‘ê³„ ë° ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [prepare, crawl]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š ìµœì¢… í†µê³„ ì¡°íšŒ
        id: stats
        run: |
          echo "ğŸ“Š ìµœì¢… í¬ë¡¤ë§ í†µê³„ ì¡°íšŒ ì¤‘..."

          STATS_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler/stats?details=true&problems=true")

          echo "ğŸ“¥ í†µê³„ ì‘ë‹µ:"
          echo "$STATS_RESPONSE" | jq '.'

          # Direct í¬ë¡¤ë§ í†µê³„ ì¶”ì¶œ
          DIRECT_STATS=$(echo $STATS_RESPONSE | jq -r '.stats.direct_crawl_stats // {}')

          TOTAL_NEW=$(echo $DIRECT_STATS | jq -r '.total_new_announcements // 0')
          TOTAL_RELEVANT=$(echo $DIRECT_STATS | jq -r '.total_relevant_announcements // 0')
          TOTAL_RUNS=$(echo $DIRECT_STATS | jq -r '.total_runs // 0')
          SUCCESS_RATE=$(echo $DIRECT_STATS | jq -r '.avg_success_rate // 0')

          echo "total_new=$TOTAL_NEW" >> $GITHUB_OUTPUT
          echo "total_relevant=$TOTAL_RELEVANT" >> $GITHUB_OUTPUT
          echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT

          echo "âœ… ì „ì²´ ì§ì ‘ URL í¬ë¡¤ë§ í†µê³„:"
          echo "ğŸ“Š ì´ ì‹ ê·œ ê³µê³ : ${TOTAL_NEW}ê±´"
          echo "ğŸ¯ ì´ ê´€ë ¨ ê³µê³ : ${TOTAL_RELEVANT}ê±´"
          echo "ğŸ“ˆ ì„±ê³µë¥ : ${SUCCESS_RATE}%"

      - name: ğŸ“ í¬ë¡¤ë§ ì‹¤í–‰ ì™„ë£Œ ì—…ë°ì´íŠ¸
        if: always()
        run: |
          RUN_ID="${{ needs.prepare.outputs.run_id }}"
          echo "ğŸ“ í¬ë¡¤ë§ ì‹¤í–‰ ì™„ë£Œ ì—…ë°ì´íŠ¸: $RUN_ID"

          # ì‹¤í–‰ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
          curl -X PATCH "${{ env.API_BASE_URL }}/api/subsidy-crawler/runs/$RUN_ID" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "{
              \"completed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
              \"status\": \"completed\",
              \"total_announcements\": ${{ steps.stats.outputs.total_new || 0 }},
              \"new_announcements\": ${{ steps.stats.outputs.total_new || 0 }},
              \"relevant_announcements\": ${{ steps.stats.outputs.total_relevant || 0 }},
              \"completed_batches\": ${{ needs.prepare.outputs.total_batches }}
            }" || echo "âš ï¸ ì‹¤í–‰ ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"

      - name: ğŸ“¬ ì•Œë¦¼ ë°œì†¡ (ê´€ë ¨ ê³µê³  ë°œê²¬ ì‹œ)
        if: steps.stats.outputs.total_relevant > 0
        run: |
          echo "ğŸ”” ìƒˆë¡œìš´ ê´€ë ¨ ê³µê³  ë°œê²¬!"
          echo "ğŸ“Š ê´€ë ¨ ê³µê³  ìˆ˜: ${{ steps.stats.outputs.total_relevant }}ê±´"

          # Slack ì›¹í›… (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸš¨ *ì§ì ‘ URL ë³´ì¡°ê¸ˆ ê³µê³  ì•Œë¦¼*\nìƒˆë¡œìš´ IoT ì§€ì›ì‚¬ì—… ê´€ë ¨ ê³µê³  ${{ steps.stats.outputs.total_relevant }}ê±´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ“¦ ë°°ì¹˜ í¬ë¡¤ë§: 22ê°œ ë°°ì¹˜ ì™„ë£Œ\nğŸ“ˆ ì„±ê³µë¥ : ${{ steps.stats.outputs.success_rate }}%\nğŸ‘‰ í™•ì¸í•˜ê¸°: ${{ env.API_BASE_URL }}/admin/subsidy\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

      - name: ğŸ“‹ ì‹¤í–‰ ìš”ì•½
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“‹ ì§ì ‘ URL í¬ë¡¤ë§ ì‹¤í–‰ ìš”ì•½"
          echo "=================================="
          echo "â° ì™„ë£Œ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ“¦ í¬ë¡¤ë§ ëŒ€ìƒ: ${{ needs.prepare.outputs.total_urls }}ê°œ URL"
          echo "ğŸ“Š ë°°ì¹˜ ìˆ˜: ${{ needs.prepare.outputs.total_batches }}ê°œ"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : ${{ steps.stats.outputs.total_new }}ê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : ${{ steps.stats.outputs.total_relevant }}ê±´"
          echo "ğŸ“ˆ ì„±ê³µë¥ : ${{ steps.stats.outputs.success_rate }}%"
          echo "=================================="

      - name: âš ï¸ ë¬¸ì œ URL ì•Œë¦¼
        run: |
          echo "âš ï¸ ë¬¸ì œ URL í™•ì¸ ì¤‘..."

          PROBLEM_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler/stats?problems=true")

          PROBLEM_URLS=$(echo $PROBLEM_RESPONSE | jq -r '.stats.problem_urls // []')
          PROBLEM_COUNT=$(echo $PROBLEM_URLS | jq 'length')

          echo "âš ï¸ ë¬¸ì œ URL ìˆ˜: ${PROBLEM_COUNT}ê°œ"

          if [ "$PROBLEM_COUNT" -gt 0 ]; then
            echo "ğŸ“‹ ë¬¸ì œ URL ëª©ë¡:"
            echo "$PROBLEM_URLS" | jq -r '.[] | "- [\(.severity)] \(.url) (ì—°ì† ì‹¤íŒ¨: \(.consecutive_failures)íšŒ)"'

            # Slack ì•Œë¦¼ (ë¬¸ì œ URLì´ 10ê°œ ì´ìƒì¼ ë•Œ)
            if [ "$PROBLEM_COUNT" -ge 10 ] && [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
              curl -X POST -H 'Content-type: application/json' \
                --data "{\"text\":\"âš ï¸ *ì§ì ‘ URL í¬ë¡¤ë§ ë¬¸ì œ ì•Œë¦¼*\në¬¸ì œê°€ ìˆëŠ” URLì´ ${PROBLEM_COUNT}ê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ í™•ì¸ ë° ì¡°ì¹˜ í•„ìš”: ${{ env.API_BASE_URL }}/admin/subsidy\"}" \
                ${{ secrets.SLACK_WEBHOOK_URL }}
            fi
          else
            echo "âœ… ëª¨ë“  URL ì •ìƒ ì‘ë™"
          fi
