# í™˜ê²½ ê¸°ê´€ ë³´ì¡°ê¸ˆ ê³µê³  í¬ë¡¤ëŸ¬ (Phase 2)
# ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST) ì‹¤í–‰ - 31ê°œ í™˜ê²½ì„¼í„° í¬ë¡¤ë§
# ë°°ì¹˜ ì²˜ë¦¬ ë°©ì‹: 4ê°œ ë°°ì¹˜ë¡œ ë¶„í• í•˜ì—¬ Vercel íƒ€ì„ì•„ì›ƒ ë°©ì§€

name: Subsidy Crawler - Phase 2 (Environmental Agencies)

on:
  # ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ - KSTëŠ” +9ì‹œê°„)
  schedule:
    - cron: '0 1 * * *'   # ë§¤ì¼ 01:00 UTC = 10:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force:
        description: 'ì´ë¯¸ ìˆ˜ì§‘ëœ ê³µê³ ë„ ë‹¤ì‹œ ì²˜ë¦¬'
        required: false
        default: 'false'
        type: boolean

env:
  # Vercel ë°°í¬ URL (í”„ë¡œë•ì…˜)
  API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://facility.blueon-iot.com' }}

jobs:
  # ============================================================
  # ë°°ì¹˜ ì²˜ë¦¬: 31ê°œ í™˜ê²½ì„¼í„°ë¥¼ 4ê°œ ë°°ì¹˜ë¡œ ë¶„í• 
  # - Batch 1~3: ê° 8ê°œ ì„¼í„°
  # - Batch 4: 7ê°œ ì„¼í„°
  # ============================================================
  crawl_phase2_batch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        batch: [1, 2, 3, 4]  # 31ê°œ ì„¼í„°ë¥¼ 4ê°œ ë°°ì¹˜ë¡œ ë¶„í• 
      fail-fast: false       # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ê³„ì† ì‹¤í–‰
      max-parallel: 4        # ëª¨ë“  ë°°ì¹˜ ë™ì‹œ ì‹¤í–‰

    steps:
      - name: ğŸ• í˜„ì¬ ì‹œê°„ í‘œì‹œ
        run: |
          echo "â° ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ“¦ ë°°ì¹˜ ë²ˆí˜¸: ${{ matrix.batch }}/4"

      - name: ğŸŒ¿ Phase 2 ë°°ì¹˜ í¬ë¡¤ë§ (ë°°ì¹˜ ${{ matrix.batch }})
        id: crawl_batch
        run: |
          echo "ğŸ¤– Phase 2 ë°°ì¹˜ ${{ matrix.batch }} í¬ë¡¤ë§ ì‹œì‘"

          FORCE="${{ github.event.inputs.force || 'false' }}"
          BATCH_NUM=${{ matrix.batch }}
          BATCH_SIZE=8

          BODY="{\"enable_phase2\": true, \"force\": $FORCE, \"batch_num\": $BATCH_NUM, \"batch_size\": $BATCH_SIZE}"

          # HTTP ìƒíƒœ ì½”ë“œì™€ ì‘ë‹µ ë³¸ë¬¸ í•¨ê»˜ ë°›ê¸°
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

          echo "ğŸ“¥ ë°°ì¹˜ ${{ matrix.batch }} ì‘ë‹µ (HTTP $HTTP_CODE): $RESPONSE_BODY"

          # HTTP ì˜¤ë¥˜ ì²˜ë¦¬
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ API ì˜¤ë¥˜ ë°œìƒ (HTTP $HTTP_CODE)"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "new_count=0" >> $GITHUB_OUTPUT
            echo "relevant_count=0" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            exit 0  # ì›Œí¬í”Œë¡œìš°ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ë‹¤ë¥¸ ë°°ì¹˜ ê³„ì† ì‹¤í–‰)
          fi

          # JSON ìœ íš¨ì„± ê²€ì‚¬
          if ! echo "$RESPONSE_BODY" | jq empty 2>/dev/null; then
            echo "âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨: $RESPONSE_BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "new_count=0" >> $GITHUB_OUTPUT
            echo "relevant_count=0" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ì •ìƒ ì‘ë‹µ ì²˜ë¦¬
          SUCCESS=$(echo "$RESPONSE_BODY" | jq -r '.success // false')
          NEW_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.relevant_announcements // 0')
          DURATION=$(echo "$RESPONSE_BODY" | jq -r '.duration_ms // 0')
          BATCH_INFO=$(echo "$RESPONSE_BODY" | jq -r '.batch_info // "ì •ë³´ ì—†ìŒ"')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

          echo "âœ… ë°°ì¹˜ ${{ matrix.batch }} ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´ (ì‹¤í–‰ì‹œê°„: ${DURATION}ms)"
          echo "ğŸ“Š ë°°ì¹˜ ì •ë³´: $BATCH_INFO"

      - name: ğŸ“‹ ë°°ì¹˜ ì‹¤í–‰ ìš”ì•½
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“‹ ë°°ì¹˜ ${{ matrix.batch }} ì‹¤í–‰ ìš”ì•½"
          echo "=================================="
          echo "â° ì™„ë£Œ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          echo "âœ… ì„±ê³µ ì—¬ë¶€: ${{ steps.crawl_batch.outputs.success }}"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : ${{ steps.crawl_batch.outputs.new_count }}ê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : ${{ steps.crawl_batch.outputs.relevant_count }}ê±´"
          echo "â±ï¸  ì‹¤í–‰ ì‹œê°„: ${{ steps.crawl_batch.outputs.duration }}ms"
          echo "=================================="
