# í™˜ê²½ ê¸°ê´€ ë³´ì¡°ê¸ˆ ê³µê³  í¬ë¡¤ëŸ¬ (Phase 2)
# ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST) ì‹¤í–‰ - 31ê°œ í™˜ê²½ì„¼í„° í¬ë¡¤ë§

name: Subsidy Crawler - Phase 2 (Environmental Agencies)

on:
  # ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ - KSTëŠ” +9ì‹œê°„)
  schedule:
    - cron: '0 1 * * *'   # ë§¤ì¼ 01:00 UTC = 10:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force:
        description: 'ì´ë¯¸ ìˆ˜ì§‘ëœ ê³µê³ ë„ ë‹¤ì‹œ ì²˜ë¦¬'
        required: false
        default: 'false'
        type: boolean

env:
  # Vercel ë°°í¬ URL (í”„ë¡œë•ì…˜)
  API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://facility.blueon-iot.com' }}

jobs:
  crawl_phase2:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ• í˜„ì¬ ì‹œê°„ í‘œì‹œ
        run: |
          echo "â° ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸŒ¿ Phase 2 í¬ë¡¤ë§ ì‹œì‘ (í™˜ê²½ê¸°ê´€ 31ê°œ)
        id: crawl_phase2
        run: |
          echo "ğŸ¤– Phase 2 í¬ë¡¤ë§ ì‹œì‘: 31ê°œ í™˜ê²½ì„¼í„°"
          echo "ğŸ“ ê²½ê¸°í™˜ê²½ì—ë„ˆì§€ì§„í¥ì›, ì „êµ­ ë…¹ìƒ‰í™˜ê²½ì§€ì›ì„¼í„° ë“±"

          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"enable_phase2": true, "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ Phase 2 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')
          DURATION=$(echo $RESPONSE | jq -r '.duration_ms // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

          echo "âœ… Phase 2 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´ (ì‹¤í–‰ì‹œê°„: ${DURATION}ms)"

      - name: ğŸ“¬ ì•Œë¦¼ ë°œì†¡ (ê´€ë ¨ ê³µê³  ë°œê²¬ ì‹œ)
        if: steps.crawl_phase2.outputs.relevant_count > 0
        run: |
          echo "ğŸ”” ìƒˆë¡œìš´ ê´€ë ¨ ê³µê³  ë°œê²¬!"
          echo "ğŸ“Š ê´€ë ¨ ê³µê³  ìˆ˜: ${{ steps.crawl_phase2.outputs.relevant_count }}ê±´"

          # Slack ì›¹í›… (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸŒ¿ *í™˜ê²½ê¸°ê´€ ë³´ì¡°ê¸ˆ ê³µê³  ì•Œë¦¼ (Phase 2)*\nìƒˆë¡œìš´ IoT ì§€ì›ì‚¬ì—… ê´€ë ¨ ê³µê³  ${{ steps.crawl_phase2.outputs.relevant_count }}ê±´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ í™•ì¸í•˜ê¸°: ${{ env.API_BASE_URL }}/admin/subsidy\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

      - name: ğŸ“‹ ì‹¤í–‰ ìš”ì•½
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“‹ Phase 2 í¬ë¡¤ë§ ì‹¤í–‰ ìš”ì•½"
          echo "=================================="
          echo "â° ì™„ë£Œ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          echo "âœ… ì„±ê³µ ì—¬ë¶€: ${{ steps.crawl_phase2.outputs.success }}"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : ${{ steps.crawl_phase2.outputs.new_count }}ê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : ${{ steps.crawl_phase2.outputs.relevant_count }}ê±´"
          echo "â±ï¸  ì‹¤í–‰ ì‹œê°„: ${{ steps.crawl_phase2.outputs.duration }}ms"
          echo "=================================="
