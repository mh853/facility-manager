# 착공신고서 템플릿 방식 구현 가이드

## 완료된 작업

### 1. 패키지 설치
- `docxtemplater`: Word 템플릿 엔진
- `pizzip`: .docx 파일 읽기/쓰기

### 2. API 라우트 수정
**파일**: `/app/api/construction-reports/download/route.ts`

기존 programmatic 방식(docx 라이브러리)에서 template 방식(docxtemplater)으로 완전히 전환했습니다.

**주요 변경사항**:
- 템플릿 파일 경로: `/양식/☆착공신고서 템플릿.docx`
- 모든 데이터를 플레이스홀더로 매핑
- 자동으로 천단위 콤마 및 날짜 포맷팅 적용

### 3. 플레이스홀더 가이드 문서 생성
**파일**: `/claudedocs/construction-report-placeholders.md`

모든 사용 가능한 플레이스홀더와 예시를 포함한 완전한 가이드입니다.

## Word 템플릿 작성 방법

### 기본 구조

```
사물인터넷(IoT) 측정기기 부착지원 사업
착 공 신 고 서

┌─────────────┬──────────────────────────────────┐
│ 사 업 장 명 │ {{business_name}}                │
├─────────────┼──────────────────────────────────┤
│사업장소재지 │ {{address}}                      │
│             │ 전화: {{business_contact}}       │
│             │ 팩스: {{fax_number}}             │
└─────────────┴──────────────────────────────────┘
```

### 플레이스홀더 사용법

1. **기본 데이터 삽입**
   ```
   {{business_name}}           → 사업장명
   {{address}}                 → 주소
   {{government_notice_price}} → 5,000,000 (자동 콤마 포맷팅)
   ```

2. **날짜 데이터**
   ```
   {{report_year}} 년 {{report_month}} 월 {{report_day}} 일
   → 2024 년 11 월 25 일

   {{subsidy_approval_date}} 부터 {{attachment_end_date}} 까지
   → 2024.11.01 부터 2025.02.01 까지
   ```

3. **대표자 성명 (공백 포함)**
   ```
   신청인(대표자) {{business_name}} {{representative_name_spaced}} (인감도장)
   → 신청인(대표자) 스타일웍스 김 유 정 (인감도장)
   ```

4. **방지시설 목록 (반복)**
   ```
   {#prevention_facilities}
     - {{facility_name}} ({{capacity}}) × {{quantity}}대
   {/prevention_facilities}

   결과:
   - 습식집진기 (10CMM) × 1대
   - 활성탄흡착탑 (5CMM) × 2대
   ```

### 고정 데이터 (블루온 정보)

템플릿에 직접 입력:
- 설치업체명: 주식회사 블루온
- 주소: 경상북도 고령군 대가야읍 낫질로 285
- 전화: 1661-5543
- 팩스: 031-8077-2054
- 사업자등록번호: 679-86-02827
- 대표자: 김 경 수
- 계좌: 기업은행 336-101191-04-015

## 템플릿 파일 작성 단계

### 1단계: 기본 레이아웃 작성
1. Word에서 새 문서 생성
2. 표와 텍스트로 원하는 레이아웃 구성
3. 폰트, 크기, 여백 등 스타일 설정

### 2단계: 플레이스홀더 삽입
1. 데이터가 들어갈 위치에 `{{placeholder_name}}` 입력
2. 정확히 중괄호 2개씩 사용 (`{{` 와 `}}`)
3. 플레이스홀더 이름은 소문자 권장

### 3단계: 표 디자인
- 테두리 스타일 설정
- 셀 병합/분할
- 배경색 (회색 헤더: RGB 240,240,240)
- 셀 정렬 (왼쪽, 가운데, 오른쪽)

### 4단계: 저장
- 파일명: `☆착공신고서 템플릿.docx`
- 위치: `/Users/mh.c/claude/facility-manager/양식/`
- 형식: Word 문서 (.docx)

## 템플릿 예시 구조

### 페이지 1: 착공신고서

```
═════════════════════════════════════════════════
      사물인터넷(IoT) 측정기기 부착지원 사업
             착 공 신 고 서
═════════════════════════════════════════════════

┌─────────────┬──────────────────────────────────┐
│ 사 업 장 명 │ {{business_name}}                │
├─────────────┼──────────────────┬───────────────┤
│사업장소재지 │ {{address}}      │전화: {{business_contact}}│
│             │                  │팩스: {{fax_number}}│
├─────────────┼──────────────────┴───────────────┤
│ 설치업체명  │ 주식회사 블루온                   │
├─────────────┼──────────────────┬───────────────┤
│시공업체소재지│경상북도 고령군...│전화: 1661-5543 │
│             │                  │팩스: 031-8077..│
├─────────────┼──────────────────────────────────┤
│ 부 착 기 간 │ {{attachment_start_date}} 부터   │
│             │ {{attachment_end_date}} 까지      │
├─────────────┼──────────────────────────────────┤
│ 총 소요금액 │ {{government_notice_price}} 원   │
├─────────────┼──────────────────────────────────┤
│보조금승인액 │ {{subsidy_amount}} 원            │
├─────────────┼──────────────────────────────────┤
│ 자체부담액  │ {{self_payment}} 원              │
└─────────────┴──────────────────────────────────┘

소규모 사업장 사물인터넷(IoT) 측정기기 부착지원 사업에
대하여 착공신고서를 제출합니다.

              {{report_year}} 년 {{report_month}} 월 {{report_day}} 일

신청인(대표자) {{business_name}} {{representative_name_spaced}} (인감도장)

{{local_government_head}} 귀하

┌─────────────┬──────────────────────────────────┐
│  구비서류   │ 1. 대기배출시설 설치 허가(신고)증 │
│             │    사본 1부.                      │
│             │ 2. 계약서(사본) 1부.              │
│             │ 3. 자부담금 입금 확인증 1부.      │
│             │ 4. 계약이행보증보험 1부.          │
│             │ 5. 개선계획서(최종, 보완사항 포함)│
│             │    1부.                           │
└─────────────┴──────────────────────────────────┘
```

## 테스트 방법

### 1. 템플릿 파일 확인
```bash
ls -la "/Users/mh.c/claude/facility-manager/양식/"
```

### 2. 다운로드 테스트
1. 관리자 페이지에서 착공신고서 목록 조회
2. 다운로드 버튼 클릭
3. 생성된 DOCX 파일 열기
4. 모든 플레이스홀더가 데이터로 대체되었는지 확인

### 3. 오류 발생 시
- 브라우저 개발자 도구 콘솔 확인
- 서버 로그 확인: `[CONSTRUCTION-REPORTS-DOWNLOAD]`
- 템플릿 파일 경로 확인
- 플레이스홀더 철자 확인 (`{{name}}` 형식)

## 추가 개발 필요 사항

현재는 **1페이지 (착공신고서)만** 템플릿 방식으로 구현되었습니다.

### 나머지 페이지 템플릿 작성 필요

**Page 2: 계약서 (지자체 제출용)**
- 템플릿 파일: `☆계약서_지자체.docx`
- ContractGovernmentTemplate.tsx 참고

**Page 3: 계약서 (사업장 보관용)**
- 템플릿 파일: `☆계약서_사업장.docx`
- ContractBusinessTemplate.tsx 참고
- 추가 필드: `additional_cost`, `negotiation_cost`

**Page 4: 개선계획서**
- 템플릿 파일: `☆개선계획서.docx`
- ImprovementPlanTemplate.tsx 참고

### 템플릿 통합 방법

옵션 A: 단일 템플릿 (권장)
- 4페이지를 하나의 템플릿 파일에 모두 포함
- 페이지 구분자 사용

옵션 B: 개별 템플릿
- 각 페이지별로 별도 템플릿 파일
- API에서 4개 파일을 읽어서 하나로 병합

## 장점

### 사용자 관점
✅ Word에서 직접 레이아웃 편집 가능
✅ 개발자 없이도 디자인 수정 가능
✅ 표, 폰트, 색상 등 자유롭게 설정
✅ 실제 인쇄 결과와 동일한 미리보기

### 개발자 관점
✅ 코드 양 대폭 감소 (1000+ 줄 → 200 줄)
✅ 유지보수 간편
✅ 레이아웃 변경 시 코드 수정 불필요
✅ 재사용 가능한 템플릿 시스템

## 다음 단계

1. ☆착공신고서 템플릿.docx 파일을 Word로 작성
2. `/claudedocs/construction-report-placeholders.md` 참고하여 플레이스홀더 삽입
3. 다운로드 테스트
4. 필요시 나머지 3개 페이지도 템플릿으로 전환

## 문의사항

템플릿 작성 중 궁금한 점이나 플레이스홀더 추가 필요 시 말씀해주세요!
