# 영업비용 조정 기능 구현 완료

## 📅 구현일: 2025-11-10

## 🎯 구현 내용

영업비용을 사업장별로 수동 조정할 수 있는 기능을 추가했습니다. 매출 상세 모달에서 통계카드 형식의 조정 입력 UI를 제공하며, DB에 저장되어 데이터 신뢰성을 보장합니다.

---

## 📁 변경된 파일

### 1. 데이터베이스 스키마
- **파일**: `sql/operating_cost_adjustments.sql` (신규)
- **내용**: `operating_cost_adjustments` 테이블 생성, 인덱스, RLS 정책, 트리거

### 2. 타입 정의
- **파일**: `types/index.ts`
- **추가된 인터페이스**:
  - `OperatingCostAdjustment`: 영업비용 조정 데이터 타입
  - `EquipmentBreakdownItem`: 기기별 상세 내역 타입
  - `CalculatedData`: 매출 계산 결과 타입 (조정 정보 포함)

### 3. API 엔드포인트
- **파일**: `app/api/revenue/operating-cost-adjustment/route.ts` (신규)
- **메서드**:
  - `GET`: 조정 값 조회
  - `POST`: 새 조정 값 생성
  - `PUT`: 기존 조정 값 수정
  - `DELETE`: 조정 값 삭제
- **권한**: 조회는 레벨 2+, 생성/수정/삭제는 레벨 3+

### 4. 매출 계산 API
- **파일**: `app/api/revenue/calculate/route.ts`
- **변경사항**:
  - 영업비용 조정 값 조회 로직 추가 (line 504-520)
  - 조정된 영업비용으로 순이익 재계산 (line 525)
  - API 응답에 조정 정보 포함 (line 557-558)
  - DB 저장 시 조정된 값 사용 (line 583)

### 5. UI 컴포넌트
- **파일**: `components/business/BusinessRevenueModal.tsx`
- **추가된 기능**:
  - 영업비용 조정 상태 관리 (line 50-57)
  - 조정 값 로드 useEffect (line 81-91)
  - 저장/삭제 핸들러 (line 93-201)
  - 영업비용 카드 업데이트 - 조정됨 뱃지 표시 (line 513-543)
  - 영업비용 조정 카드 UI (line 545-648)
  - 총 비용 합계 업데이트 (line 676-691)
  - 순이익 계산식에 조정 내역 표시 (line 710-722)

---

## 🗄️ 데이터베이스 스키마

### operating_cost_adjustments 테이블

```sql
CREATE TABLE operating_cost_adjustments (
    id UUID PRIMARY KEY,
    business_id UUID REFERENCES business_info(id) NOT NULL,
    adjustment_amount DECIMAL(10,2) NOT NULL,
    adjustment_reason TEXT,
    adjustment_type VARCHAR(20) CHECK (adjustment_type IN ('add', 'subtract')),
    applied_date DATE NOT NULL DEFAULT CURRENT_DATE,
    created_at TIMESTAMP DEFAULT NOW(),
    created_by UUID REFERENCES employees(id),
    updated_at TIMESTAMP DEFAULT NOW(),
    updated_by UUID REFERENCES employees(id),
    UNIQUE(business_id)
);
```

**주요 제약조건**:
- 사업장당 하나의 조정 값만 허용 (UNIQUE constraint)
- adjustment_type은 'add' 또는 'subtract'만 가능
- RLS 정책: 레벨 2+ 조회, 레벨 3+ 수정

---

## 🔄 데이터 흐름

```
1. 모달 열기
   ↓
2. /api/revenue/calculate 호출 (business_id)
   ↓
3. 영업비용 기본 계산
   ↓
4. operating_cost_adjustments 테이블 조회
   ↓
5. 조정 값이 있으면:
   - adjustment_type = 'add': 기본 영업비용 + 조정금액
   - adjustment_type = 'subtract': 기본 영업비용 - 조정금액
   ↓
6. 조정된 영업비용으로 순이익 재계산
   ↓
7. API 응답에 조정 정보 포함
   ↓
8. UI에 조정된 값 표시
```

---

## 💰 계산 로직

### 기존 순이익 계산
```
순이익 = 매출 - 매입 - 추가설치비 - 영업비용 - 실사비용 - 설치비용
```

### 조정 적용 후
```
조정된 영업비용 = 기본 영업비용 ± 조정금액
순이익 = 매출 - 매입 - 추가설치비 - 조정된 영업비용 - 실사비용 - 설치비용
```

---

## 🎨 UI 구성

### 1. 영업비용 카드 (업데이트됨)
- 조정 적용 시 "조정됨" 뱃지 표시
- 조정된 최종 금액 표시 (크게)
- 기본 금액 + 조정 내역 표시 (작게)

### 2. 영업비용 조정 카드 (신규)
- **읽기 모드**:
  - 현재 조정 값 표시
  - 조정 사유 표시
  - "수정" / "삭제" 버튼 (권한 3+)

- **편집 모드**:
  - 조정 금액 입력 (숫자)
  - 추가/차감 선택 (드롭다운)
  - 조정 사유 입력 (텍스트)
  - "저장" / "취소" 버튼

### 3. 총 비용 합계 카드 (업데이트됨)
- 조정된 영업비용 반영
- 설명 텍스트 업데이트 ("조정된 영업비용" 표시)

### 4. 순이익 계산식 (업데이트됨)
- 조정된 영업비용 표시
- 조정 내역 상세 표시 (기본 값 + 조정 금액)

---

## 🔒 권한 정책

| 작업 | 필요 권한 레벨 | 설명 |
|------|---------------|------|
| 조정 값 조회 | 2 이상 | 매출 조회 권한 |
| 조정 값 생성 | 3 이상 | 영업비용 조정 권한 |
| 조정 값 수정 | 3 이상 | 영업비용 조정 권한 |
| 조정 값 삭제 | 3 이상 | 영업비용 조정 권한 |

---

## 📝 테스트 가이드

### 사전 준비
1. Supabase에서 `operating_cost_adjustments.sql` 실행
2. 테이블 생성 확인
3. 애플리케이션 재시작

### 테스트 시나리오

#### 1. 조정 값 생성
1. 매출관리 페이지에서 사업장 선택
2. 상세 모달 열기
3. "영업비용 조정" 카드에서 "추가" 버튼 클릭
4. 조정 금액 입력 (예: 50000)
5. 추가/차감 선택
6. 조정 사유 입력
7. "저장" 버튼 클릭
8. **예상 결과**:
   - 조정 카드에 입력한 값 표시
   - 영업비용 카드에 "조정됨" 뱃지 표시
   - 영업비용이 조정된 금액으로 변경
   - 순이익이 재계산되어 표시
   - 계산식에 조정 내역 표시

#### 2. 조정 값 수정
1. 조정이 있는 사업장 모달 열기
2. "영업비용 조정" 카드에서 "수정" 버튼 클릭
3. 금액 또는 타입 변경
4. "저장" 버튼 클릭
5. **예상 결과**:
   - 변경된 값으로 UI 업데이트
   - 영업비용 및 순이익 재계산

#### 3. 조정 값 삭제
1. 조정이 있는 사업장 모달 열기
2. "영업비용 조정" 카드에서 "삭제" 버튼 클릭
3. 확인 다이얼로그에서 "확인"
4. **예상 결과**:
   - "조정 없음" 표시
   - "조정됨" 뱃지 제거
   - 기본 영업비용으로 복원
   - 순이익 재계산

#### 4. 권한 체크
- 레벨 0-1 사용자: 조정 내용 보이지 않음
- 레벨 2 사용자: 조정 내용 조회만 가능, 수정/삭제 버튼 없음
- 레벨 3+ 사용자: 모든 기능 사용 가능

#### 5. 모달 재열기
1. 조정 값 저장 후 모달 닫기
2. 모달 다시 열기
3. **예상 결과**: 저장된 조정 값 유지

#### 6. 계산 정확성
- 기본 영업비용: 1,000,000원
- 조정 (추가): +100,000원
- **예상**: 1,100,000원 표시
- 조정 (차감): -50,000원
- **예상**: 950,000원 표시

---

## 🐛 알려진 이슈 및 제한사항

### 제한사항
1. 사업장당 하나의 조정 값만 허용
2. 조정 이력은 별도로 추적되지 않음 (최신 값만 저장)
3. 조정 값은 영업비용에만 적용 (실사비용 등은 별도)

### 주의사항
1. 조정 값은 매출 계산에 실시간 반영되지만, DB에는 별도 저장
2. 권한 레벨 3 미만 사용자에게는 입력 폼이 표시되지 않음
3. 조정 사유는 선택사항이지만, 기록을 위해 입력 권장

---

## 🚀 향후 개선 사항

### 고려사항
1. **조정 이력 추적**: 변경 이력을 별도 테이블에 저장
2. **일괄 조정**: 여러 사업장의 영업비용을 한 번에 조정
3. **조정 승인 프로세스**: 레벨 3이 조정 요청, 레벨 4가 승인
4. **조정 통계**: 조정된 사업장 수, 평균 조정 금액 등 대시보드
5. **엑셀 내보내기**: 조정 내역 포함한 매출 데이터 엑셀 다운로드

---

## 📊 성능 고려사항

### 쿼리 최적화
- `business_id`에 인덱스 적용으로 빠른 조회
- 단일 조회 쿼리로 조정 값 가져오기
- RLS 정책으로 권한 체크 자동화

### UI 최적화
- 조정 값 변경 시 전체 모달 리로드 대신 state 업데이트
- 저장 중 로딩 상태로 중복 요청 방지
- 낙관적 UI 업데이트 고려 가능

---

## 📞 문의

구현 관련 질문이나 버그 발견 시:
1. 콘솔 로그 확인 (`⚙️ [COMMISSION-ADJ]` 태그)
2. 네트워크 탭에서 API 호출 확인
3. Supabase 테이블에서 데이터 확인

---

**구현 완료일**: 2025-11-10
**구현자**: Claude Code
**버전**: 1.0.0
