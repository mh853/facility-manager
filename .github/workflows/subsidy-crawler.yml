# ì§€ìì²´ ë³´ì¡°ê¸ˆ ê³µê³  í¬ë¡¤ëŸ¬ ìŠ¤ì¼€ì¤„ëŸ¬
# ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 2ì‹œ, ì˜¤í›„ 6ì‹œ (KST) ì‹¤í–‰

name: Subsidy Announcement Crawler

on:
  # ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ - KSTëŠ” +9ì‹œê°„)
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ 00:00 UTC = 09:00 KST
    - cron: '0 5 * * *'   # ë§¤ì¼ 05:00 UTC = 14:00 KST
    - cron: '0 9 * * *'   # ë§¤ì¼ 09:00 UTC = 18:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      region_codes:
        description: 'íŠ¹ì • ì§€ìì²´ ì½”ë“œ (ì‰¼í‘œ êµ¬ë¶„, ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''
      force:
        description: 'ì´ë¯¸ ìˆ˜ì§‘ëœ ê³µê³ ë„ ë‹¤ì‹œ ì²˜ë¦¬'
        required: false
        default: 'false'
        type: boolean

env:
  # Vercel ë°°í¬ URL (í”„ë¡œë•ì…˜)
  API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://facility.blueon-iot.com' }}

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ• í˜„ì¬ ì‹œê°„ í‘œì‹œ
        run: |
          echo "â° ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸ” í¬ë¡¤ëŸ¬ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ“¡ í¬ë¡¤ëŸ¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          curl -s "${{ env.API_BASE_URL }}/api/subsidy-crawler" | jq '.'

      - name: ğŸš€ í¬ë¡¤ë§ ì‹¤í–‰
        id: crawl
        run: |
          echo "ğŸ¤– ì§€ìì²´ ê³µê³  í¬ë¡¤ë§ ì‹œì‘..."

          # ì…ë ¥ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
          REGION_CODES="${{ github.event.inputs.region_codes || '' }}"
          FORCE="${{ github.event.inputs.force || 'false' }}"

          # JSON ìš”ì²­ ë³¸ë¬¸ ìƒì„±
          if [ -n "$REGION_CODES" ]; then
            BODY="{\"region_codes\": [\"${REGION_CODES//,/\",\"}\"], \"force\": $FORCE}"
          else
            BODY="{\"force\": $FORCE}"
          fi

          echo "ğŸ“¤ ìš”ì²­ ë³¸ë¬¸: $BODY"

          # í¬ë¡¤ëŸ¬ API í˜¸ì¶œ
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ì‘ë‹µ: $RESPONSE"

          # ê²°ê³¼ íŒŒì‹±
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… í¬ë¡¤ë§ ì™„ë£Œ"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : $NEW_COUNTê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : $RELEVANT_COUNTê±´"

      - name: ğŸ“¬ ì•Œë¦¼ ë°œì†¡ (ê´€ë ¨ ê³µê³  ë°œê²¬ ì‹œ)
        if: steps.crawl.outputs.relevant_count > 0
        run: |
          echo "ğŸ”” ìƒˆë¡œìš´ ê´€ë ¨ ê³µê³  ë°œê²¬!"
          echo "ğŸ“Š ê´€ë ¨ ê³µê³  ìˆ˜: ${{ steps.crawl.outputs.relevant_count }}ê±´"

          # Slack ì›¹í›… (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸš¨ *ì§€ìì²´ ë³´ì¡°ê¸ˆ ê³µê³  ì•Œë¦¼*\nìƒˆë¡œìš´ IoT ì§€ì›ì‚¬ì—… ê´€ë ¨ ê³µê³  ${{ steps.crawl.outputs.relevant_count }}ê±´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ í™•ì¸í•˜ê¸°: ${{ env.API_BASE_URL }}/admin/subsidy\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

      - name: ğŸ“‹ ì‹¤í–‰ ìš”ì•½
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“‹ í¬ë¡¤ë§ ì‹¤í–‰ ìš”ì•½"
          echo "=================================="
          echo "â° ì™„ë£Œ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          echo "âœ… ì„±ê³µ ì—¬ë¶€: ${{ steps.crawl.outputs.success }}"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : ${{ steps.crawl.outputs.new_count }}ê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : ${{ steps.crawl.outputs.relevant_count }}ê±´"
          echo "=================================="
