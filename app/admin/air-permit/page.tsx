// app/admin/air-permit/page.tsx - ÎåÄÍ∏∞ÌïÑÏ¶ù Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ
'use client'

import { useState, useEffect, useRef, useMemo, useCallback } from 'react'
import { BusinessInfo, AirPermitInfo, AirPermitWithOutlets } from '@/lib/database-service'
import AdminLayout from '@/components/ui/AdminLayout'
import StatsCard from '@/components/ui/StatsCard'
import DataTable, { commonActions } from '@/components/ui/DataTable'
import { ConfirmModal } from '@/components/ui/Modal'
import GoogleSheetsImporter from '@/components/ui/GoogleSheetsImporter'
import { 
  Users, 
  FileText, 
  Database, 
  History, 
  RefreshCw, 
  Plus,
  Building2,
  ClipboardList,
  Calendar,
  Trash2,
  Edit,
  Eye,
  Factory,
  Search,
  X,
  Upload
} from 'lucide-react'

// Ïª§Ïä§ÌÖÄ ÎÇ†Ïßú ÏûÖÎ†• Ïª¥Ìè¨ÎÑåÌä∏ (yyyy-mm-dd ÌòïÌÉú, Î∞±Ïä§ÌéòÏù¥Ïä§ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò)
const DateInput = ({ value, onChange, placeholder = "YYYY-MM-DD" }: {
  value: string
  onChange: (value: string) => void
  placeholder?: string
}) => {
  const yearRef = useRef<HTMLInputElement>(null)
  const monthRef = useRef<HTMLInputElement>(null)
  const dayRef = useRef<HTMLInputElement>(null)
  
  const parts = value ? value.split('-') : ['', '', '']
  const [year, month, day] = parts

  const handleYearChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value
    if (val.length <= 4 && /^\d*$/.test(val)) {
      const newValue = `${val}-${month}-${day}`
      onChange(newValue)
      if (val.length === 4) {
        monthRef.current?.focus()
      }
    }
  }

  const handleMonthChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value
    if (val.length <= 2 && /^\d*$/.test(val)) {
      let monthVal = val
      if (val !== '' && val !== '0') {
        const numVal = parseInt(val)
        if (numVal > 12) {
          monthVal = '12'
        } else if (val.length === 2) {
          monthVal = numVal.toString().padStart(2, '0')
        }
      }
      const newValue = `${year}-${monthVal}-${day}`
      onChange(newValue)
      if (monthVal.length === 2) {
        dayRef.current?.focus()
      }
    }
  }

  const handleDayChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value
    if (val.length <= 2 && /^\d*$/.test(val)) {
      const dayVal = val === '' ? '' : Math.min(parseInt(val) || 1, 31).toString().padStart(val.length === 2 ? 2 : 1, '0')
      const newValue = `${year}-${month}-${dayVal}`
      onChange(newValue)
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent, type: 'year' | 'month' | 'day') => {
    if (e.key === 'Backspace') {
      const target = e.target as HTMLInputElement
      if (target.selectionStart === 0 && target.selectionEnd === 0) {
        e.preventDefault()
        if (type === 'month') {
          yearRef.current?.focus()
          yearRef.current?.setSelectionRange(yearRef.current.value.length, yearRef.current.value.length)
        } else if (type === 'day') {
          monthRef.current?.focus()
          monthRef.current?.setSelectionRange(monthRef.current.value.length, monthRef.current.value.length)
        }
      }
    }
  }

  return (
    <div className="flex items-center gap-2">
      <input
        ref={yearRef}
        type="text"
        value={year}
        onChange={handleYearChange}
        onKeyDown={(e) => handleKeyDown(e, 'year')}
        placeholder="YYYY"
        className="w-16 px-2 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-center"
      />
      <span>-</span>
      <input
        ref={monthRef}
        type="text"
        value={month}
        onChange={handleMonthChange}
        onKeyDown={(e) => handleKeyDown(e, 'month')}
        placeholder="MM"
        className="w-12 px-2 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-center"
      />
      <span>-</span>
      <input
        ref={dayRef}
        type="text"
        value={day}
        onChange={handleDayChange}
        onKeyDown={(e) => handleKeyDown(e, 'day')}
        placeholder="DD"
        className="w-12 px-2 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-center"
      />
    </div>
  )
}


export default function AirPermitManagementPage() {
  const [businessesWithPermits, setBusinessesWithPermits] = useState<BusinessInfo[]>([])
  const [allBusinesses, setAllBusinesses] = useState<BusinessInfo[]>([])
  const [searchTerm, setSearchTerm] = useState('')
  const [businessSearchTerm, setBusinessSearchTerm] = useState('')
  const [showBusinessSuggestions, setShowBusinessSuggestions] = useState(false)
  const [selectedBusiness, setSelectedBusiness] = useState<BusinessInfo | null>(null)
  const [airPermits, setAirPermits] = useState<AirPermitInfo[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [editingPermit, setEditingPermit] = useState<AirPermitInfo | null>(null)
  const [formData, setFormData] = useState<Partial<AirPermitInfo>>({})
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false)
  const [permitToDelete, setPermitToDelete] = useState<AirPermitInfo | null>(null)
  const [isImportModalOpen, setIsImportModalOpen] = useState(false)
  const [isImporting, setIsImporting] = useState(false)
  const [importSettings, setImportSettings] = useState({
    spreadsheetId: '1XXumtd7tl8w17FUgbJj5XzW1Mi04Rq4vlH9OYGNmM3U',
    sheetName: 'ÎåÄÍ∏∞ÌïÑÏ¶ù DB',
    startRow: 3
  })
  
  // Stats calculation for air permits
  const stats = useMemo(() => {
    const total = airPermits.length
    const withOutlets = airPermits.filter(p => p.additional_info?.outlets?.length > 0).length
    const withPollutants = airPermits.filter(p => p.additional_info?.pollutants?.length > 0).length
    const recentlyAdded = airPermits.filter(p => {
      const createdDate = new Date(p.created_at)
      const thirtyDaysAgo = new Date()
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
      return createdDate >= thirtyDaysAgo
    }).length
    
    return {
      total,
      withOutlets,
      withPollutants,
      recentlyAdded
    }
  }, [airPermits])

  // ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ Îì±Î°ùÎêú ÏÇ¨ÏóÖÏû•Îßå ÌïÑÌÑ∞ÎßÅ (ÏÑ†ÌÉù Î¶¨Ïä§Ìä∏Ïö©)
  const filteredBusinessesWithPermits = useMemo(() => {
    if (!searchTerm.trim()) return businessesWithPermits
    const searchLower = searchTerm.toLowerCase()
    return businessesWithPermits.filter(business =>
      business.business_name.toLowerCase().includes(searchLower) ||
      business.local_government?.toLowerCase().includes(searchLower) ||
      business.manager_name?.toLowerCase().includes(searchLower) ||
      business.manager_contact?.toLowerCase().includes(searchLower) ||
      business.address?.toLowerCase().includes(searchLower)
    )
  }, [searchTerm, businessesWithPermits])
  
  // Ï†ÑÏ≤¥ ÏÇ¨ÏóÖÏû• Î™©Î°ù Í≤ÄÏÉâ (ÏÉà ÎåÄÍ∏∞ÌïÑÏ¶ù Ï∂îÍ∞ÄÏö©)
  const filteredAllBusinesses = useMemo(() => {
    if (!businessSearchTerm.trim()) return []
    const searchLower = businessSearchTerm.toLowerCase()
    return allBusinesses.filter(business =>
      business.business_name.toLowerCase().includes(searchLower) ||
      business.local_government?.toLowerCase().includes(searchLower) ||
      business.manager_name?.toLowerCase().includes(searchLower)
    ).slice(0, 10) // ÏµúÎåÄ 10Í∞úÎßå ÌëúÏãú
  }, [businessSearchTerm, allBusinesses])


  // ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ ÏûàÎäî ÏÇ¨ÏóÖÏû•Îßå Î°úÎìúÌïòÎäî ÏµúÏ†ÅÌôîÎêú Ìï®Ïàò
  const loadBusinessesWithPermitsOptimized = useCallback(async () => {
    try {
      setIsLoading(true)
      
      // Î™®Îì† ÌôúÏÑ± ÎåÄÍ∏∞ÌïÑÏ¶ù Ï°∞Ìöå
      const response = await fetch('/api/air-permit-management')
      const result = await response.json()
      
      if (response.ok && result.data) {
        // ÎåÄÍ∏∞ÌïÑÏ¶ùÏóêÏÑú Í≥†Ïú†Ìïú ÏÇ¨ÏóÖÏû• ID Ï∂îÏ∂ú
        const uniqueBusinessIds = [...new Set(result.data.map((permit: AirPermitInfo) => permit.business_id))]
        
        // Ìï¥Îãπ ÏÇ¨ÏóÖÏû•Îì§Ïùò Ï†ïÎ≥¥ Ï°∞Ìöå
        const businessResponse = await fetch('/api/business-management')
        const businessResult = await businessResponse.json()
        
        if (businessResponse.ok) {
          setAllBusinesses(businessResult.data)
          
          // ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ ÏûàÎäî ÏÇ¨ÏóÖÏû•Îßå ÌïÑÌÑ∞ÎßÅ
          const businessesWithPermits = businessResult.data.filter((business: BusinessInfo) =>
            uniqueBusinessIds.includes(business.id)
          )
          
          setBusinessesWithPermits(businessesWithPermits)
          console.log(`‚úÖ ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ ÏûàÎäî ÏÇ¨ÏóÖÏû•: ${businessesWithPermits.length}Í∞ú`)
        }
      }
    } catch (error) {
      console.error('Error loading businesses with permits:', error)
      alert('ÏÇ¨ÏóÖÏû• Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§')
    } finally {
      setIsLoading(false)
    }
  }, [])

  // ÏÑ†ÌÉùÎêú ÏÇ¨ÏóÖÏû•Ïùò ÎåÄÍ∏∞ÌïÑÏ¶ù Î™©Î°ù Î°úÎìú
  const loadAirPermits = async (businessId: string) => {
    try {
      setIsLoading(true)
      const response = await fetch(`/api/air-permit?businessId=${businessId}`)
      const result = await response.json()
      
      if (response.ok) {
        console.log('üìã Î°úÎìúÎêú ÎåÄÍ∏∞ÌïÑÏ¶ù Î™©Î°ù:', result.data)
        
        // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Ï†ïÍ∑úÌôî - additional_infoÍ∞Ä Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞ ÌååÏã±
        const normalizedPermits = result.data.map((permit: any) => {
          let additionalInfo = permit.additional_info || {}
          
          // additional_infoÍ∞Ä Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞ JSON ÌååÏã±
          if (typeof additionalInfo === 'string') {
            try {
              additionalInfo = JSON.parse(additionalInfo)
            } catch (e) {
              console.warn('additional_info ÌååÏã± Ïã§Ìå®:', e)
              additionalInfo = {}
            }
          }
          
          return {
            ...permit,
            additional_info: additionalInfo
          }
        })
        
        setAirPermits(normalizedPermits)
      } else {
        alert('ÎåÄÍ∏∞ÌïÑÏ¶ù Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.error)
      }
    } catch (error) {
      console.error('Error loading air permits:', error)
      alert('ÎåÄÍ∏∞ÌïÑÏ¶ù Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§')
    } finally {
      setIsLoading(false)
    }
  }

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ ÏûàÎäî ÏÇ¨ÏóÖÏû• Î™©Î°ù Î°úÎìú (ÏµúÏ†ÅÌôîÎê®)
  useEffect(() => {
    loadBusinessesWithPermitsOptimized()
  }, [loadBusinessesWithPermitsOptimized])

  // ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù Ïãú ÎåÄÍ∏∞ÌïÑÏ¶ù Î™©Î°ù Î°úÎìú
  const handleBusinessSelect = (business: BusinessInfo) => {
    setSelectedBusiness(business)
    loadAirPermits(business.id)
  }

  // ÏÉà ÎåÄÍ∏∞ÌïÑÏ¶ù Ï∂îÍ∞Ä Î™®Îã¨ Ïó¥Í∏∞
  const openAddModal = () => {
    setEditingPermit(null)
    setFormData({
      business_id: '',
      business_type: '',
      category: '',
      business_name: '',
      pollutants: [],
      first_report_date: '',
      operation_start_date: '',
      outlets: [],
      additional_info: {},
      is_active: true,
      is_deleted: false
    })
    setBusinessSearchTerm('')
    setShowBusinessSuggestions(false)
    setIsModalOpen(true)
  }

  // ÎåÄÍ∏∞ÌïÑÏ¶ù Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞ (ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú)
  const openEditModal = async (permit: AirPermitInfo) => {
    console.log('üîç Ìé∏ÏßëÌï† ÎåÄÍ∏∞ÌïÑÏ¶ù Îç∞Ïù¥ÌÑ∞:', permit)
    
    setEditingPermit(permit)
    
    try {
      // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú (Î∞∞Ï∂úÍµ¨ Î∞è ÏãúÏÑ§ Ï†ïÎ≥¥ Ìè¨Ìï®)
      const detailResponse = await fetch(`/api/air-permit?id=${permit.id}&details=true`)
      const detailResult = await detailResponse.json()
      
      let permitWithDetails = permit
      if (detailResponse.ok && detailResult.data) {
        permitWithDetails = detailResult.data
        console.log('üìã ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú ÏÑ±Í≥µ:', permitWithDetails)
      } else {
        console.warn('‚ö†Ô∏è ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®, Í∏∞Î≥∏ Ï†ïÎ≥¥Îßå ÏÇ¨Ïö©')
      }
      
      // additional_infoÏóêÏÑú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú (ÏïàÏ†ÑÌïú Î∞©ÏãùÏúºÎ°ú)
      const additionalInfo = permitWithDetails.additional_info || {}
      
      const formDataToSet = {
        ...permitWithDetails,
        // Ïã§Ï†ú ÌïÑÎìú Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ additional_infoÏóêÏÑú Ï∂îÏ∂ú
        business_type: additionalInfo.business_type || permitWithDetails.business_type || '',
        category: additionalInfo.category || permitWithDetails.category || '',
        business_name: additionalInfo.business_name || permitWithDetails.business_name || '',
        first_report_date: permitWithDetails.first_report_date || additionalInfo.first_report_date || '',
        operation_start_date: permitWithDetails.operation_start_date || additionalInfo.operation_start_date || '',
        pollutants: additionalInfo.pollutants || [],
        outlets: permitWithDetails.outlets || additionalInfo.outlets || []
      }
      
      // Í∏∞Î≥∏ outletÏù¥ ÏóÜÏúºÎ©¥ Îπà Î∞∞Ï∂úÍµ¨Î•º ÌïòÎÇò Ï∂îÍ∞Ä
      if (formDataToSet.outlets.length === 0) {
        formDataToSet.outlets = [{
          outlet_number: 1,
          outlet_name: '',
          discharge_facilities: additionalInfo.discharge_facilities || [],
          prevention_facilities: additionalInfo.prevention_facilities || []
        }]
      }
      
      // ÏãúÏÑ§ Îç∞Ïù¥ÌÑ∞ ÌïÑÎìúÎ™Ö Ï†ïÍ∑úÌôî (facility_name -> name, capacity, quantity Ïú†ÏßÄ)
      formDataToSet.outlets = formDataToSet.outlets.map((outlet: any) => ({
        ...outlet,
        discharge_facilities: (outlet.discharge_facilities || []).map((facility: any) => ({
          name: facility.name || facility.facility_name || '',
          capacity: facility.capacity || '',
          quantity: facility.quantity || 1
        })),
        prevention_facilities: (outlet.prevention_facilities || []).map((facility: any) => ({
          name: facility.name || facility.facility_name || '',
          capacity: facility.capacity || '',
          quantity: facility.quantity || 1
        }))
      }))
      
      console.log('üîç Ìé∏Ïßë ÌèºÏóê ÏÑ§Ï†ïÌï† Îç∞Ïù¥ÌÑ∞:', formDataToSet)
      
      setFormData(formDataToSet)
      setIsModalOpen(true)
      
    } catch (error) {
      console.error('‚ùå ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error)
      // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Ï†ïÎ≥¥Î°ú Ìè¥Î∞±
      const additionalInfo = permit.additional_info || {}
      const formDataToSet = {
        ...permit,
        business_type: additionalInfo.business_type || permit.business_type || '',
        category: additionalInfo.category || permit.category || '',
        business_name: additionalInfo.business_name || permit.business_name || '',
        first_report_date: permit.first_report_date || additionalInfo.first_report_date || '',
        operation_start_date: permit.operation_start_date || additionalInfo.operation_start_date || '',
        pollutants: additionalInfo.pollutants || [],
        outlets: additionalInfo.outlets || [{
          outlet_number: 1,
          outlet_name: '',
          discharge_facilities: additionalInfo.discharge_facilities || [],
          prevention_facilities: additionalInfo.prevention_facilities || []
        }]
      }
      setFormData(formDataToSet)
      setIsModalOpen(true)
    }
  }

  // Ìèº Ï†úÏ∂ú
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    try {
      const method = editingPermit ? 'PUT' : 'POST'
      const url = '/api/air-permit'
      const body = editingPermit 
        ? { id: editingPermit.id, ...formData }
        : formData

      console.log('üöÄ ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑú Ï†ÑÏÜ°ÌïòÎäî Îç∞Ïù¥ÌÑ∞:', {
        method,
        url,
        body
      })

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })

      console.log('üì• ÏÑúÎ≤Ñ ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText)
      
      let result
      const responseText = await response.text()
      console.log('üì• ÏõêÏãú ÏùëÎãµ:', responseText)
      
      try {
        result = responseText ? JSON.parse(responseText) : {}
      } catch (parseError) {
        console.error('‚ùå JSON ÌååÏã± Ïò§Î•ò:', parseError)
        console.error('‚ùå ÏõêÏãú ÏùëÎãµ ÌÖçÏä§Ìä∏:', responseText)
        throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµÏùÑ ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§: ${responseText}`)
      }
      
      console.log('üì• ÌååÏã±Îêú ÏùëÎãµ:', result)

      if (response.ok) {
        alert(result.message || 'Ï†ÄÏû•Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§')
        setIsModalOpen(false)
        if (selectedBusiness) {
          loadAirPermits(selectedBusiness.id)
        }
      } else {
        console.error('‚ùå Ï†ÄÏû• Ïã§Ìå®:', result)
        alert(result.error || `ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`)
      }
    } catch (error) {
      console.error('‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò:', error)
      alert('ÎåÄÍ∏∞ÌïÑÏ¶ù Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§')
    }
  }

  // ÎåÄÍ∏∞ÌïÑÏ¶ù ÏÇ≠Ï†ú ÌôïÏù∏
  const confirmDelete = (permit: AirPermitInfo) => {
    setPermitToDelete(permit)
    setDeleteConfirmOpen(true)
  }

  // ÎåÄÍ∏∞ÌïÑÏ¶ù ÏÇ≠Ï†ú
  const handleDelete = async () => {
    if (!permitToDelete) return

    try {
      const response = await fetch(`/api/air-permit?id=${permitToDelete.id}`, {
        method: 'DELETE'
      })

      const result = await response.json()

      if (response.ok) {
        setDeleteConfirmOpen(false)
        setPermitToDelete(null)
        if (selectedBusiness) {
          loadAirPermits(selectedBusiness.id)
        }
      } else {
        alert(result.error)
      }
    } catch (error) {
      console.error('Error deleting air permit:', error)
      alert('ÎåÄÍ∏∞ÌïÑÏ¶ù ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§')
    }
  }

  // Íµ¨Í∏ÄÏãúÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞ Ï≤òÎ¶¨
  const handleImportFromSheet = async () => {
    if (!importSettings.spreadsheetId.trim()) {
      alert('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')
      return
    }

    try {
      setIsImporting(true)
      
      const response = await fetch('/api/air-permit-management', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          spreadsheetId: importSettings.spreadsheetId,
          sheetName: importSettings.sheetName,
          startRow: importSettings.startRow
        })
      })

      const result = await response.json()

      if (response.ok) {
        const summary = result.summary || {}
        alert(`Íµ¨Í∏ÄÏãúÌä∏ÏóêÏÑú ${summary.successCount || 0}Í∞úÏùò ÎåÄÍ∏∞ÌïÑÏ¶ù Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§. (Ï§ëÎ≥µ Ïä§ÌÇµ: ${summary.skipCount || 0}Í∞ú, Ïò§Î•ò: ${summary.errorCount || 0}Í∞ú)`)
        setIsImportModalOpen(false)
        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÇ¨ÏóÖÏû•Ïùò Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
        if (selectedBusiness) {
          await loadAirPermits(selectedBusiness.id)
        }
        // ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ ÏûàÎäî ÏÇ¨ÏóÖÏû• Î™©Î°ùÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
        await loadBusinessesWithPermitsOptimized()
      } else {
        alert(result.error || 'Íµ¨Í∏ÄÏãúÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
    } catch (error) {
      console.error('Íµ¨Í∏ÄÏãúÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞ Ïò§Î•ò:', error)
      alert('Íµ¨Í∏ÄÏãúÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
    } finally {
      setIsImporting(false)
    }
  }

  // Air permits with ID for DataTable
  const airPermitsWithId = useMemo(() => 
    airPermits.map(permit => ({
      ...permit,
      id: permit.id || `permit-${permit.business_name}`
    }))
  , [airPermits])

  // Table columns for air permits
  const airPermitColumns = [
    {
      key: 'business_type',
      title: 'ÏóÖÏ¢Ö',
      render: (item: AirPermitInfo) => (
        <span className="text-sm">{item.business_type || '-'}</span>
      )
    },
    {
      key: 'category',
      title: 'Ï¢ÖÎ≥Ñ',
      render: (item: AirPermitInfo) => (
        <span className="text-sm">{item.category || item.additional_info?.category || '-'}</span>
      )
    },
    {
      key: 'pollutants',
      title: 'Ïò§ÏóºÎ¨ºÏßà',
      render: (item: AirPermitInfo) => (
        <div className="flex flex-col">
          <span className="text-sm font-medium">
            {item.additional_info?.pollutants?.length > 0 
              ? `${item.additional_info.pollutants.length}Í∞ú`
              : '0Í∞ú'
            }
          </span>
          {item.additional_info?.pollutants?.length > 0 && (
            <span className="text-xs text-gray-500">
              {item.additional_info.pollutants.slice(0, 2).map((p: any) => p.type).join(', ')}
              {item.additional_info.pollutants.length > 2 && '...'}
            </span>
          )}
        </div>
      )
    },
    {
      key: 'first_report_date',
      title: 'ÏµúÏ¥àÏã†Í≥†Ïùº',
      render: (item: AirPermitInfo) => {
        const date = item.first_report_date || item.additional_info?.first_report_date
        return (
          <span className="text-sm">
            {date ? new Date(date).toLocaleDateString('ko-KR') : '-'}
          </span>
        )
      }
    },
    {
      key: 'operation_start_date',
      title: 'Í∞ÄÎèôÍ∞úÏãúÏùº',
      render: (item: AirPermitInfo) => {
        const date = item.operation_start_date || item.additional_info?.operation_start_date
        return (
          <span className="text-sm">
            {date ? new Date(date).toLocaleDateString('ko-KR') : '-'}
          </span>
        )
      }
    }
  ]

  // Table actions for air permits
  const airPermitActions = [
    {
      label: 'ÌïÑÏ¶ùÎ≥¥Í∏∞',
      icon: Eye,
      onClick: (item: AirPermitInfo) => {
        window.location.href = `/admin/air-permit-detail?permitId=${item.id}`
      },
      variant: 'secondary' as const,
      show: () => true
    },
    {
      ...commonActions.edit((item: AirPermitInfo) => openEditModal(item)),
      show: () => true
    },
    {
      label: 'ÏÇ≠Ï†ú',
      icon: Trash2,
      onClick: (item: AirPermitInfo) => confirmDelete(item),
      variant: 'danger' as const,
      show: () => true
    }
  ]

  return (
    <AdminLayout
      title="ÎåÄÍ∏∞ÌïÑÏ¶ù Í¥ÄÎ¶¨"
      description="ÎåÄÍ∏∞Î∞∞Ï∂úÏãúÏÑ§ ÌóàÍ∞ÄÏ¶ù Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú"
      actions={(
        <div className="flex items-center gap-3">
          <GoogleSheetsImporter />
          <button
            onClick={() => setIsImportModalOpen(true)}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <Upload className="w-4 h-4" />
            Í∏∞Ï°¥ Í∞ÄÏ†∏Ïò§Í∏∞
          </button>
          <button
            onClick={openAddModal}
            className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            <Plus className="w-4 h-4" />
            ÏÉà ÎåÄÍ∏∞ÌïÑÏ¶ù Ï∂îÍ∞Ä
          </button>
        </div>
      )}
    >
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Business Selection Panel */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <Building2 className="w-5 h-5 text-blue-600" />
              ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù
              <span className="ml-auto text-sm text-gray-500">
                {filteredBusinessesWithPermits.length}Í∞ú ÏÇ¨ÏóÖÏû•
              </span>
            </h2>
            
            {/* Í≤ÄÏÉâ ÏûÖÎ†• ÌïÑÎìú */}
            <div className="relative mb-4">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Search className="w-4 h-4 text-gray-400" />
              </div>
              <input
                type="text"
                lang="ko"
                inputMode="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="ÏÇ¨ÏóÖÏû•Î™Ö, ÏßÄÏûêÏ≤¥, Îã¥ÎãπÏûê Í≤ÄÏÉâ..."
                className="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 hover:bg-white transition-all duration-200"
              />
              {searchTerm && (
                <button
                  onClick={() => setSearchTerm('')}
                  className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <X className="w-4 h-4" />
                </button>
              )}
            </div>
            
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {filteredBusinessesWithPermits.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <Search className="w-8 h-8 mx-auto mb-2 text-gray-300" />
                  <div className="text-sm">
                    {searchTerm ? `"${searchTerm}"Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.` : 'ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ Îì±Î°ùÎêú ÏÇ¨ÏóÖÏû•Ïù¥ ÏóÜÏäµÎãàÎã§.'}
                  </div>
                </div>
              ) : (
                filteredBusinessesWithPermits.map((business) => (
                <button
                  key={business.id}
                  onClick={() => handleBusinessSelect(business)}
                  className={`w-full text-left p-3 rounded-lg transition-all duration-200 ${
                    selectedBusiness?.id === business.id
                      ? 'bg-blue-50 text-blue-800 border border-blue-200 shadow-sm'
                      : 'hover:bg-gray-50 border border-transparent hover:border-gray-200'
                  }`}
                >
                  <div className="font-medium">{business.business_name}</div>
                  <div className="text-sm text-gray-500">{business.local_government || '-'}</div>
                </button>
              )))}
            </div>
          </div>
        </div>

        {/* Air Permits Panel */}
        <div className="lg:col-span-2">
          {!selectedBusiness ? (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
              <Building2 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
              <div className="text-gray-500 mb-2 font-medium">ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
              <div className="text-sm text-gray-400">
                ÏôºÏ™ΩÏóêÏÑú ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ìï¥Îãπ ÏÇ¨ÏóÖÏû•Ïùò ÎåÄÍ∏∞ÌïÑÏ¶ù Î™©Î°ùÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§
              </div>
            </div>
          ) : (
            <div className="space-y-6">
              {/* Stats Cards for selected business */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatsCard
                  title="Ï¥ù ÎåÄÍ∏∞ÌïÑÏ¶ù"
                  value={stats.total}
                  icon={ClipboardList}
                  color="blue"
                  description="Îì±Î°ùÎêú ÎåÄÍ∏∞ÌïÑÏ¶ù Ïàò"
                />
                
                <StatsCard
                  title="Î∞∞Ï∂úÍµ¨ ÏÑ§Ï†ï"
                  value={stats.withOutlets}
                  icon={Factory}
                  color="green"
                  trend={{
                    value: stats.total > 0 ? Math.round((stats.withOutlets / stats.total) * 100) : 0,
                    direction: 'up',
                    label: 'ÏÑ§Ï†ï ÏôÑÎ£åÏú®'
                  }}
                />
                
                <StatsCard
                  title="Ïò§ÏóºÎ¨ºÏßà Îì±Î°ù"
                  value={stats.withPollutants}
                  icon={FileText}
                  color="purple"
                  trend={{
                    value: stats.total > 0 ? Math.round((stats.withPollutants / stats.total) * 100) : 0,
                    direction: 'up',
                    label: 'Îì±Î°ù ÏôÑÎ£åÏú®'
                  }}
                />
                
                <StatsCard
                  title="ÏµúÍ∑º Ï∂îÍ∞Ä"
                  value={stats.recentlyAdded}
                  icon={Calendar}
                  color="yellow"
                  description="30Ïùº Ïù¥ÎÇ¥ Ï∂îÍ∞ÄÎêú ÎåÄÍ∏∞ÌïÑÏ¶ù"
                />
              </div>

              {/* Air Permits Data Table */}
              <DataTable
                data={airPermitsWithId}
                columns={airPermitColumns}
                actions={airPermitActions}
                loading={isLoading}
                emptyMessage="Îì±Î°ùÎêú ÎåÄÍ∏∞ÌïÑÏ¶ùÏù¥ ÏóÜÏäµÎãàÎã§. ÏÉà ÎåÄÍ∏∞ÌïÑÏ¶ùÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî."
                pageSize={10}
              />
            </div>
          )}
        </div>
      </div>

      {/* ÎåÄÍ∏∞ÌïÑÏ¶ù Ï∂îÍ∞Ä/Ìé∏Ïßë Î™®Îã¨ */}
      {isModalOpen && (
        <div 
          className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setIsModalOpen(false)
            }
          }}
        >
          <div 
            className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="text-xl font-semibold text-gray-800">
                {editingPermit ? 'ÎåÄÍ∏∞ÌïÑÏ¶ù Ï†ïÎ≥¥ Ìé∏Ïßë' : 'ÏÉà ÎåÄÍ∏∞ÌïÑÏ¶ù Ï∂îÍ∞Ä'}
              </h2>
            </div>
            
            <form onSubmit={handleSubmit} className="p-6" onClick={() => setShowBusinessSuggestions(false)}>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÏóÖÏ¢Ö
                  </label>
                  <input
                    type="text"
                    lang="ko"
                    inputMode="text"
                    value={formData.business_type || ''}
                    onChange={(e) => setFormData({...formData, business_type: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Ï¢ÖÎ≥Ñ
                  </label>
                  <input
                    type="text"
                    lang="ko"
                    inputMode="text"
                    value={formData.category || ''}
                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div className="relative" onClick={(e) => e.stopPropagation()}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÏÇ¨ÏóÖÏû•Î™Ö *
                  </label>
                  {editingPermit ? (
                    // Ìé∏Ïßë Î™®Îìú: ÏÇ¨ÏóÖÏû•Î™ÖÏùÄ ÏùΩÍ∏∞ Ï†ÑÏö©ÏúºÎ°ú ÌëúÏãú
                    <div className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700">
                      {formData.business_name || editingPermit?.additional_info?.business_name || '-'}
                    </div>
                  ) : (
                    // ÏÉà Ï∂îÍ∞Ä Î™®Îìú: Í≤ÄÏÉâ ÏûÖÎ†• ÌïÑÎìú
                    <input
                      type="text"
                      lang="ko"
                      inputMode="text"
                      value={businessSearchTerm}
                      onChange={(e) => {
                        setBusinessSearchTerm(e.target.value)
                        setShowBusinessSuggestions(true)
                      }}
                      onFocus={() => setShowBusinessSuggestions(true)}
                      placeholder="ÏÇ¨ÏóÖÏû•Î™ÖÏùÑ Í≤ÄÏÉâÌïòÏÑ∏Ïöî..."
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  )}
                  
                  {/* ÏÇ¨ÏóÖÏû• Í≤ÄÏÉâ Í≤∞Í≥º */}
                  {showBusinessSuggestions && filteredAllBusinesses.length > 0 && (
                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto">
                      {filteredAllBusinesses.map((business) => (
                        <button
                          key={business.id}
                          type="button"
                          onClick={() => {
                            setFormData({
                              ...formData,
                              business_id: business.id,
                              business_name: business.business_name
                            })
                            setBusinessSearchTerm(business.business_name)
                            setShowBusinessSuggestions(false)
                          }}
                          className="w-full text-left px-3 py-2 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                        >
                          <div className="font-medium">{business.business_name}</div>
                          <div className="text-sm text-gray-500">{business.local_government}</div>
                        </button>
                      ))}
                    </div>
                  )}
                  
                  {/* Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏùÑ Îïå */}
                  {showBusinessSuggestions && businessSearchTerm && filteredAllBusinesses.length === 0 && (
                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg p-3 text-sm text-gray-500">
                      Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.
                    </div>
                  )}
                </div>

                {/* Ïò§ÏóºÎ¨ºÏßà Ï¢ÖÎ•òÏôÄ Î∞úÏÉùÎüâ */}
                <div className="md:col-span-2">
                  <h4 className="text-lg font-medium text-gray-800 mb-4">Ïò§ÏóºÎ¨ºÏßà Ï†ïÎ≥¥</h4>
                  <div className="space-y-4">
                    {(formData.pollutants || []).map((pollutant: any, index: number) => (
                      <div key={index} className="p-4 border border-gray-200 rounded-lg">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Ïò§ÏóºÎ¨ºÏßàÏ¢ÖÎ•ò
                            </label>
                            <input
                              type="text"
                              lang="ko"
                              inputMode="text"
                              value={pollutant.type || ''}
                              onChange={(e) => {
                                const newPollutants = [...(formData.pollutants || [])]
                                newPollutants[index] = { ...pollutant, type: e.target.value }
                                setFormData({...formData, pollutants: newPollutants})
                              }}
                              placeholder="Ïòà: Î®ºÏßÄ, Ìô©ÏÇ∞ÌôîÎ¨º, ÏßàÏÜåÏÇ∞ÌôîÎ¨º"
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Ïò§ÏóºÎ¨ºÏßàÎ∞úÏÉùÎüâ (ÌÜ§/ÎÖÑ)
                            </label>
                            <input
                              type="number"
                              step="any"
                              min="0"
                              value={pollutant.amount !== null && pollutant.amount !== undefined ? pollutant.amount : ''}
                              onChange={(e) => {
                                const newPollutants = [...(formData.pollutants || [])]
                                const value = e.target.value
                                newPollutants[index] = { 
                                  ...pollutant, 
                                  amount: value === '' ? null : parseFloat(value) 
                                }
                                setFormData({...formData, pollutants: newPollutants})
                              }}
                              placeholder="0.012"
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div className="flex items-end">
                            <button
                              type="button"
                              onClick={() => {
                                const newPollutants = (formData.pollutants || []).filter((_: any, i: number) => i !== index)
                                setFormData({...formData, pollutants: newPollutants})
                              }}
                              className="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                            >
                              ÏÇ≠Ï†ú
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                    <button
                      type="button"
                      onClick={() => {
                        const newPollutants = [...(formData.pollutants || []), { type: '', amount: null }]
                        setFormData({...formData, pollutants: newPollutants})
                      }}
                      className="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-gray-400 hover:text-gray-800"
                    >
                      + Ïò§ÏóºÎ¨ºÏßà Ï∂îÍ∞Ä
                    </button>
                  </div>
                </div>


                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÏµúÏ¥àÏã†Í≥†Ïùº
                  </label>
                  <DateInput
                    value={formData.first_report_date || ''}
                    onChange={(value) => setFormData({...formData, first_report_date: value})}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Í∞ÄÎèôÍ∞úÏãúÏùº
                  </label>
                  <DateInput
                    value={formData.operation_start_date || ''}
                    onChange={(value) => setFormData({...formData, operation_start_date: value})}
                  />
                </div>
              </div>

              {/* Î∞∞Ï∂úÍµ¨Î≥Ñ ÏãúÏÑ§ Í¥ÄÎ¶¨ */}
              <div className="mt-8">
                <h3 className="text-lg font-medium text-gray-800 mb-4">Î∞∞Ï∂úÍµ¨Î≥Ñ ÏãúÏÑ§ Í¥ÄÎ¶¨</h3>
                <div className="space-y-6">
                  {(formData.outlets || []).map((outlet: any, outletIndex: number) => (
                    <div key={outletIndex} className="p-6 border-2 border-gray-200 rounded-lg bg-gray-50">
                      {/* Î∞∞Ï∂úÍµ¨ Ï†ïÎ≥¥ */}
                      <div className="mb-6">
                        <div className="flex justify-between items-center mb-4">
                          <h4 className="text-md font-semibold text-gray-800">
                            Î∞∞Ï∂úÍµ¨ #{outletIndex + 1}
                          </h4>
                          <button
                            type="button"
                            onClick={() => {
                              const newOutlets = (formData.outlets || []).filter((_: any, i: number) => i !== outletIndex)
                              setFormData({...formData, outlets: newOutlets})
                            }}
                            className="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm"
                          >
                            Î∞∞Ï∂úÍµ¨ ÏÇ≠Ï†ú
                          </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Î∞∞Ï∂úÍµ¨Î≤àÌò∏
                            </label>
                            <input
                              type="number"
                              min="1"
                              value={outlet.outlet_number || outletIndex + 1}
                              onChange={(e) => {
                                const newOutlets = [...(formData.outlets || [])]
                                newOutlets[outletIndex] = { ...outlet, outlet_number: parseInt(e.target.value) || 1 }
                                setFormData({...formData, outlets: newOutlets})
                              }}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Î∞∞Ï∂úÍµ¨Î™Ö
                            </label>
                            <input
                              type="text"
                              lang="ko"
                              inputMode="text"
                              value={outlet.outlet_name || ''}
                              onChange={(e) => {
                                const newOutlets = [...(formData.outlets || [])]
                                newOutlets[outletIndex] = { ...outlet, outlet_name: e.target.value }
                                setFormData({...formData, outlets: newOutlets})
                              }}
                              placeholder="Ïòà: Î≥¥ÏùºÎü¨ Î∞∞Ï∂úÍµ¨"
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Î∞∞Ï∂úÏãúÏÑ§ */}
                      <div className="mb-6">
                        <h5 className="text-sm font-medium text-gray-800 mb-3">Î∞∞Ï∂úÏãúÏÑ§</h5>
                        <div className="space-y-3">
                          {(outlet.discharge_facilities || []).map((facility: any, facilityIndex: number) => (
                            <div key={facilityIndex} className="p-3 bg-white border border-gray-200 rounded-lg">
                              <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                  <input
                                    type="text"
                                    lang="ko"
                                    inputMode="text"
                                    value={facility.name || ''}
                                    onChange={(e) => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.discharge_facilities || [])]
                                      newFacilities[facilityIndex] = { ...facility, name: e.target.value }
                                      newOutlets[outletIndex] = { ...outlet, discharge_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Tab' && !e.shiftKey) {
                                        e.preventDefault()
                                        const nextInput = e.currentTarget.parentElement?.nextElementSibling?.querySelector('input')
                                        nextInput?.focus()
                                      }
                                    }}
                                    placeholder="Î∞∞Ï∂úÏãúÏÑ§Î™Ö"
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                  />
                                </div>
                                <div>
                                  <input
                                    type="text"
                                    lang="ko"
                                    inputMode="text"
                                    value={facility.capacity || ''}
                                    onChange={(e) => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.discharge_facilities || [])]
                                      newFacilities[facilityIndex] = { ...facility, capacity: e.target.value }
                                      newOutlets[outletIndex] = { ...outlet, discharge_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Tab' && !e.shiftKey) {
                                        e.preventDefault()
                                        const nextInput = e.currentTarget.parentElement?.nextElementSibling?.querySelector('input')
                                        nextInput?.focus()
                                      }
                                    }}
                                    placeholder="Ïö©Îüâ"
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                  />
                                </div>
                                <div>
                                  <input
                                    type="number"
                                    min="1"
                                    value={facility.quantity || 1}
                                    onChange={(e) => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.discharge_facilities || [])]
                                      newFacilities[facilityIndex] = { ...facility, quantity: parseInt(e.target.value) || 1 }
                                      newOutlets[outletIndex] = { ...outlet, discharge_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Tab' && !e.shiftKey) {
                                        e.preventDefault()
                                        const copyButton = e.currentTarget.parentElement?.nextElementSibling?.querySelector('button')
                                        copyButton?.focus()
                                      }
                                    }}
                                    placeholder="ÏàòÎüâ"
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                  />
                                </div>
                                <div className="flex gap-1">
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.discharge_facilities || [])]
                                      // ÌòÑÏû¨ ÏãúÏÑ§ÏùÑ Î≥µÏÇ¨ÌïòÏó¨ Ï∂îÍ∞Ä
                                      const facilityToCopy = { ...facility }
                                      newFacilities.splice(facilityIndex + 1, 0, facilityToCopy)
                                      newOutlets[outletIndex] = { ...outlet, discharge_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                    title="Î≥µÏ†ú"
                                  >
                                    Î≥µÏ†ú
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = (outlet.discharge_facilities || []).filter((_: any, i: number) => i !== facilityIndex)
                                      newOutlets[outletIndex] = { ...outlet, discharge_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    className="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                    title="ÏÇ≠Ï†ú"
                                  >
                                    ÏÇ≠Ï†ú
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))}
                          <button
                            type="button"
                            onClick={() => {
                              const newOutlets = [...(formData.outlets || [])]
                              const newFacilities = [...(outlet.discharge_facilities || []), { name: '', capacity: '', quantity: 1 }]
                              newOutlets[outletIndex] = { ...outlet, discharge_facilities: newFacilities }
                              setFormData({...formData, outlets: newOutlets})
                            }}
                            className="w-full px-3 py-2 border border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400 text-sm"
                          >
                            + Î∞∞Ï∂úÏãúÏÑ§ Ï∂îÍ∞Ä
                          </button>
                        </div>
                      </div>

                      {/* Î∞©ÏßÄÏãúÏÑ§ */}
                      <div>
                        <h5 className="text-sm font-medium text-gray-800 mb-3">Î∞©ÏßÄÏãúÏÑ§</h5>
                        <div className="space-y-3">
                          {(outlet.prevention_facilities || []).map((facility: any, facilityIndex: number) => (
                            <div key={facilityIndex} className="p-3 bg-white border border-gray-200 rounded-lg">
                              <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                  <input
                                    type="text"
                                    lang="ko"
                                    inputMode="text"
                                    value={facility.name || ''}
                                    onChange={(e) => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.prevention_facilities || [])]
                                      newFacilities[facilityIndex] = { ...facility, name: e.target.value }
                                      newOutlets[outletIndex] = { ...outlet, prevention_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Tab' && !e.shiftKey) {
                                        e.preventDefault()
                                        const nextInput = e.currentTarget.parentElement?.nextElementSibling?.querySelector('input')
                                        nextInput?.focus()
                                      }
                                    }}
                                    placeholder="Î∞©ÏßÄÏãúÏÑ§Î™Ö"
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                  />
                                </div>
                                <div>
                                  <input
                                    type="text"
                                    lang="ko"
                                    inputMode="text"
                                    value={facility.capacity || ''}
                                    onChange={(e) => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.prevention_facilities || [])]
                                      newFacilities[facilityIndex] = { ...facility, capacity: e.target.value }
                                      newOutlets[outletIndex] = { ...outlet, prevention_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Tab' && !e.shiftKey) {
                                        e.preventDefault()
                                        const nextInput = e.currentTarget.parentElement?.nextElementSibling?.querySelector('input')
                                        nextInput?.focus()
                                      }
                                    }}
                                    placeholder="Ïö©Îüâ"
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                  />
                                </div>
                                <div>
                                  <input
                                    type="number"
                                    min="1"
                                    value={facility.quantity || 1}
                                    onChange={(e) => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.prevention_facilities || [])]
                                      newFacilities[facilityIndex] = { ...facility, quantity: parseInt(e.target.value) || 1 }
                                      newOutlets[outletIndex] = { ...outlet, prevention_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Tab' && !e.shiftKey) {
                                        e.preventDefault()
                                        const copyButton = e.currentTarget.parentElement?.nextElementSibling?.querySelector('button')
                                        copyButton?.focus()
                                      }
                                    }}
                                    placeholder="ÏàòÎüâ"
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                  />
                                </div>
                                <div className="flex gap-1">
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = [...(outlet.prevention_facilities || [])]
                                      // ÌòÑÏû¨ ÏãúÏÑ§ÏùÑ Î≥µÏÇ¨ÌïòÏó¨ Ï∂îÍ∞Ä
                                      const facilityToCopy = { ...facility }
                                      newFacilities.splice(facilityIndex + 1, 0, facilityToCopy)
                                      newOutlets[outletIndex] = { ...outlet, prevention_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                    title="Î≥µÏ†ú"
                                  >
                                    Î≥µÏ†ú
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const newOutlets = [...(formData.outlets || [])]
                                      const newFacilities = (outlet.prevention_facilities || []).filter((_: any, i: number) => i !== facilityIndex)
                                      newOutlets[outletIndex] = { ...outlet, prevention_facilities: newFacilities }
                                      setFormData({...formData, outlets: newOutlets})
                                    }}
                                    className="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                    title="ÏÇ≠Ï†ú"
                                  >
                                    ÏÇ≠Ï†ú
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))}
                          <button
                            type="button"
                            onClick={() => {
                              const newOutlets = [...(formData.outlets || [])]
                              const newFacilities = [...(outlet.prevention_facilities || []), { name: '', capacity: '', quantity: 1 }]
                              newOutlets[outletIndex] = { ...outlet, prevention_facilities: newFacilities }
                              setFormData({...formData, outlets: newOutlets})
                            }}
                            className="w-full px-3 py-2 border border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400 text-sm"
                          >
                            + Î∞©ÏßÄÏãúÏÑ§ Ï∂îÍ∞Ä
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                  <button
                    type="button"
                    onClick={() => {
                      const newOutlets = [...(formData.outlets || []), { 
                        outlet_number: (formData.outlets || []).length + 1,
                        outlet_name: '',
                        discharge_facilities: [],
                        prevention_facilities: []
                      }]
                      setFormData({...formData, outlets: newOutlets})
                    }}
                    className="w-full px-4 py-3 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 hover:border-blue-400 hover:text-blue-800 bg-blue-50 hover:bg-blue-100"
                  >
                    + ÏÉà Î∞∞Ï∂úÍµ¨ Ï∂îÍ∞Ä
                  </button>
                </div>
              </div>

              <div className="flex justify-end gap-4 mt-8">
                <button
                  type="button"
                  onClick={() => setIsModalOpen(false)}
                  className="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                >
                  Ï∑®ÏÜå
                </button>
                <button
                  type="submit"
                  className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  {editingPermit ? 'ÏàòÏ†ï' : 'Ï∂îÍ∞Ä'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Google Sheets Import Modal */}
      {isImportModalOpen && (
        <div 
          className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setIsImportModalOpen(false)
            }
          }}
        >
          <div className="bg-white rounded-lg shadow-xl max-w-lg w-full" onClick={(e) => e.stopPropagation()}>
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="text-xl font-semibold text-gray-800 flex items-center gap-2">
                <Upload className="w-5 h-5" />
                Íµ¨Í∏ÄÏãúÌä∏ÏóêÏÑú ÎåÄÍ∏∞ÌïÑÏ¶ù Í∞ÄÏ†∏Ïò§Í∏∞
              </h2>
              <p className="text-sm text-gray-600 mt-1">
                ÎåÄÍ∏∞ÌïÑÏ¶ù DB ÏãúÌä∏ÏóêÏÑú ÏÇ¨ÏóÖÏû•Î≥Ñ Î∞∞Ï∂úÍµ¨ Î∞è ÏãúÏÑ§ Îç∞Ïù¥ÌÑ∞Î•º ÏùºÍ¥Ñ Í∞ÄÏ†∏ÏòµÎãàÎã§.
              </p>
            </div>
            
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ID
                </label>
                <input
                  type="text"
                  value={importSettings.spreadsheetId}
                  onChange={(e) => setImportSettings({...importSettings, spreadsheetId: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  placeholder="1ABC123...xyz"
                  disabled={isImporting}
                />
                <p className="text-xs text-gray-500 mt-1">
                  Íµ¨Í∏ÄÏãúÌä∏ URLÏóêÏÑú /d/ Îí§Ïùò ID Î∂ÄÎ∂ÑÎßå ÏûÖÎ†•ÌïòÏÑ∏Ïöî
                </p>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÏãúÌä∏Î™Ö
                  </label>
                  <input
                    type="text"
                    lang="ko"
                    inputMode="text"
                    value={importSettings.sheetName}
                    onChange={(e) => setImportSettings({...importSettings, sheetName: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    disabled={isImporting}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÏãúÏûë Ìñâ
                  </label>
                  <input
                    type="number"
                    value={importSettings.startRow}
                    onChange={(e) => setImportSettings({...importSettings, startRow: parseInt(e.target.value) || 2})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    min="1"
                    disabled={isImporting}
                  />
                </div>
              </div>
              
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 className="text-sm font-medium text-blue-800 mb-2">ÏãúÌä∏ Íµ¨Ï°∞ ÏïàÎÇ¥</h4>
                <ul className="text-xs text-blue-700 space-y-1">
                  <li>‚Ä¢ AÏó¥: Ïó∞Î≤à, BÏó¥: ÏÇ¨ÏóÖÏû•Î™Ö, CÏó¥: Î∞∞Ï∂úÍµ¨</li>
                  <li>‚Ä¢ D~DDÏó¥: Î∞∞Ï∂úÏãúÏÑ§ 35Í∞ú (ÏãúÏÑ§Î™Ö/Ïö©Îüâ/ÏàòÎüâ 3Ïó¥Ïî©)</li>
                  <li>‚Ä¢ DE~HEÏó¥: Î∞©ÏßÄÏãúÏÑ§ 35Í∞ú (ÏãúÏÑ§Î™Ö/Ïö©Îüâ/ÏàòÎüâ 3Ïó¥Ïî©)</li>
                  <li>‚Ä¢ ÎèôÏùº ÏÇ¨ÏóÖÏû•Ïùò Ïó¨Îü¨ Î∞∞Ï∂úÍµ¨Îäî CÏó¥Ïóê 1,2,3... ÌòïÌÉúÎ°ú Íµ¨Î∂Ñ</li>
                </ul>
              </div>
            </div>
            
            <div className="flex justify-end gap-4 px-6 py-4 bg-gray-50 rounded-b-lg">
              <button
                type="button"
                onClick={() => setIsImportModalOpen(false)}
                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                disabled={isImporting}
              >
                Ï∑®ÏÜå
              </button>
              <button
                type="button"
                onClick={handleImportFromSheet}
                disabled={isImporting || !importSettings.spreadsheetId.trim()}
                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2"
              >
                {isImporting ? (
                  <>
                    <RefreshCw className="w-4 h-4 animate-spin" />
                    Í∞ÄÏ†∏Ïò§Îäî Ï§ë...
                  </>
                ) : (
                  <>
                    <Upload className="w-4 h-4" />
                    Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÏûë
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <ConfirmModal
        isOpen={deleteConfirmOpen}
        onClose={() => {
          setDeleteConfirmOpen(false)
          setPermitToDelete(null)
        }}
        onConfirm={handleDelete}
        title="ÎåÄÍ∏∞ÌïÑÏ¶ù ÏÇ≠Ï†ú ÌôïÏù∏"
        message={`ÎåÄÍ∏∞ÌïÑÏ¶ùÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`}
        confirmText="ÏÇ≠Ï†ú"
        cancelText="Ï∑®ÏÜå"
        variant="danger"
      />
    </AdminLayout>
  )
}