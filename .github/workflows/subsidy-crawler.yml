# ì§€ìì²´ ë³´ì¡°ê¸ˆ ê³µê³  í¬ë¡¤ëŸ¬ ìŠ¤ì¼€ì¤„ëŸ¬
# ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) ì‹¤í–‰

name: Subsidy Announcement Crawler

on:
  # ìŠ¤ì¼€ì¤„ (UTC ê¸°ì¤€ - KSTëŠ” +9ì‹œê°„)
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ 00:00 UTC = 09:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      region_codes:
        description: 'íŠ¹ì • ì§€ìì²´ ì½”ë“œ (ì‰¼í‘œ êµ¬ë¶„, ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''
      force:
        description: 'ì´ë¯¸ ìˆ˜ì§‘ëœ ê³µê³ ë„ ë‹¤ì‹œ ì²˜ë¦¬'
        required: false
        default: 'false'
        type: boolean

env:
  # Vercel ë°°í¬ URL (í”„ë¡œë•ì…˜)
  API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://facility.blueon-iot.com' }}

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ• í˜„ì¬ ì‹œê°„ í‘œì‹œ
        run: |
          echo "â° ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸ” í¬ë¡¤ëŸ¬ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ“¡ í¬ë¡¤ëŸ¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          curl -s "${{ env.API_BASE_URL }}/api/subsidy-crawler" | jq '.'

      - name: ğŸš€ í¬ë¡¤ë§ ê·¸ë£¹ 1 (ì„œìš¸, ë¶€ì‚°, ëŒ€êµ¬)
        id: crawl_group1
        run: |
          echo "ğŸ¤– [ê·¸ë£¹ 1/6] í¬ë¡¤ë§ ì‹œì‘: ì„œìš¸, ë¶€ì‚°, ëŒ€êµ¬"
          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"region_codes": ["11","26","27"], "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ê·¸ë£¹ 1 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… ê·¸ë£¹ 1 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"

      - name: ğŸš€ í¬ë¡¤ë§ ê·¸ë£¹ 2 (ì¸ì²œ, ê´‘ì£¼, ëŒ€ì „)
        id: crawl_group2
        run: |
          echo "ğŸ¤– [ê·¸ë£¹ 2/6] í¬ë¡¤ë§ ì‹œì‘: ì¸ì²œ, ê´‘ì£¼, ëŒ€ì „"
          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"region_codes": ["28","29","30"], "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ê·¸ë£¹ 2 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… ê·¸ë£¹ 2 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"

      - name: ğŸš€ í¬ë¡¤ë§ ê·¸ë£¹ 3 (ìš¸ì‚°, ì„¸ì¢…, ê²½ê¸°)
        id: crawl_group3
        run: |
          echo "ğŸ¤– [ê·¸ë£¹ 3/6] í¬ë¡¤ë§ ì‹œì‘: ìš¸ì‚°, ì„¸ì¢…, ê²½ê¸°"
          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"region_codes": ["31","36","41"], "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ê·¸ë£¹ 3 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… ê·¸ë£¹ 3 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"

      - name: ğŸš€ í¬ë¡¤ë§ ê·¸ë£¹ 4 (ê°•ì›, ì¶©ë¶, ì¶©ë‚¨)
        id: crawl_group4
        run: |
          echo "ğŸ¤– [ê·¸ë£¹ 4/6] í¬ë¡¤ë§ ì‹œì‘: ê°•ì›, ì¶©ë¶, ì¶©ë‚¨"
          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"region_codes": ["51","43","44"], "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ê·¸ë£¹ 4 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… ê·¸ë£¹ 4 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"

      - name: ğŸš€ í¬ë¡¤ë§ ê·¸ë£¹ 5 (ì „ë¶, ì „ë‚¨, ê²½ë¶)
        id: crawl_group5
        run: |
          echo "ğŸ¤– [ê·¸ë£¹ 5/6] í¬ë¡¤ë§ ì‹œì‘: ì „ë¶, ì „ë‚¨, ê²½ë¶"
          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"region_codes": ["52","46","47"], "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ê·¸ë£¹ 5 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… ê·¸ë£¹ 5 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"

      - name: ğŸš€ í¬ë¡¤ë§ ê·¸ë£¹ 6 (ê²½ë‚¨, ì œì£¼)
        id: crawl_group6
        run: |
          echo "ğŸ¤– [ê·¸ë£¹ 6/6] í¬ë¡¤ë§ ì‹œì‘: ê²½ë‚¨, ì œì£¼"
          FORCE="${{ github.event.inputs.force || 'false' }}"
          BODY='{"region_codes": ["48","50"], "force": '$FORCE'}'

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRAWLER_SECRET }}" \
            -d "$BODY" \
            "${{ env.API_BASE_URL }}/api/subsidy-crawler")

          echo "ğŸ“¥ ê·¸ë£¹ 6 ì‘ë‹µ: $RESPONSE"
          SUCCESS=$(echo $RESPONSE | jq -r '.success // false')
          NEW_COUNT=$(echo $RESPONSE | jq -r '.new_announcements // 0')
          RELEVANT_COUNT=$(echo $RESPONSE | jq -r '.relevant_announcements // 0')

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "relevant_count=$RELEVANT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… ê·¸ë£¹ 6 ì™„ë£Œ: ì‹ ê·œ ${NEW_COUNT}ê±´, ê´€ë ¨ ${RELEVANT_COUNT}ê±´"

      - name: ğŸ“Š ê²°ê³¼ ì§‘ê³„
        id: crawl
        run: |
          TOTAL_NEW=$((
            ${{ steps.crawl_group1.outputs.new_count || 0 }} +
            ${{ steps.crawl_group2.outputs.new_count || 0 }} +
            ${{ steps.crawl_group3.outputs.new_count || 0 }} +
            ${{ steps.crawl_group4.outputs.new_count || 0 }} +
            ${{ steps.crawl_group5.outputs.new_count || 0 }} +
            ${{ steps.crawl_group6.outputs.new_count || 0 }}
          ))
          TOTAL_RELEVANT=$((
            ${{ steps.crawl_group1.outputs.relevant_count || 0 }} +
            ${{ steps.crawl_group2.outputs.relevant_count || 0 }} +
            ${{ steps.crawl_group3.outputs.relevant_count || 0 }} +
            ${{ steps.crawl_group4.outputs.relevant_count || 0 }} +
            ${{ steps.crawl_group5.outputs.relevant_count || 0 }} +
            ${{ steps.crawl_group6.outputs.relevant_count || 0 }}
          ))

          echo "success=true" >> $GITHUB_OUTPUT
          echo "new_count=$TOTAL_NEW" >> $GITHUB_OUTPUT
          echo "relevant_count=$TOTAL_RELEVANT" >> $GITHUB_OUTPUT

          echo "âœ… ì „ì²´ í¬ë¡¤ë§ ì™„ë£Œ"
          echo "ğŸ“Š ì´ ì‹ ê·œ ê³µê³ : ${TOTAL_NEW}ê±´"
          echo "ğŸ¯ ì´ ê´€ë ¨ ê³µê³ : ${TOTAL_RELEVANT}ê±´"

      - name: ğŸ“¬ ì•Œë¦¼ ë°œì†¡ (ê´€ë ¨ ê³µê³  ë°œê²¬ ì‹œ)
        if: steps.crawl.outputs.relevant_count > 0
        run: |
          echo "ğŸ”” ìƒˆë¡œìš´ ê´€ë ¨ ê³µê³  ë°œê²¬!"
          echo "ğŸ“Š ê´€ë ¨ ê³µê³  ìˆ˜: ${{ steps.crawl.outputs.relevant_count }}ê±´"

          # Slack ì›¹í›… (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸš¨ *ì§€ìì²´ ë³´ì¡°ê¸ˆ ê³µê³  ì•Œë¦¼*\nìƒˆë¡œìš´ IoT ì§€ì›ì‚¬ì—… ê´€ë ¨ ê³µê³  ${{ steps.crawl.outputs.relevant_count }}ê±´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ í™•ì¸í•˜ê¸°: ${{ env.API_BASE_URL }}/admin/subsidy\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

      - name: ğŸ“‹ ì‹¤í–‰ ìš”ì•½
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“‹ í¬ë¡¤ë§ ì‹¤í–‰ ìš”ì•½"
          echo "=================================="
          echo "â° ì™„ë£Œ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          echo "âœ… ì„±ê³µ ì—¬ë¶€: ${{ steps.crawl.outputs.success }}"
          echo "ğŸ“Š ì‹ ê·œ ê³µê³ : ${{ steps.crawl.outputs.new_count }}ê±´"
          echo "ğŸ¯ ê´€ë ¨ ê³µê³ : ${{ steps.crawl.outputs.relevant_count }}ê±´"
          echo "=================================="
