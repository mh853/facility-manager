# 영업비용 계산 기준 변경

## 변경 일자
2025-11-06

## 변경 이유
영업비용(수수료) 계산 시 추가공사비를 포함하지 않고, 협의사항(할인금액)만 반영된 금액을 기준으로 계산하도록 수정

## 변경 내용

### 기존 로직
```typescript
// 최종 매출 = 기본 매출 + 추가공사비 - 협의사항
const adjustedRevenue = totalRevenue + additionalCost - negotiationDiscount;

// 영업비용 = 최종 매출 × 수수료율
if (commissionSettings.commission_type === 'percentage') {
  salesCommission = adjustedRevenue * (commissionSettings.commission_percentage / 100);
}
```

**계산 예시 (기존):**
- 기본 매출: 10,000,000원
- 추가공사비: 500,000원
- 협의사항(할인): -1,000,000원
- 수수료율: 10%
- **영업비용 = (10,000,000 + 500,000 - 1,000,000) × 10% = 950,000원**

### 변경된 로직
```typescript
// 영업비용 계산 기준: 기본 매출 - 협의사항 (추가공사비 제외)
const commissionBaseRevenue = totalRevenue - negotiationDiscount;

// 최종 매출 = 기본 매출 + 추가공사비 - 협의사항 (표시용)
const adjustedRevenue = totalRevenue + additionalCost - negotiationDiscount;

// 영업비용 = 수수료 계산 기준 금액 × 수수료율
if (commissionSettings.commission_type === 'percentage') {
  salesCommission = commissionBaseRevenue * (commissionSettings.commission_percentage / 100);
}
```

**계산 예시 (변경 후):**
- 기본 매출: 10,000,000원
- 추가공사비: 500,000원
- 협의사항(할인): -1,000,000원
- 수수료율: 10%
- **영업비용 = (10,000,000 - 1,000,000) × 10% = 900,000원**
- 최종 매출: 9,500,000원 (표시용)

## 영향을 받는 파일

### 1. API 로직 (서버 계산)
- `app/api/revenue/calculate/route.ts` (라인 443-464)
  - 새 변수 `commissionBaseRevenue` 추가
  - 영업비용 계산 시 `commissionBaseRevenue` 사용
  - 로그 메시지 업데이트

### 2. 재계산 API
- `app/api/revenue/recalculate/route.ts` (라인 122-164)
  - 즉시 계산 실행 기능 추가
  - 내부적으로 `/api/revenue/calculate` 호출

### 3. 프론트엔드 계산 로직
- `app/admin/revenue/page.tsx` (라인 411-477)
  - `calculateBusinessRevenue` 함수 수정
  - 새 변수 `commissionBaseRevenue` 추가 (기본 매출 - 협의사항)
  - 세 곳의 영업비용 계산을 `commissionBaseRevenue`로 변경
  - 로그 메시지에 계산기준 추가
  - ⚠️ 백엔드와 동일한 계산 방식 적용 (추가공사비, 추가설치비 제외)

### 4. 표시 컴포넌트
- `components/business/BusinessRevenueModal.tsx` - 변경 없음 (표시만)

## 변경 사항 요약

### 핵심 변경
| 항목 | 기존 | 변경 후 |
|------|------|---------|
| 영업비용 계산 기준 | 기본 매출 + 추가공사비 - 협의사항 | 기본 매출 - 협의사항 |
| 추가공사비 영향 | ✅ 포함 | ❌ 제외 |
| 추가설치비 영향 | ✅ 포함 (프론트엔드) | ❌ 제외 |
| 협의사항(할인) 영향 | ✅ 반영 | ✅ 반영 |
| 최종 매출 계산 | 변경 없음 | 변경 없음 |
| 프론트/백엔드 일치 | ❌ 불일치 | ✅ 일치 |

### 비즈니스 영향
- **영업비용 감소**: 추가공사비가 있는 경우 영업비용이 감소
- **순이익 증가**: 영업비용 감소로 인해 순이익 증가
- **기존 데이터**: 기존 저장된 계산 결과는 재계산 필요

## 테스트 시나리오

### 시나리오 1: 추가공사비 있는 경우
```
기본 매출: 10,000,000원
추가공사비: 500,000원
협의사항: -1,000,000원
수수료율: 10%

[변경 전]
영업비용 = (10,000,000 + 500,000 - 1,000,000) × 10% = 950,000원
최종 매출 = 9,500,000원

[변경 후]
영업비용 = (10,000,000 - 1,000,000) × 10% = 900,000원
최종 매출 = 9,500,000원
차이: 영업비용 -50,000원 감소 → 순이익 +50,000원 증가
```

### 시나리오 2: 추가공사비 없는 경우
```
기본 매출: 10,000,000원
추가공사비: 0원
협의사항: -1,000,000원
수수료율: 10%

[변경 전]
영업비용 = (10,000,000 + 0 - 1,000,000) × 10% = 900,000원

[변경 후]
영업비용 = (10,000,000 - 1,000,000) × 10% = 900,000원
차이: 없음 (동일)
```

### 시나리오 3: 협의사항 없는 경우
```
기본 매출: 10,000,000원
추가공사비: 500,000원
협의사항: 0원
수수료율: 10%

[변경 전]
영업비용 = (10,000,000 + 500,000 - 0) × 10% = 1,050,000원

[변경 후]
영업비용 = (10,000,000 - 0) × 10% = 1,000,000원
차이: 영업비용 -50,000원 감소 → 순이익 +50,000원 증가
```

## 검증 방법

### 1. API 호출 테스트
```bash
# 매출 계산 API 호출
POST /api/revenue/calculate
{
  "business_id": "사업장ID",
  "save_result": false
}

# 응답 확인
{
  "success": true,
  "data": {
    "total_revenue": 9500000,        // 최종 매출
    "sales_commission": 900000,      // 영업비용 (변경됨)
    "net_profit": ...                // 순이익 (증가)
  }
}
```

### 2. 콘솔 로그 확인
```
💰 [REVENUE-CALCULATE] 매출 조정: 기본 10000000 + 추가공사비 500000 - 협의사항 1000000 = 9500000
💰 [REVENUE-CALCULATE] 영업비용 계산 기준: 기본 10000000 - 협의사항 1000000 = 9000000 (추가공사비 제외)
💰 [COMMISSION] 퍼센트 방식: 9000000 × 10% = 900000
```

### 3. UI 확인
- 매출관리 페이지 (`/admin/revenue`)에서 영업비용 표시 확인
- 사업장 상세 모달에서 영업비용 표시 확인

## 주의사항

1. **기존 계산 결과와 차이 발생**
   - 추가공사비가 있는 사업장의 영업비용이 감소
   - 순이익이 증가하므로 긍정적 변경

2. **재계산 필요 여부 검토**
   - 기존 저장된 계산 결과를 재계산할지 결정 필요
   - `/api/revenue/recalculate` API를 사용하여 일괄 재계산 가능

3. **대당 수수료 방식은 영향 없음**
   - 대당 수수료 방식은 기기 개수 기준이므로 변경 없음

4. **협의사항은 계속 반영**
   - 협의사항(할인)은 영업비용 계산에 계속 반영됨
   - 할인이 클수록 영업비용도 감소

## 배포 체크리스트

- [x] 코드 변경 완료
- [x] 컴파일 오류 없음
- [x] 로그 메시지 추가
- [ ] 실제 데이터로 테스트
- [ ] 사용자 확인 받기
- [ ] 기존 데이터 재계산 여부 결정
- [ ] Git 커밋 및 배포

## 관련 이슈

- 영업비용 계산 기준 명확화 요청
- 추가공사비와 영업비용 관계 분리
