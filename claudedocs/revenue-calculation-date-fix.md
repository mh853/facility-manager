# 매출 계산일 수정 가이드

## 문제 상황

### 발견된 문제
- **미계산 일괄 계산** 실행 후 430건이 모두 **2024-12-16**으로 계산됨
- **월마감 페이지**에서 12월에 430건이 집중됨
- **실제**: 각 사업장의 설치일은 1월~12월까지 다양함

### 원인
`/api/revenue/calculate` API가 **현재 날짜(`calculation_date`)**를 기준으로 계산하고 있었음:

```typescript
// 이전 로직 (문제)
const calcDate = calculation_date || new Date().toISOString().split('T')[0];
// → 명시적 날짜가 없으면 현재 날짜(2024-12-16) 사용
```

## 해결 방안

### 1. API 로직 수정 ✅

**파일**: `/app/api/revenue/calculate/route.ts`

**변경 내용**:
```typescript
// 계산일 결정 우선순위:
// 1. 명시적으로 전달된 calculation_date
// 2. 사업장의 설치완료일 (completion_date)
// 3. 사업장의 설치일 (installation_date)
// 4. 현재 날짜
const calcDate = calculation_date
  || businessInfo.completion_date
  || businessInfo.installation_date
  || new Date().toISOString().split('T')[0];
```

**효과**:
- ✅ 앞으로 계산되는 모든 사업장은 **설치일 기준**으로 자동 계산
- ✅ 설치일이 없는 경우에만 현재 날짜 사용
- ✅ 월마감 데이터가 **정확한 설치월**에 분류됨

---

### 2. 기존 데이터 재계산 스크립트 ✅

**파일**: `/scripts/fix-revenue-calculation-dates.js`

**기능**:
1. 2024-12-16으로 계산된 모든 사업장 조회
2. 각 사업장의 실제 설치일 확인
3. 설치일 기준으로 재계산
4. 결과 통계 출력

---

## 실행 방법

### Step 1: 서버 준비
서버가 실행 중이어야 합니다:

```bash
npm run dev
# 또는
npm start
```

### Step 2: 스크립트 실행

**새 터미널 창**에서:

```bash
node scripts/fix-revenue-calculation-dates.js
```

### Step 3: 진행 상황 확인

스크립트는 실시간으로 진행 상황을 출력합니다:

```
🚀 매출 계산일 수정 스크립트 시작

1️⃣ 2024-12-16으로 계산된 사업장 조회 중...
   → 발견: 430건

2️⃣ 사업장별 설치일 기준 재계산 시작...

   ✅ 가나다 사업장: 2024-12-16 → 2024-03-15
   ✅ 나다라 사업장: 2024-12-16 → 2024-05-20
   ⏭️ 다라마 사업장: 설치일 정보 없음 (건너뜀)
   ✅ 라마바 사업장: 2024-12-16 → 2024-08-10
   ...

==================================================
📊 재계산 완료 결과

✅ 성공: 400건
❌ 실패: 5건
⏭️ 건너뜀: 25건 (설치일 없음)
📋 총: 430건
==================================================
```

### Step 4: 결과 검증

#### 4-1. 월마감 페이지 확인
`http://localhost:3000/admin/monthly-closing`

**확인 사항**:
- 12월 건수가 감소했는가?
- 각 월에 사업장이 적절히 분산되었는가?
- 총 건수는 여전히 430건인가?

#### 4-2. 데이터베이스 확인 (선택)

```sql
-- 월별 분포 확인
SELECT
  TO_CHAR(calculation_date, 'YYYY-MM') as month,
  COUNT(*) as count
FROM revenue_calculations
GROUP BY TO_CHAR(calculation_date, 'YYYY-MM')
ORDER BY month DESC;
```

**예상 결과**:
```
   month   | count
-----------+-------
 2024-12   |   45  (실제 12월 설치 사업장만)
 2024-11   |   38
 2024-10   |   52
 2024-09   |   41
 ...
```

---

## 예상 결과

### Before (문제 상황)
```
월별 분포:
- 2024-12: 430건 ❌ (모두 12월에 집중)
- 2024-11: 0건
- 2024-10: 0건
...
```

### After (수정 후)
```
월별 분포:
- 2024-12: 45건 ✅ (실제 12월 설치만)
- 2024-11: 38건 ✅
- 2024-10: 52건 ✅
- 2024-09: 41건 ✅
...
```

---

## 주의사항

### 1. 설치일이 없는 사업장
- **현상**: "설치일 정보 없음 (건너뜀)" 메시지
- **해결**: 해당 사업장의 설치일을 수동으로 입력 후 개별 재계산

### 2. 스크립트 실행 시간
- **예상 시간**: 430건 × 100ms = **약 43초~1분**
- **서버 부하**: 순차 처리로 안전하게 진행

### 3. 스크립트 재실행 가능
- 이미 올바른 날짜로 계산된 사업장은 자동으로 건너뜀
- 안전하게 여러 번 실행 가능

---

## 트러블슈팅

### 문제 1: "사업장 정보 없음" 오류
**원인**: business_id가 잘못되었거나 삭제된 사업장
**해결**: 해당 revenue_calculations 레코드 확인 필요

### 문제 2: "재계산 실패" 메시지
**원인**: API 권한, 데이터 불완전, 서버 오류
**해결**:
1. 서버 로그 확인 (`/tmp/dev-server.log`)
2. 브라우저에서 해당 사업장 개별 계산 시도
3. 오류 메시지 확인 후 데이터 보완

### 문제 3: 스크립트가 중간에 멈춤
**원인**: 서버 다운, 네트워크 오류
**해결**: 스크립트 재실행 (이미 완료된 건은 건너뜀)

---

## 향후 예방

### API 수정 완료 ✅
앞으로 계산되는 모든 사업장은 자동으로 **설치일 기준**으로 계산됩니다.

### 새로운 계산 흐름
```
사업장 추가 → 설치일 입력 → 매출 계산
                    ↓
          자동으로 설치일 기준 계산 ✅
                    ↓
          월마감에 정확한 월로 분류 ✅
```

### 권장 워크플로우
1. **사업장 생성** 시 설치일 필수 입력
2. **매출 계산** 실행 (자동으로 설치일 기준)
3. **월마감 페이지**에서 정확한 월별 통계 확인

---

## 체크리스트

### 수정 전 확인
- [ ] 서버가 실행 중인가?
- [ ] `.env.local` 파일이 있는가?
- [ ] Supabase 연결이 정상인가?

### 수정 후 확인
- [ ] 스크립트가 성공적으로 완료되었는가?
- [ ] 월마감 페이지에서 데이터가 분산되었는가?
- [ ] 12월 건수가 적정 수준으로 감소했는가?
- [ ] 총 건수가 여전히 유지되는가?

### 장기 모니터링
- [ ] 신규 계산 시 설치일 기준으로 저장되는가?
- [ ] 월마감 통계가 정확하게 집계되는가?
- [ ] 설치일 없는 사업장은 별도 관리되는가?

---

## 요약

| 항목 | 내용 |
|------|------|
| **문제** | 미계산 일괄 계산 시 모든 사업장이 12월로 분류됨 |
| **원인** | API가 현재 날짜 기준으로 계산 |
| **해결** | API 수정 + 기존 데이터 재계산 |
| **실행** | `node scripts/fix-revenue-calculation-dates.js` |
| **결과** | 각 사업장이 실제 설치월에 정확히 분류됨 ✅ |
| **소요시간** | 약 1분 |
| **향후** | 자동으로 설치일 기준 계산 |

---

## 다음 단계

1. ✅ **즉시 실행**: 스크립트로 기존 430건 재계산
2. ✅ **결과 확인**: 월마감 페이지에서 월별 분포 검증
3. 🔄 **모니터링**: 신규 계산이 올바르게 작동하는지 확인
4. 📝 **문서화**: 팀원에게 변경 사항 공유
