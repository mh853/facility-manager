# 측정기기 관리 기능 구현 완료

## 개요

견적서 미리보기 모달에서 대기배출시설 허가증의 측정기기를 입력/수정/삭제할 수 있는 기능을 구현했습니다.

## 구현 내용

### 1. 측정기기 선택 옵션

**배출시설 측정기기:**
- 전류계

**방지시설 측정기기:**
- PH계
- 차압계
- 온도계
- 전류계(송풍)
- 전류계(펌프)

### 2. UI 기능

#### 보기 모드
- 대기배출시설 허가증 섹션에 "측정기기 편집" 버튼 표시
- 배출시설/방지시설 테이블에 측정기기 컬럼 표시
- 측정기기 형식: `전류계(2개), PH계(1개)` 형태로 표시

#### 편집 모드
- "측정기기 편집" 버튼 클릭 시 편집 모드 진입
- 각 시설별로 측정기기 추가/수정/삭제 가능
- 드롭다운에서 측정기기 종류 선택
- 수량 입력 (최소 1개)
- "× 버튼으로 측정기기 삭제
- "+ 측정기기 추가" 버튼으로 새 측정기기 추가
- "저장" 버튼으로 데이터베이스에 저장
- "취소" 버튼으로 변경사항 취소

### 3. 테이블 컬럼 크기 통일

배출시설과 방지시설 테이블의 컬럼 크기를 통일했습니다:

| 컬럼명 | 너비 |
|--------|------|
| 시설번호 | 8% |
| 시설명 | 30% |
| 용량 | 18% |
| 수량 | 10% |
| 측정기기 | 34% |

### 4. API 구현

**파일:** `app/api/air-permit/update/route.ts`

**엔드포인트:** `POST /api/air-permit/update`

**기능:**
1. 사용자 인증 확인
2. 사업장의 대기필증 정보 조회
3. 배출시설의 `additional_info.measuring_devices` 업데이트
4. 방지시설의 `additional_info.measuring_devices` 업데이트
5. 성공/실패 결과 반환

**요청 본문:**
```json
{
  "business_id": "uuid",
  "air_permit": {
    "business_type": "제조업",
    "category": "4종",
    "first_report_date": "2020-01-15",
    "operation_start_date": "2020-02-01",
    "emission_facilities": [
      {
        "facility_number": 1,
        "name": "소각로",
        "capacity": "50kg/hr",
        "quantity": 1,
        "green_link_code": "ABC-123",
        "measuring_devices": [
          { "device_name": "전류계", "quantity": 2 }
        ]
      }
    ],
    "prevention_facilities": [
      {
        "facility_number": 1,
        "name": "전기집진기",
        "capacity": "1000m³/hr",
        "quantity": 1,
        "green_link_code": "DEF-456",
        "measuring_devices": [
          { "device_name": "PH계", "quantity": 1 },
          { "device_name": "차압계", "quantity": 1 }
        ]
      }
    ]
  }
}
```

### 5. PDF 생성

**파일:** `app/admin/document-automation/components/EstimatePreviewModal.tsx`

**함수:** `addAirPermitToPdf` (lines 528-635)

**기능:**
- 대기배출시설 허가증을 별도 페이지로 PDF에 추가
- 배출시설/방지시설 테이블에 측정기기 컬럼 포함
- 측정기기 형식: `전류계(2개), PH계(1개)` 형태로 표시

## 데이터 구조

### discharge_facilities.additional_info
```json
{
  "measuring_devices": [
    { "device_name": "전류계", "quantity": 2 }
  ]
}
```

### prevention_facilities.additional_info
```json
{
  "measuring_devices": [
    { "device_name": "PH계", "quantity": 1 },
    { "device_name": "차압계", "quantity": 1 },
    { "device_name": "전류계(송풍)", "quantity": 2 }
  ]
}
```

## 구현 파일 목록

### 신규 생성
- `app/api/air-permit/update/route.ts` - 측정기기 저장 API

### 수정
- `app/admin/document-automation/components/EstimatePreviewModal.tsx`
  - Lines 83-93: 측정기기 옵션 정의
  - Lines 108-109: 편집 상태 관리
  - Lines 156-281: CRUD 함수 (추가/수정/삭제/저장)
  - Lines 885-915: 편집 모드 UI 컨트롤
  - Lines 938-1011: 배출시설 테이블 (편집 모드 포함)
  - Lines 1014-1087: 방지시설 테이블 (편집 모드 포함)
  - Lines 528-635: PDF 생성 (측정기기 포함)

## 사용 방법

1. **견적서 미리보기 열기**
   - 문서자동화 > 견적서 관리 > "보기" 버튼 클릭

2. **측정기기 편집**
   - 대기배출시설 허가증 섹션의 "측정기기 편집" 버튼 클릭
   - 각 시설에서 "+ 측정기기 추가" 버튼으로 측정기기 추가
   - 드롭다운에서 측정기기 종류 선택, 수량 입력
   - "×" 버튼으로 불필요한 측정기기 삭제
   - "저장" 버튼으로 데이터베이스에 저장

3. **PDF 다운로드**
   - "견적서 다운로드" 버튼 클릭
   - PDF 2페이지에 대기배출시설 허가증 포함
   - 측정기기 정보가 테이블에 표시됨

## 테스트 시나리오

### 시나리오 1: 측정기기 추가
1. 견적서 미리보기 열기
2. "측정기기 편집" 클릭
3. 배출시설 1번의 "+ 측정기기 추가" 클릭
4. 드롭다운에서 "전류계" 선택, 수량 2 입력
5. "저장" 클릭
6. 성공 메시지 확인: "측정기기 정보가 저장되었습니다."

### 시나리오 2: 측정기기 수정
1. 편집 모드 진입
2. 기존 측정기기의 수량 변경 (예: 2 → 3)
3. "저장" 클릭
4. 페이지 새로고침 후 변경사항 확인

### 시나리오 3: 측정기기 삭제
1. 편집 모드 진입
2. 측정기기의 "×" 버튼 클릭
3. "저장" 클릭
4. 해당 측정기기가 삭제됨

### 시나리오 4: PDF 다운로드
1. 견적서 미리보기에서 "견적서 다운로드" 클릭
2. PDF 파일 열기
3. 2페이지에 대기배출시설 허가증 확인
4. 배출시설/방지시설 테이블의 측정기기 컬럼 확인

## 주의사항

1. **권한**: 인증된 사용자만 측정기기 편집 가능
2. **필수 필드**: 측정기기 이름과 수량은 필수 입력
3. **최소 수량**: 측정기기 수량은 최소 1개 이상
4. **저장 필수**: "저장" 버튼을 눌러야 데이터베이스에 반영됨
5. **취소 기능**: "취소" 버튼 클릭 시 모든 변경사항 취소됨

## 완료 체크리스트

- ✅ 측정기기 선택 옵션 정의 (배출: 전류계 / 방지: PH계, 차압계, 온도계, 전류계(송풍), 전류계(펌프))
- ✅ 상태 관리 추가 (editingPermit, editedAirPermit)
- ✅ CRUD 함수 구현 (add, update, remove, save)
- ✅ 편집 모드 UI 구현 (드롭다운 + 수량 입력 + 삭제 버튼)
- ✅ 테이블 컬럼 크기 통일 (8% | 30% | 18% | 10% | 34%)
- ✅ 측정기기 저장 API 구현 (`/api/air-permit/update`)
- ✅ PDF 생성 시 측정기기 포함 확인

## 다음 단계

사용자가 직접 테스트하여 기능이 정상 작동하는지 확인해주세요:
1. 견적서 미리보기에서 측정기기 추가/수정/삭제
2. 저장 후 데이터베이스 확인
3. PDF 다운로드 후 측정기기 표시 확인
