'use client';

// VERSION: 2025-09-11-08-27-CACHE-BUST-v4 üî•üî•üî•
// üö® EMERGENCY CACHE INVALIDATION - FORCE BROWSER RELOAD
// LAST MODIFIED: 2025-09-11T09:15:00Z - FORCE BROWSER RELOAD

import React, { useState, useCallback, useEffect, useRef, forwardRef } from 'react';
import { Camera, Upload, Factory, Shield, Building2, AlertCircle, Eye, Download, Trash2, RefreshCw, X, Zap, Router, Cpu, Plus, Grid, List, ChevronLeft, ChevronRight, Archive } from 'lucide-react';
import { FacilitiesData, Facility, UploadedFile } from '@/types';
import { createFacilityPhotoTracker, FacilityPhotoInfo, FacilityPhoto } from '@/utils/facility-photo-tracker';
import LazyImage from '@/components/ui/LazyImage';
import { useToast } from '@/contexts/ToastContext';
import { useFileContext } from '@/contexts/FileContext';
import { useAtom, useAtomValue, useSetAtom } from 'jotai';
import { deletedPhotoIdsAtom, deletePhotoAtom, undeletePhotoAtom, clearDeletedPhotosAtom } from '../stores/photo-atoms';

interface ImprovedFacilityPhotoSectionProps {
  businessName: string;
  facilities: FacilitiesData | null;
}

type ViewMode = 'grid' | 'list';

// Performance-optimized animated counter component
function AnimatedCounter({ value, duration = 1000, className = "" }: { 
  value: number; 
  duration?: number; 
  className?: string;
}) {
  const [displayValue, setDisplayValue] = useState(0);
  const [isAnimating, setIsAnimating] = useState(false);
  const rafRef = useRef<number>();
  const startTimeRef = useRef<number>();
  const startValueRef = useRef<number>(0);

  useEffect(() => {
    if (value === displayValue) return;

    setIsAnimating(true);
    startValueRef.current = displayValue;
    startTimeRef.current = performance.now();

    const animate = (currentTime: number) => {
      const elapsed = currentTime - startTimeRef.current!;
      const progress = Math.min(elapsed / duration, 1);
      
      // Smooth easing function for natural animation
      const easeOutCubic = 1 - Math.pow(1 - progress, 3);
      
      const currentValue = Math.round(
        startValueRef.current + (value - startValueRef.current) * easeOutCubic
      );

      setDisplayValue(currentValue);

      if (progress < 1) {
        rafRef.current = requestAnimationFrame(animate);
      } else {
        setIsAnimating(false);
      }
    };

    rafRef.current = requestAnimationFrame(animate);

    return () => {
      if (rafRef.current) {
        cancelAnimationFrame(rafRef.current);
      }
    };
  }, [value, duration, displayValue]);

  return (
    <span className={`${className} ${isAnimating ? 'text-opacity-90' : ''} transition-opacity duration-200`}>
      {displayValue}
    </span>
  );
}

// Helper functions for user-friendly messages
const getUserFriendlyErrorMessage = (serverMessage: string): string => {
  if (serverMessage.includes('ÌååÏùºÎ™Ö: undefined') || serverMessage.includes('files')) {
    return 'ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌååÏùºÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.';
  }
  if (serverMessage.includes('network') || serverMessage.includes('connection')) {
    return 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Ïù¥ Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
  }
  if (serverMessage.includes('size') || serverMessage.includes('Ïö©Îüâ')) {
    return 'ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. Îçî ÏûëÏùÄ ÌååÏùºÎ°ú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
  }
  if (serverMessage.includes('format') || serverMessage.includes('ÌòïÏãù')) {
    return 'ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§. JPG, PNG ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.';
  }
  if (serverMessage.includes('permission') || serverMessage.includes('Í∂åÌïú')) {
    return 'ÏóÖÎ°úÎìú Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.';
  }
  if (serverMessage.includes('storage') || serverMessage.includes('Í≥µÍ∞Ñ')) {
    return 'Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.';
  }
  
  // Í∏∞Î≥∏ ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å Î©îÏãúÏßÄ
  return 'ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
};

const getCategoryDisplayName = (category: string): string => {
  switch (category) {
    case 'gateway': return 'Í≤åÏù¥Ìä∏Ïõ®Ïù¥';
    case 'fan': return 'ÏÜ°ÌíçÌå¨';
    case 'others': return 'Í∏∞ÌÉÄ';
    default: return category;
  }
};

export default function ImprovedFacilityPhotoSection({ 
  businessName, 
  facilities 
}: ImprovedFacilityPhotoSectionProps) {
  const toast = useToast();
  const { addFiles } = useFileContext();
  const [uploading, setUploading] = useState<{ [key: string]: boolean }>({});
  const [uploadProgress, setUploadProgress] = useState<{ [key: string]: number }>({});
  
  // Individual file upload tracking and cancellation
  const [fileUploadStates, setFileUploadStates] = useState<{ 
    [fileId: string]: {
      status: 'waiting' | 'uploading' | 'success' | 'error';
      progress: number;
      fileName: string;
      error?: string;
      abortController?: AbortController;
      previewUrl?: string;
    }
  }>({});
  
  const [activeUploads, setActiveUploads] = useState<Set<string>>(new Set());
  const [isDeletingPhoto, setIsDeletingPhoto] = useState<boolean>(false);
  
  // üîß JotaiÎ•º ÏÇ¨Ïö©Ìïú ÏÇ≠Ï†úÎêú ÏÇ¨ÏßÑ ID Ï∂îÏ†Å (Ï¶âÏãú UI Ïà®ÍπÄÏö©)
  const deletedPhotoIds = useAtomValue(deletedPhotoIdsAtom);
  const markPhotoAsDeleted = useSetAtom(deletePhotoAtom);
  const markPhotoAsUndeleted = useSetAtom(undeletePhotoAtom); // Î°§Î∞±Ïö©
  const clearDeletedPhotos = useSetAtom(clearDeletedPhotosAtom);
  
  console.log('üîß [DEBUG-SCOPE] markPhotoAsDeleted Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏóàÏäµÎãàÎã§:', !!markPhotoAsDeleted);

  // üö®üö®üö® EMERGENCY CACHE INVALIDATION TEST
  console.log(`üî•üî•üî• [EMERGENCY-CACHE-TEST] Í∏¥Í∏â Ï∫êÏãú Î¨¥Ìö®Ìôî ÌÖåÏä§Ìä∏ - Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ïù¥ Î©îÏãúÏßÄÎ•º Î≥¥Í≥† ÏûàÎã§Î©¥ ÏÑ±Í≥µ!`, {
    timestamp: new Date().toISOString(),
    version: 'EMERGENCY-v4-2025-09-11-08-27',
    deletedPhotoIds: deletedPhotoIds.size,
    location: window.location.href,
    userAgent: navigator.userAgent.substring(0, 50)
  });
  
  // üö® Ï∂îÍ∞Ä Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú ÌôïÏù∏
  if (typeof window !== 'undefined') {
    console.log(`üåê [BROWSER-INFO] Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤Ω ÌôïÏù∏Îê®:`, {
      url: window.location.href,
      protocol: window.location.protocol,
      port: window.location.port
    });
  }
  
  // üì∑ JotaiÎ°ú ÌïÑÌÑ∞ÎßÅÎêú ÏÇ¨ÏßÑ Î™©Î°ùÏùÑ ÏÉùÏÑ±ÌïòÎäî Ìï®Ïàò
  const getFilteredPhotos = useCallback((originalPhotos: FacilityPhoto[]) => {
    console.log(`üîç [FILTER-DEBUG] ÏõêÎ≥∏: ${originalPhotos.length}Ïû•, ÏÇ≠Ï†úÎê®: ${deletedPhotoIds.size}Ïû•, ÏÇ≠Ï†úIDÎì§:`, Array.from(deletedPhotoIds));
    const filtered = originalPhotos.filter(photo => !deletedPhotoIds.has(photo.id));
    console.log(`‚úÖ [FILTER-RESULT] ${originalPhotos.length}Ïû• ‚Üí ${filtered.length}Ïû• ÌïÑÌÑ∞ÎßÅ ÏôÑÎ£å`);
    return filtered;
  }, [deletedPhotoIds]);

  // üîß Ïã§ÏãúÍ∞Ñ Jotai ÏÉÅÌÉú Î≥ÄÌôî Ï∂îÏ†Å
  useEffect(() => {
    console.log(`üîß [JOTAI-STATE-CHANGE] deletedPhotoIds ÏóÖÎç∞Ïù¥Ìä∏Îê®:`, {
      count: deletedPhotoIds.size,
      ids: Array.from(deletedPhotoIds),
      timestamp: Date.now()
    });
  }, [deletedPhotoIds]);
  
  // Sophisticated drag-and-drop state management
  const [dragStates, setDragStates] = useState<{
    [zoneId: string]: {
      isDragOver: boolean;
      dragDepth: number;
      isValidDrag: boolean;
      draggedFileCount: number;
    }
  }>({});
  
  const [globalDragActive, setGlobalDragActive] = useState(false);
  
  // Auto-refresh with highlighting for new photos
  const [recentPhotoIds, setRecentPhotoIds] = useState<Set<string>>(new Set());
  const [lastRefreshTime, setLastRefreshTime] = useState<Date>(new Date());
  const [photoTracker] = useState(() => createFacilityPhotoTracker(businessName));
  const [loadingFiles, setLoadingFiles] = useState(true);
  const [selectedPhoto, setSelectedPhoto] = useState<FacilityPhoto | null>(null);
  const [modalPosition, setModalPosition] = useState<{ x: number; y: number } | null>(null);
  const [viewMode, setViewMode] = useState<ViewMode>('grid');
  const [expandedFacilities, setExpandedFacilities] = useState<Set<string>>(new Set());
  const [statistics, setStatistics] = useState({
    totalFacilities: 0,
    totalPhotos: 0,
    dischargeFacilities: 0,
    preventionFacilities: 0,
    basicCategories: 0
  });
  const modalRef = useRef<HTMLDivElement>(null);

  // ÏóÖÎ°úÎìúÎêú ÌååÏùº Î°úÎìú Î∞è Ï∂îÏ†ÅÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉà ÏÇ¨ÏßÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìè¨Ìï®)
  const loadUploadedFiles = useCallback(async (forceRefresh = false, highlightNew = false) => {
    if (!businessName) return;
    
    setLoadingFiles(true);
    try {
      const refreshParam = forceRefresh ? '&refresh=true' : '';
      const response = await fetch(`/api/facility-photos?businessName=${encodeURIComponent(businessName)}${refreshParam}`);
      
      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data) {
          const newFiles = result.data.files || [];
          
          // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÏÇ¨ÏßÑ Í∞êÏßÄ (ÌïòÏù¥ÎùºÏù¥Ìä∏Ïö©)
          if (highlightNew) {
            const currentFacilities = photoTracker.getAllFacilities();
            const currentPhotos = currentFacilities.flatMap(facility => facility.photos);
            const currentPhotoIds = new Set(currentPhotos.map(p => p.id));
            const newPhotoIds = new Set<string>();
            
            newFiles.forEach((file: any) => {
              if (!currentPhotoIds.has(file.id)) {
                newPhotoIds.add(file.id);
              }
            });
            
            if (newPhotoIds.size > 0) {
              setRecentPhotoIds(newPhotoIds);
              console.log(`‚ú® [NEW-PHOTOS] ${newPhotoIds.size}Ïû•Ïùò ÏÉà ÏÇ¨ÏßÑÏù¥ Î∞úÍ≤¨ÎêòÏñ¥ ÌïòÏù¥ÎùºÏù¥Ìä∏Îê©ÎãàÎã§.`);
              
              // 5Ï¥à ÌõÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
              setTimeout(() => {
                setRecentPhotoIds(new Set());
              }, 5000);
            }
          }
          
          // Ï∂îÏ†ÅÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
          console.log('üîç [DEBUG] API ÏùëÎãµ ÌååÏùºÎì§:', newFiles);
          photoTracker.buildFromUploadedFiles(newFiles);
          
          // Î™®Îì† ÏãúÏÑ§Ïùò ÏÇ¨ÏßÑÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú Ìï©ÏπòÍ∏∞
          const allFacilities = photoTracker.getAllFacilities();
          const allPhotos = allFacilities.flatMap(facility => facility.photos);
          console.log('üîç [DEBUG] photoTracker ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ:', allPhotos);
          
          // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏)
          setStatistics(photoTracker.getStatistics());
          setLastRefreshTime(new Date());
          
          console.log('üìä [PHOTO-TRACKER] ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å:', photoTracker.getStatistics());
        }
      }
    } catch (error) {
      console.error('ÌååÏùº Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
    } finally {
      setLoadingFiles(false);
    }
  }, [businessName, photoTracker]);

  useEffect(() => {
    loadUploadedFiles();
  }, [loadUploadedFiles]);

  // Î∞±Í∑∏ÎùºÏö¥Îìú ÏÉàÎ°úÍ≥†Ïπ® (ÏÉà ÏÇ¨ÏßÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìè¨Ìï®)
  useEffect(() => {
    const interval = setInterval(() => {
      loadUploadedFiles(true, true); // Î∞±Í∑∏ÎùºÏö¥Îìú ÏÉàÎ°úÍ≥†Ïπ® Ïãú ÏÉà ÏÇ¨ÏßÑ ÌïòÏù¥ÎùºÏù¥Ìä∏
    }, 30000); // 30Ï¥àÎ°ú Îã®Ï∂ïÌïòÏó¨ Îçî ÎπàÎ≤àÌïú ÏóÖÎç∞Ïù¥Ìä∏

    return () => clearInterval(interval);
  }, [loadUploadedFiles]);

  // Cleanup preview URLs on unmount
  useEffect(() => {
    return () => {
      Object.values(fileUploadStates).forEach(state => {
        if (state.previewUrl) {
          URL.revokeObjectURL(state.previewUrl);
        }
      });
    };
  }, []);

  // Individual file upload management
  const cancelFileUpload = useCallback((fileId: string) => {
    const fileState = fileUploadStates[fileId];
    if (fileState?.abortController) {
      fileState.abortController.abort();
    }
    
    // ÎØ∏Î¶¨Î≥¥Í∏∞ URL Ï†ïÎ¶¨
    if (fileState?.previewUrl) {
      URL.revokeObjectURL(fileState.previewUrl);
    }
    
    setFileUploadStates(prev => ({
      ...prev,
      [fileId]: {
        ...prev[fileId],
        status: 'error',
        error: 'ÏóÖÎ°úÎìúÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.',
        previewUrl: undefined
      }
    }));
    
    setActiveUploads(prev => {
      const newSet = new Set(prev);
      newSet.delete(fileId);
      return newSet;
    });
    
    toast.info('ÏóÖÎ°úÎìú Ï∑®ÏÜåÎê®', `${fileState?.fileName || 'ÌååÏùº'}Ïùò ÏóÖÎ°úÎìúÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.`);
  }, [fileUploadStates, toast]);
  
  const retryFileUpload = useCallback(async (fileId: string, uploadFunction: () => Promise<void>) => {
    setFileUploadStates(prev => ({
      ...prev,
      [fileId]: {
        ...prev[fileId],
        status: 'waiting',
        error: undefined
      }
    }));
    
    try {
      await uploadFunction();
    } catch (error) {
      console.error('Retry failed:', error);
    }
  }, []);
  
  const clearCompletedUploads = useCallback(() => {
    setFileUploadStates(prev => {
      const newStates: typeof prev = {};
      Object.keys(prev).forEach(fileId => {
        if (prev[fileId].status === 'uploading' || prev[fileId].status === 'waiting') {
          newStates[fileId] = prev[fileId];
        } else {
          // ÏôÑÎ£åÎêú ÏóÖÎ°úÎìúÏùò ÎØ∏Î¶¨Î≥¥Í∏∞ URL Ï†ïÎ¶¨
          if (prev[fileId].previewUrl) {
            URL.revokeObjectURL(prev[fileId].previewUrl);
          }
        }
      });
      return newStates;
    });
  }, []);

  // Sophisticated drag-and-drop handlers
  const createDragHandlers = (zoneId: string, onDrop: (files: FileList) => void) => {
    const updateDragState = (updates: Partial<typeof dragStates[string]>) => {
      setDragStates(prev => ({
        ...prev,
        [zoneId]: { ...prev[zoneId], ...updates }
      }));
    };

    const validateDraggedFiles = (dataTransfer: DataTransfer): { isValid: boolean; fileCount: number } => {
      const items = Array.from(dataTransfer.items || []);
      const files = items.filter(item => item.kind === 'file' && item.type.startsWith('image/'));
      return { isValid: files.length > 0, fileCount: files.length };
    };

    return {
      onDragEnter: (e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        
        const { isValid, fileCount } = validateDraggedFiles(e.dataTransfer);
        
        setGlobalDragActive(true);
        updateDragState({
          isDragOver: true,
          dragDepth: (dragStates[zoneId]?.dragDepth || 0) + 1,
          isValidDrag: isValid,
          draggedFileCount: fileCount
        });
      },

      onDragLeave: (e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        
        const newDepth = (dragStates[zoneId]?.dragDepth || 1) - 1;
        
        if (newDepth <= 0) {
          updateDragState({
            isDragOver: false,
            dragDepth: 0,
            isValidDrag: false,
            draggedFileCount: 0
          });
          
          // Check if any other zones are active
          const hasOtherActiveZones = Object.entries(dragStates).some(([id, state]) => 
            id !== zoneId && state.isDragOver
          );
          if (!hasOtherActiveZones) {
            setGlobalDragActive(false);
          }
        } else {
          updateDragState({ dragDepth: newDepth });
        }
      },

      onDragOver: (e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        
        const { isValid, fileCount } = validateDraggedFiles(e.dataTransfer);
        updateDragState({ isValidDrag: isValid, draggedFileCount: fileCount });
      },

      onDrop: (e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        
        setGlobalDragActive(false);
        updateDragState({
          isDragOver: false,
          dragDepth: 0,
          isValidDrag: false,
          draggedFileCount: 0
        });

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
          if (imageFiles.length > 0) {
            const dataTransfer = new DataTransfer();
            imageFiles.forEach(file => dataTransfer.items.add(file));
            onDrop(dataTransfer.files);
          }
        }
      }
    };
  };

  const getDragZoneStyles = (zoneId: string, baseStyles: string = '') => {
    const dragState = dragStates[zoneId];
    if (!dragState?.isDragOver) return baseStyles;

    const validDragStyles = dragState.isValidDrag 
      ? 'border-green-400 bg-green-50 ring-2 ring-green-200 shadow-lg transform scale-[1.02]'
      : 'border-red-400 bg-red-50 ring-2 ring-red-200 shadow-lg';

    return `${baseStyles} ${validDragStyles} transition-all duration-200 ease-out`;
  };

  // Global drag overlay for sophisticated visual feedback
  const DragOverlay = () => {
    if (!globalDragActive) return null;

    return (
      <div className="fixed inset-0 bg-blue-500/10 backdrop-blur-sm z-40 pointer-events-none">
        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-md rounded-lg shadow-lg px-4 py-2">
          <div className="flex items-center gap-2 text-sm font-medium text-blue-600">
            <Upload className="w-4 h-4 animate-bounce" />
            Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï† ÏòÅÏó≠ÏúºÎ°ú ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî
          </div>
        </div>
      </div>
    );
  };

  // ÏãúÏÑ§Î≥Ñ ÌååÏùº ÏóÖÎ°úÎìú
  const handleFacilityUpload = useCallback(async (
    files: FileList, 
    facilityType: 'discharge' | 'prevention',
    facility: Facility,
    instanceIndex: number = 1
  ) => {
    if (!files.length) return;

    const uploadKey = `${facilityType}-${facility.outlet}-${facility.number}-${instanceIndex}`;
    
    setUploading(prev => ({ ...prev, [uploadKey]: true }));
    setUploadProgress(prev => ({ ...prev, [uploadKey]: 0 }));

    // Initialize individual file states with improved uniqueness
    const fileIds: string[] = [];
    const newFileStates: { [key: string]: any } = {};
    
    // üîß Î™®Îì† ÌååÏùº Ï†ïÎ≥¥Î•º Î®ºÏ†Ä Ï§ÄÎπÑ (Î∞∞Ïπò Ï≤òÎ¶¨Î•º ÏúÑÌï¥)
    Array.from(files).forEach((file, index) => {
      // üîß Îçî Í∞ïÎ†•Ìïú Í≥†Ïú†ÏÑ± Î≥¥Ïû• - ÏãúÍ∞Ñ, Ïù∏Îç±Ïä§, ÌååÏùºÏ†ïÎ≥¥ Ï°∞Ìï©
      const timestamp = Date.now().toString(36);
      const performanceTime = performance.now().toString(36);
      const randomSuffix = Math.random().toString(36).substring(2, 15);
      const fileHash = `${file.name}-${file.size}-${file.lastModified}`.replace(/[^a-zA-Z0-9]/g, '_');
      const fileId = `${uploadKey}-${index}-${timestamp}-${performanceTime}-${fileHash}-${randomSuffix}`;
      fileIds.push(fileId);
      
      // üñºÔ∏è Í∞Å ÌååÏùºÎ≥Ñ Í≥†Ïú† ÎØ∏Î¶¨Î≥¥Í∏∞ URL ÏÉùÏÑ± - File Í∞ùÏ≤¥Î•º ÏßÅÏ†ë ÏÇ¨Ïö©ÌïòÏó¨ Í≥†Ïú†ÏÑ± Î≥¥Ïû•
      const previewUrl = file.type.startsWith('image/') ? URL.createObjectURL(file) : undefined;
      
      // üêõ ÎîîÎ≤ÑÍπÖ: ÎØ∏Î¶¨Î≥¥Í∏∞ URL Ï∂îÏ†Å (Í∞Å ÌååÏùºÎ≥Ñ Í≥†Ïú†ÏÑ± ÌôïÏù∏)
      console.log(`üñºÔ∏è [PREVIEW-DEBUG-${index}] ÌååÏùºÏ†ïÎ≥¥:`, {
        fileName: file.name,
        fileSize: file.size,
        lastModified: file.lastModified,
        fileId,
        previewUrl: previewUrl?.substring(0, 50) + '...',
        type: file.type,
        timestamp,
        performanceTime
      });
      
      // ÏÉàÎ°úÏö¥ ÏÉÅÌÉúÎ•º ÎØ∏Î¶¨ Ï§ÄÎπÑ
      newFileStates[fileId] = {
        status: 'waiting' as const,
        progress: 0,
        fileName: file.name,
        abortController: new AbortController(),
        previewUrl
      };
    });
    
    // üîß Î™®Îì† ÌååÏùº ÏÉÅÌÉúÎ•º Ìïú Î≤àÏóê ÏóÖÎç∞Ïù¥Ìä∏ (Î∞∞Ïπò Ï≤òÎ¶¨Î°ú ÏÉÅÌÉú Í≤ΩÏüÅ Ï°∞Í±¥ Î∞©ÏßÄ)
    setFileUploadStates(prev => {
      const updatedState = {
        ...prev,
        ...newFileStates
      };
      console.log(`üéØ [BATCH-STATE-UPDATE] ${fileIds.length}Í∞ú ÌååÏùº ÏÉÅÌÉú Î∞∞Ïπò ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`, {
        fileIds,
        stateKeys: Object.keys(newFileStates)
      });
      return updatedState;
    });

    // Process files individually with cancellation support
    // üîß Î∞∞Ïπò ÏóÖÎ°úÎìúÎ°ú Î≥ÄÍ≤Ω - Î™®Îì† ÌååÏùºÏùÑ ÌïòÎÇòÏùò ÏöîÏ≤≠ÏúºÎ°ú Ï≤òÎ¶¨
    console.log(`üì¶ [BATCH-UPLOAD-START] ${files.length}Ïû•Ïùò ÌååÏùºÏùÑ Î∞∞Ïπò ÏóÖÎ°úÎìú ÏãúÏûë`);
    
    // Î™®Îì† ÌååÏùº ÏÉÅÌÉúÎ•º ÏóÖÎ°úÎìú Ï§ëÏúºÎ°ú ÏÑ§Ï†ï
    setFileUploadStates(prev => {
      const newStates = { ...prev };
      fileIds.forEach(fileId => {
        if (newStates[fileId]) {
          newStates[fileId].status = 'uploading';
        }
      });
      return newStates;
    });

    try {
      const formData = new FormData();
      
      // Î™®Îì† ÌååÏùºÏùÑ ÌïòÎÇòÏùò FormDataÏóê Ï∂îÍ∞Ä
      Array.from(files).forEach(file => {
        formData.append('files', file);
      });
      
      formData.append('businessName', businessName);
      formData.append('facilityType', facilityType);
      formData.append('facilityNumber', facility.number?.toString() || '1');
      formData.append('outletNumber', facility.outlet.toString());

      console.log(`üì§ [BATCH-UPLOAD-REQUEST] Î∞∞Ïπò ÏóÖÎ°úÎìú ÏöîÏ≤≠ Ï†ÑÏÜ°:`, {
        filesCount: files.length,
        facilityType,
        facilityNumber: facility.number,
        outletNumber: facility.outlet
      });

      const response = await fetch('/api/facility-photos', {
        method: 'POST',
        body: formData
      });

      let result: any;
      
      if (response.ok) {
        result = await response.json();
        
        console.log(`üì• [BATCH-UPLOAD-RESPONSE] ÏÑúÎ≤Ñ ÏùëÎãµ:`, result);
        
        if (result.success) {
          console.log(`üéØ [INSTANT-UI-UPDATE] ÏóÖÎ°úÎìú ÏÑ±Í≥µ, Ï¶âÏãú UI Î∞òÏòÅ ÏãúÏûë`, result);
          
          // Î™®Îì† ÌååÏùºÏùÑ ÏÑ±Í≥µ ÏÉÅÌÉúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
          setFileUploadStates(prev => {
            const newStates = { ...prev };
            fileIds.forEach(fileId => {
              if (newStates[fileId]) {
                // ÏÑ±Í≥µ Ïãú ÎØ∏Î¶¨Î≥¥Í∏∞ URL Ï†ïÎ¶¨
                if (newStates[fileId].previewUrl) {
                  URL.revokeObjectURL(newStates[fileId].previewUrl);
                }
                newStates[fileId] = {
                  ...newStates[fileId],
                  status: 'success',
                  progress: 100,
                  previewUrl: undefined
                };
              }
            });
            return newStates;
          });
          
          // üöÄ ÌïµÏã¨ Í∞úÏÑ†: ÏóÖÎ°úÎìú ÏÑ±Í≥µ Ïãú FileContextÏóê Ï¶âÏãú ÌååÏùº Ï∂îÍ∞Ä
          if (result.uploadedFiles && result.uploadedFiles.length > 0) {
            console.log(`‚ûï [INSTANT-ADD] ${result.uploadedFiles.length}Í∞ú ÌååÏùºÏùÑ Ï¶âÏãú UIÏóê Ï∂îÍ∞Ä`);
            addFiles(result.uploadedFiles);
            
            // Ïã§ÏãúÍ∞Ñ ÏÑ±Í≥µ ÏïåÎ¶º (Ìñ•ÏÉÅÎêú Î™®Î∞îÏùº ÏßÄÏõê)
            if (typeof window !== 'undefined') {
              const instantToast = document.createElement('div');
              instantToast.className = 'instant-upload-toast fixed top-16 right-4 bg-gradient-to-r from-green-400 to-blue-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-500 scale-100';
              instantToast.innerHTML = `
                <div class="flex items-center space-x-3">
                  <div class="animate-bounce">üéâ</div>
                  <div>
                    <div class="font-bold text-sm">Ïã§ÏãúÍ∞Ñ ÏóÖÎ°úÎìú!</div>
                    <div class="text-xs opacity-90">${result.uploadedFiles.length}Ïû• Ï¶âÏãú Î∞òÏòÅÎê®</div>
                  </div>
                </div>
              `;
              document.body.appendChild(instantToast);
              
              setTimeout(() => {
                instantToast.style.transform = 'scale(0) translateY(-20px)';
                setTimeout(() => instantToast.remove(), 200);
              }, 2500);
              
              // Î™®Î∞îÏùº ÌñÖÌã± ÌîºÎìúÎ∞±
              if (navigator.vibrate) {
                navigator.vibrate([100, 100, 200]);
              }
            }
          } else {
            console.warn(`‚ö†Ô∏è [NO-FILES-RETURNED] ÏÑúÎ≤ÑÏóêÏÑú uploadedFiles Î∞òÌôòÎêòÏßÄ ÏïäÏùå, Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ® ÏÇ¨Ïö©`);
          }
          
        } else {
          throw new Error(result.message || 'ÏóÖÎ°úÎìú Ïã§Ìå®');
        }
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      // Î™®Îì† ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎê®
      const successCount = files.length;
      console.log(`‚úÖ [UPLOAD-COMPLETE] ${successCount}/${files.length}Ïû• ÏóÖÎ°úÎìú ÏôÑÎ£å`);
      
      // Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ®: result.uploadedFilesÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
      if (!result.uploadedFiles || result.uploadedFiles.length === 0) {
        console.log(`üîÑ [FALLBACK-REFRESH] uploadedFiles ÏóÜÏùå, Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ`);
        await new Promise(resolve => setTimeout(resolve, 200)); // ÏÑúÎ≤Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÎåÄÍ∏∞
        await loadUploadedFiles(true, true);
        console.log(`‚úÖ [FALLBACK-COMPLETE] Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å`);
      } else {
        console.log(`‚ö° [SKIP-REFRESH] Ï¶âÏãú UI Î∞òÏòÅ ÏôÑÎ£å, ÏÉàÎ°úÍ≥†Ïπ® ÏÉùÎûµ`);
      }
      
      // ÏóÖÎ°úÎìú ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
      setUploadProgress(prev => ({ ...prev, [uploadKey]: 100 }));
      
      // ÏÑ±Í≥µ/Ïã§Ìå® ÏïåÎ¶º
      if (successCount === files.length) {
        toast.success(`ÏóÖÎ°úÎìú ÏôÑÎ£å`, `${successCount}Ïû•Ïùò ÏÇ¨ÏßÑÏù¥ Î™®Îëê ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
      } else if (successCount > 0) {
        toast.warning(`Î∂ÄÎ∂Ñ ÏóÖÎ°úÎìú`, `${successCount}/${files.length}Ïû•Ïùò ÏÇ¨ÏßÑÏù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
      } else {
        toast.error(`ÏóÖÎ°úÎìú Ïã§Ìå®`, `Î™®Îì† ÌååÏùºÏùò ÏóÖÎ°úÎìúÍ∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§.`);
      }

    } catch (error: any) {
      console.error('üö® [BATCH-UPLOAD-ERROR] Î∞∞Ïπò ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
      
      // Î™®Îì† ÌååÏùºÏùÑ Ïò§Î•ò ÏÉÅÌÉúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
      setFileUploadStates(prev => {
        const newStates = { ...prev };
        fileIds.forEach(fileId => {
          if (newStates[fileId]) {
            // Ïò§Î•ò Ïãú ÎØ∏Î¶¨Î≥¥Í∏∞ URL Ï†ïÎ¶¨
            if (newStates[fileId].previewUrl) {
              URL.revokeObjectURL(newStates[fileId].previewUrl);
            }
            newStates[fileId] = {
              ...newStates[fileId],
              status: 'error',
              error: error.message || 'ÏóÖÎ°úÎìú Ïã§Ìå®',
              previewUrl: undefined
            };
          }
        });
        return newStates;
      });
      
      // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏóê ÎåÄÌïú ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å Î©îÏãúÏßÄÏôÄ Ïû¨ÏãúÎèÑ
      toast.error(
        'ÏóÖÎ°úÎìú Ïã§Ìå®', 
        `${files.length}Ïû•Ïùò ÏÇ¨ÏßÑ ÏóÖÎ°úÎìúÍ∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`, 
        {
          duration: 0,
          onRetry: () => handleFacilityUpload(files, facilityType, facility, instanceIndex)
        }
      );
    } finally {
      setUploading(prev => ({ ...prev, [uploadKey]: false }));
      setTimeout(() => {
        setUploadProgress(prev => ({ ...prev, [uploadKey]: 0 }));
      }, 2000);
    }
  }, [businessName, loadUploadedFiles]);

  // Í∏∞Î≥∏ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú
  const handleBasicUpload = useCallback(async (files: FileList, category: string) => {
    if (!files.length) return;

    const uploadKey = `basic-${category}`;
    
    setUploading(prev => ({ ...prev, [uploadKey]: true }));
    setUploadProgress(prev => ({ ...prev, [uploadKey]: 0 }));

    try {
      const formData = new FormData();
      
      Array.from(files).forEach(file => {
        formData.append('files', file);
      });
      
      formData.append('businessName', businessName);
      formData.append('facilityType', 'basic');
      formData.append('category', category);

      const response = await fetch('/api/facility-photos', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        console.log(`‚úÖ [BASIC-UPLOAD-SUCCESS] ${category} ${result.data?.uploadedPhotos?.length || 0}Ïû• ÏóÖÎ°úÎìú ÏôÑÎ£å`);
        
        // üöÄ Ï¶âÏãú UI Î∞òÏòÅ: ÏóÖÎ°úÎìúÎêú ÌååÏùºÎì§ÏùÑ Ï¶âÏãú Ï∂îÍ∞Ä
        if (result.data?.uploadedPhotos && result.data.uploadedPhotos.length > 0) {
          console.log(`‚ûï [BASIC-INSTANT-ADD] ${result.data.uploadedPhotos.length}Í∞ú Í∏∞Î≥∏ÏÇ¨ÏßÑÏùÑ Ï¶âÏãú UIÏóê Ï∂îÍ∞Ä`);
          addFiles(result.data.uploadedPhotos);
          
          // Ïã§ÏãúÍ∞Ñ ÏÑ±Í≥µ ÏïåÎ¶º (Í∏∞Î≥∏ÏÇ¨ÏßÑÏö©)
          if (typeof window !== 'undefined') {
            const basicToast = document.createElement('div');
            basicToast.className = 'basic-upload-toast fixed top-16 left-4 bg-gradient-to-r from-purple-400 to-pink-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-500 scale-100';
            basicToast.innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="animate-pulse">üì∑</div>
                <div>
                  <div class="font-bold text-sm">${getCategoryDisplayName(category)} ÏóÖÎ°úÎìú!</div>
                  <div class="text-xs opacity-90">${result.data.uploadedPhotos.length}Ïû• Ï¶âÏãú Î∞òÏòÅ</div>
                </div>
              </div>
            `;
            document.body.appendChild(basicToast);
            
            setTimeout(() => {
              basicToast.style.transform = 'scale(0) translateX(-20px)';
              setTimeout(() => basicToast.remove(), 200);
            }, 2500);
          }
        }
        
        // ‚ö° ÏÑ±Îä• ÏµúÏ†ÅÌôî: Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å
        setUploadProgress(prev => ({ ...prev, [uploadKey]: 100 }));
        
        // Ï°∞Í±¥Î∂Ä Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ®
        if (!result.data?.uploadedPhotos || result.data.uploadedPhotos.length === 0) {
          console.log(`üîÑ [BASIC-FALLBACK] uploadedPhotos ÏóÜÏùå, Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ®`);
          setTimeout(() => {
            loadUploadedFiles(true, true).catch(error => {
              console.warn('Í∏∞Î≥∏ÏÇ¨ÏßÑ Ìè¥Î∞± ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
            });
          }, 100);
        } else {
          console.log(`‚ö° [BASIC-SKIP-REFRESH] Ï¶âÏãú Î∞òÏòÅ ÏôÑÎ£å, ÏÉàÎ°úÍ≥†Ïπ® ÏÉùÎûµ`);
        }
      } else {
        console.error('‚ùå [BASIC-UPLOAD-ERROR]', result.message);
        
        // ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å ÏóêÎü¨ Î©îÏãúÏßÄÏôÄ Ïû¨ÏãúÎèÑ Î≤ÑÌäº
        toast.error(
          'ÏóÖÎ°úÎìú Ïã§Ìå®', 
          getUserFriendlyErrorMessage(result.message), 
          {
            duration: 0,
            onRetry: () => handleBasicUpload(files, category)
          }
        );
      }

    } catch (error) {
      console.error('Í∏∞Î≥∏ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
      
      // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏóê ÎåÄÌïú ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å Î©îÏãúÏßÄ
      toast.error(
        'Ïó∞Í≤∞ Ïò§Î•ò', 
        'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 
        {
          duration: 0,
          onRetry: () => handleBasicUpload(files, category)
        }
      );
    } finally {
      setUploading(prev => ({ ...prev, [uploadKey]: false }));
      setTimeout(() => {
        setUploadProgress(prev => ({ ...prev, [uploadKey]: 0 }));
      }, 2000);
    }
  }, [businessName, loadUploadedFiles]);

  // üîß Í∞úÏÑ†Îêú ÏÇ¨ÏßÑ ÏÇ≠Ï†ú - Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ + Î∞±Í∑∏ÎùºÏö¥Îìú ÎèôÍ∏∞Ìôî + Î°§Î∞± Ï≤òÎ¶¨
  const deletePhoto = useCallback(async (photo: FacilityPhoto) => {
    console.log('üö® [DEBUG] deletePhoto Ìï®ÏàòÍ∞Ä Ìò∏Ï∂úÎêòÏóàÏäµÎãàÎã§!', photo);
    if (!confirm(`"${photo.originalFileName}" ÌååÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
      console.log('üö´ [DEBUG] ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†úÎ•º Ï∑®ÏÜåÌñàÏäµÎãàÎã§');
      return;
    }

    try {
      console.log(`üî•üî•üî• [DELETE-FUNCTION-CALLED] ${photo.fileName} (ID: ${photo.id}) ÏÉàÎ°úÏö¥ ÏÇ≠Ï†ú Ìï®Ïàò Ìò∏Ï∂úÎê®! üî•üî•üî•`);
      console.log(`üöÄ [DELETE-START] ${photo.fileName} (ID: ${photo.id}) ÏÇ≠Ï†ú ÏãúÏûë`);
      
      // üö® ÏÇ≠Ï†ú ÏûëÏóÖ ÏãúÏûë - Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ï∞®Îã®
      setIsDeletingPhoto(true);
      console.log(`üîí [DELETE-LOCK] ÏÇ≠Ï†ú ÏûëÏóÖ Ï§ë Î™®Îã¨ Ïû†Í∏à ÌôúÏÑ±Ìôî - HOT RELOAD TEST`);
      
      // 1Ô∏è‚É£ Ï¶âÏãú UIÏóêÏÑú ÏÇ¨ÏßÑ Ïà®Í∏∞Í∏∞ (Jotai ÏÇ¨Ïö©)
      markPhotoAsDeleted(photo.id);
      console.log(`‚ö° [INSTANT-DELETE] ${photo.fileName} - markPhotoAsDeleted Ìò∏Ï∂úÏôÑÎ£å`);
      
      // 2Ô∏è‚É£ ÏÉÅÌÉú Î≥ÄÍ≤Ω ÌôïÏù∏ÏùÑ ÏúÑÌïú ÏïΩÍ∞ÑÏùò ÏßÄÏó∞
      await new Promise(resolve => setTimeout(resolve, 100));
      console.log(`üîÑ [UI-SYNC] Jotai ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ UI Î¶¨Î†åÎçîÎßÅ ÎåÄÍ∏∞`);
      
      // ‚úÖ ÏÉÅÏÑ∏Î≥¥Í∏∞ Ï∞Ω Ïú†ÏßÄ - Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå (ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Í∞úÏÑ†)
      console.log(`üëÅÔ∏è [MODAL-KEEP] ÏÉÅÏÑ∏Î≥¥Í∏∞ Ï∞Ω Ïú†ÏßÄ - ÏÇ≠Ï†ú ÌõÑÏóêÎèÑ Í≥ÑÏÜç ÏÇ¨Ïö© Í∞ÄÎä•`);
      // setSelectedPhoto(null);   // Ï£ºÏÑù Ï≤òÎ¶¨ - Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå
      // setModalPosition(null);   // Ï£ºÏÑù Ï≤òÎ¶¨ - Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå
      
      // 3Ô∏è‚É£ ÏÑ±Í≥µ Î©îÏãúÏßÄÎäî Ï¶âÏãú ÌëúÏãú
      toast.success('ÏÇ≠Ï†ú ÏôÑÎ£å', 'ÏÇ¨ÏßÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
      
      // üö® ÏÇ≠Ï†ú ÏûëÏóÖ ÏôÑÎ£å - Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ï∞®Îã® Ìï¥Ï†ú
      setIsDeletingPhoto(false);
      console.log(`üîì [DELETE-UNLOCK] ÏÇ≠Ï†ú ÏûëÏóÖ ÏôÑÎ£å - Î™®Îã¨ Ïû†Í∏à Ìï¥Ï†ú`);
      
      // 4Ô∏è‚É£ Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Ïã§Ï†ú API ÏÇ≠Ï†ú ÏàòÌñâ (ÏÇ¨Ïö©ÏûêÎäî Í∏∞Îã§Î¶¨ÏßÄ ÏïäÏùå)
      const response = await fetch('/api/facility-photos', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          photoId: photo.id, 
          businessName: businessName
        })
      });

      const result = await response.json();
      
      if (!result.success) {
        // üîÑ API ÏÇ≠Ï†ú Ïã§Ìå® Ïãú Î°§Î∞±
        console.error('‚ùå [DELETE-API-FAILED]', result.message);
        
        // JotaiÏóêÏÑú ÏÇ≠Ï†ú ÏÉÅÌÉú Î°§Î∞±
        markPhotoAsUndeleted(photo.id);
        
        // photoTrackerÏóêÏÑúÎèÑ Î°§Î∞± (Ï†ÑÏ≤¥ ÏÉàÎ°úÍ≥†Ïπ®ÏúºÎ°ú Ï≤òÎ¶¨)
        loadUploadedFiles(true, false).catch(error => {
          console.warn('Î°§Î∞± ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
        });
        
        toast.error('ÏÇ≠Ï†ú Ïã§Ìå®', getUserFriendlyErrorMessage(result.message));
      } else {
        console.log(`‚úÖ [DELETE-API-SUCCESS] ${photo.fileName} ÏÑúÎ≤ÑÏóêÏÑúÎèÑ ÏÇ≠Ï†ú ÏôÑÎ£å`);
      }
      
    } catch (error) {
      console.error('ÏÇ¨ÏßÑ ÏÇ≠Ï†ú API Ïò§Î•ò:', error);
      
      // üö® ÏÇ≠Ï†ú Ïã§Ìå® ÏãúÏóêÎèÑ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ï∞®Îã® Ìï¥Ï†ú
      setIsDeletingPhoto(false);
      console.log(`üîì [DELETE-UNLOCK-ERROR] ÏÇ≠Ï†ú Ïã§Ìå® - Î™®Îã¨ Ïû†Í∏à Ìï¥Ï†ú`);
      
      // üîÑ API Ïò§Î•ò ÏãúÏóêÎèÑ Î°§Î∞± Ï≤òÎ¶¨
      markPhotoAsUndeleted(photo.id);
      
      loadUploadedFiles(true, false).catch(refreshError => {
        console.warn('Ïò§Î•ò Î≥µÍµ¨ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', refreshError);
      });
      
      toast.error('ÏÇ≠Ï†ú Ïò§Î•ò', 'ÏÇ¨ÏßÑ ÏÇ≠Ï†ú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
    }
  }, [businessName, markPhotoAsDeleted, markPhotoAsUndeleted, photoTracker, toast, loadUploadedFiles]);

  // ÏÇ¨ÏßÑ ÏÑ†ÌÉù Î™®Îã¨
  const handlePhotoSelect = useCallback((photo: FacilityPhoto, event: React.MouseEvent) => {
    event.stopPropagation();
    
    const target = event.currentTarget as HTMLElement;
    const rect = target.getBoundingClientRect();
    
    const centerX = rect.left + rect.width / 2 + 50;
    const centerY = rect.top + rect.height / 2;
    
    const modalWidth = 600;
    const modalHeight = 500;
    
    const adjustedX = Math.min(Math.max(centerX - modalWidth/2, 20), window.innerWidth - modalWidth - 20);
    const adjustedY = Math.min(Math.max(centerY - modalHeight/2, 20), window.innerHeight - modalHeight - 20);
    
    setModalPosition({ x: adjustedX, y: adjustedY });
    setSelectedPhoto(photo);
  }, []);

  // ÏãúÏÑ§ ÌôïÏû•/Ï∂ïÏÜå
  const toggleFacilityExpansion = useCallback((facilityKey: string) => {
    setExpandedFacilities(prev => {
      const newSet = new Set(prev);
      if (newSet.has(facilityKey)) {
        newSet.delete(facilityKey);
      } else {
        newSet.add(facilityKey);
      }
      return newSet;
    });
  }, []);

  // ÌÇ§Î≥¥Îìú Î∞è Î™®Îã¨ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === 'Escape' && selectedPhoto) {
        console.log(`üîë [ESC-KEY] ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞ - ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë Ï¢ÖÎ£å`);
        setSelectedPhoto(null);
        setModalPosition(null);
      }
    };

    const handleClickOutside = (event: MouseEvent) => {
      // üö® ÏÇ≠Ï†ú ÏûëÏóÖ Ï§ëÏùº ÎïåÎäî Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå
      if (isDeletingPhoto) {
        console.log(`üö´ [CLICK-OUTSIDE-BLOCKED] ÏÇ≠Ï†ú ÏûëÏóÖ Ï§ë - Ïô∏Î∂Ä ÌÅ¥Î¶≠ Î¨¥Ïãú`);
        return;
      }
      
      if (modalRef.current && !modalRef.current.contains(event.target as Node)) {
        console.log(`üñ±Ô∏è [CLICK-OUTSIDE] Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Î™®Îã¨ Îã´Í∏∞`);
        setSelectedPhoto(null);
        setModalPosition(null);
      }
    };

    if (selectedPhoto) {
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [selectedPhoto, isDeletingPhoto]);

  if (!facilities) {
    return (
      <div className="bg-white/95 backdrop-blur-sm rounded-xl p-6 shadow-xl border-2 border-gray-200/80">
        <div className="flex items-center gap-3 mb-6">
          <div className="p-2 bg-gray-100 rounded-lg">
            <Camera className="w-6 h-6 text-gray-600" />
          </div>
          <h2 className="text-xl font-bold text-gray-800">ÏãúÏÑ§Î≥Ñ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨</h2>
        </div>
        <div className="text-center py-8">
          <AlertCircle className="w-12 h-12 text-gray-300 mx-auto mb-3" />
          <p className="text-gray-600">ÏãúÏÑ§ Ï†ïÎ≥¥Î•º Î®ºÏ†Ä Î∂àÎü¨ÏôÄÏ£ºÏÑ∏Ïöî.</p>
        </div>
      </div>
    );
  }

  // ÏãúÏÑ§Î≥Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  const dischargeFacilities = photoTracker.getDischargeFacilities();
  const preventionFacilities = photoTracker.getPreventionFacilities();
  const basicFacilities = photoTracker.getBasicFacilities();

  // Î∞∞Ï∂úÍµ¨Î≥Ñ ÏãúÏÑ§ Í∑∏Î£πÌôî
  const facilitiesByOutlet = () => {
    const grouped: { [outlet: number]: { discharge: Facility[], prevention: Facility[] } } = {};
    
    if (!facilities || !facilities.discharge || !facilities.prevention) {
      return grouped;
    }
    
    facilities.discharge.forEach(facility => {
      if (!grouped[facility.outlet]) {
        grouped[facility.outlet] = { discharge: [], prevention: [] };
      }
      grouped[facility.outlet].discharge.push(facility);
    });
    
    facilities.prevention.forEach(facility => {
      if (!grouped[facility.outlet]) {
        grouped[facility.outlet] = { discharge: [], prevention: [] };
      }
      grouped[facility.outlet].prevention.push(facility);
    });
    
    return grouped;
  };

  const outletFacilities = facilitiesByOutlet();
  const outlets = Object.keys(outletFacilities).map(Number).sort((a, b) => a - b);

  // Individual file upload status component
  const FileUploadStatus = ({ fileStates }: { fileStates: typeof fileUploadStates }) => {
    const activeFiles = Object.entries(fileStates).filter(([_, state]) => 
      state.status === 'uploading' || state.status === 'waiting' || state.status === 'error'
    );

    if (activeFiles.length === 0) return null;

    return (
      <div className="mb-4 bg-gray-50 rounded-lg p-4">
        <div className="flex items-center justify-between mb-3">
          <h4 className="font-medium text-gray-800">ÌååÏùº ÏóÖÎ°úÎìú ÏÉÅÌÉú</h4>
          <button
            onClick={clearCompletedUploads}
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            ÏôÑÎ£åÎêú Ìï≠Î™© Ï†ïÎ¶¨
          </button>
        </div>
        <div className="space-y-2 max-h-48 overflow-y-auto">
          {activeFiles.map(([fileId, state]) => (
            <div key={fileId} className="flex items-center gap-3 p-2 bg-white rounded border">
              {/* Preview image - üîß Í∞Å ÌååÏùºÎ≥Ñ Í≥†Ïú† ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú */}
              {state.previewUrl ? (
                <img 
                  src={state.previewUrl} 
                  alt={state.fileName}
                  className="w-12 h-12 object-cover rounded border flex-shrink-0"
                />
              ) : (
                <div className="w-12 h-12 bg-gray-200 rounded border flex-shrink-0 flex items-center justify-center">
                  <span className="text-xs text-gray-500">üìÑ</span>
                </div>
              )}
              
              {/* Status indicator */}
              <div className={`w-3 h-3 rounded-full flex-shrink-0 ${
                state.status === 'uploading' ? 'bg-blue-500 animate-pulse' :
                state.status === 'waiting' ? 'bg-yellow-500' :
                state.status === 'success' ? 'bg-green-500' :
                'bg-red-500'
              }`} />
              
              {/* File info */}
              <div className="flex-1 min-w-0">
                <div className="text-sm font-medium text-gray-900 truncate">
                  {state.fileName}
                </div>
                <div className="text-xs text-gray-500">
                  {state.status === 'uploading' ? `ÏóÖÎ°úÎìú Ï§ë... ${state.progress}%` :
                   state.status === 'waiting' ? 'ÎåÄÍ∏∞ Ï§ë' :
                   state.status === 'success' ? 'ÏôÑÎ£å' :
                   state.error || 'Ïã§Ìå®'}
                </div>
              </div>

              {/* Action buttons */}
              <div className="flex gap-1">
                {state.status === 'uploading' && (
                  <button
                    onClick={() => cancelFileUpload(fileId)}
                    className="p-1 text-red-500 hover:text-red-700 rounded"
                    title="Ï∑®ÏÜå"
                  >
                    <X className="w-4 h-4" />
                  </button>
                )}
                {state.status === 'error' && (
                  <button
                    onClick={() => retryFileUpload(fileId, () => Promise.resolve())}
                    className="p-1 text-blue-500 hover:text-blue-700 rounded"
                    title="Ïû¨ÏãúÎèÑ"
                  >
                    <RefreshCw className="w-4 h-4" />
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <>
      {/* Global drag overlay */}
      <DragOverlay />
      
      <div className="bg-white/95 backdrop-blur-sm rounded-xl p-6 shadow-xl border-2 border-gray-200/80">
        {/* File upload status tracker */}
        <FileUploadStatus fileStates={fileUploadStates} />
      
      {/* Ìó§Îçî */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 rounded-lg">
            <Camera className="w-6 h-6 text-purple-600" />
          </div>
          <div>
            <h2 className="text-xl font-bold text-gray-800">ÏãúÏÑ§Î≥Ñ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨</h2>
            <p className="text-sm text-gray-600">
              Ï¥ù {statistics.totalFacilities}Í∞ú ÏãúÏÑ§, {statistics.totalPhotos}Ïû•Ïùò ÏÇ¨ÏßÑ
            </p>
          </div>
        </div>

        {/* Ïª®Ìä∏Î°§ Î≤ÑÌäº */}
        <div className="flex items-center gap-2">
          {/* Î∑∞ Î™®Îìú ÌÜ†Í∏Ä */}
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setViewMode('grid')}
              className={`p-2 rounded ${viewMode === 'grid' ? 'bg-white shadow' : ''}`}
            >
              <Grid className="w-4 h-4" />
            </button>
            <button
              onClick={() => setViewMode('list')}
              className={`p-2 rounded ${viewMode === 'list' ? 'bg-white shadow' : ''}`}
            >
              <List className="w-4 h-4" />
            </button>
          </div>

          <button
            onClick={() => loadUploadedFiles(true)}
            disabled={loadingFiles}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
          >
            <RefreshCw className={`w-4 h-4 ${loadingFiles ? 'animate-spin' : ''}`} />
            ÏÉàÎ°úÍ≥†Ïπ®
          </button>
        </div>
      </div>

      {/* ÌÜµÍ≥Ñ ÎåÄÏãúÎ≥¥Îìú */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-6">
        <div className="bg-orange-50 p-2 md:p-4 rounded-lg border border-orange-200 hover:bg-orange-100 hover:border-orange-300 transition-all duration-200 transform hover:scale-105">
          <div className="flex items-center gap-2">
            <Factory className="w-5 h-5 text-orange-600" />
            <span className="font-medium text-orange-800">Î∞∞Ï∂úÏãúÏÑ§</span>
          </div>
          <div className="text-2xl font-bold text-orange-900">
            <AnimatedCounter 
              value={statistics.dischargeFacilities} 
              duration={800} 
              className="inline-block" 
            />
          </div>
        </div>

        <div className="bg-green-50 p-2 md:p-4 rounded-lg border border-green-200 hover:bg-green-100 hover:border-green-300 transition-all duration-200 transform hover:scale-105">
          <div className="flex items-center gap-2">
            <Shield className="w-5 h-5 text-green-600" />
            <span className="font-medium text-green-800">Î∞©ÏßÄÏãúÏÑ§</span>
          </div>
          <div className="text-2xl font-bold text-green-900">
            <AnimatedCounter 
              value={statistics.preventionFacilities} 
              duration={800} 
              className="inline-block" 
            />
          </div>
        </div>

        <div className="bg-blue-50 p-2 md:p-4 rounded-lg border border-blue-200 hover:bg-blue-100 hover:border-blue-300 transition-all duration-200 transform hover:scale-105">
          <div className="flex items-center gap-2">
            <Building2 className="w-5 h-5 text-blue-600" />
            <span className="font-medium text-blue-800">Í∏∞Î≥∏ÏÇ¨ÏßÑ</span>
          </div>
          <div className="text-2xl font-bold text-blue-900">
            <AnimatedCounter 
              value={statistics.basicCategories} 
              duration={800} 
              className="inline-block" 
            />
          </div>
        </div>

        <div className="bg-purple-50 p-2 md:p-4 rounded-lg border border-purple-200 hover:bg-purple-100 hover:border-purple-300 transition-all duration-200 transform hover:scale-105">
          <div className="flex items-center gap-2">
            <Camera className="w-5 h-5 text-purple-600" />
            <span className="font-medium text-purple-800">Ï¥ù ÏÇ¨ÏßÑ</span>
          </div>
          <div className="text-2xl font-bold text-purple-900">
            <AnimatedCounter 
              value={statistics.totalPhotos} 
              duration={1000} 
              className="inline-block" 
            />
          </div>
        </div>
      </div>

      <div className="space-y-3 md:space-y-6">
        {/* Î∞∞Ï∂úÍµ¨Î≥Ñ ÏãúÏÑ§ */}
        {outlets.map(outlet => {
          const outletData = outletFacilities[outlet];
          const outletPrevention = outletData.prevention || [];
          const outletDischarge = outletData.discharge || [];
          
          return (
            <div key={outlet} className="bg-white rounded-lg p-3 md:p-4 border border-gray-200">
              <h3 className="text-lg font-semibold text-gray-800 mb-2 md:mb-4 flex items-center gap-2">
                <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                  Î∞∞Ï∂úÍµ¨ {outlet}
                </span>
              </h3>
              
              {/* Î∞©ÏßÄÏãúÏÑ§ */}
              {outletPrevention.length > 0 && (
                <div className="mb-6">
                  <h4 className="text-md font-medium text-green-600 mb-3 flex items-center gap-2">
                    <Shield className="w-4 h-4" />
                    Î∞©ÏßÄÏãúÏÑ§ ({outletPrevention.reduce((total, f) => total + f.quantity, 0)}Í∞ú)
                  </h4>
                  
                  {outletPrevention.map((facility) => 
                    Array.from({ length: facility.quantity }, (_, quantityIndex) => {
                      const instanceIndex = quantityIndex + 1;
                      const uploadKey = `prevention-${facility.outlet}-${facility.number}-${instanceIndex}`;
                      const isUploading = uploading[uploadKey];
                      const progress = uploadProgress[uploadKey] || 0;
                      
                      // Ìï¥Îãπ ÏãúÏÑ§Ïùò ÏÇ¨ÏßÑÎì§ Í∞ÄÏ†∏Ïò§Í∏∞ (JotaiÎ°ú ÏÇ≠Ï†úÎêú ÏÇ¨ÏßÑ ÌïÑÌÑ∞ÎßÅ)
                      const facilityPhotos = getFilteredPhotos(photoTracker.getFacilityPhotos('prevention', facility.number, facility.outlet));
                      console.log(`üîç [DEBUG] Prevention ÏãúÏÑ§ ${facility.number} ÏÇ¨ÏßÑ:`, facilityPhotos);

                      return (
                        <FacilityCard
                          key={`prevention-${facility.outlet}-${facility.number}-${instanceIndex}`}
                          facility={facility}
                          facilityType="prevention"
                          instanceIndex={instanceIndex}
                          isUploading={isUploading}
                          progress={progress}
                          photos={facilityPhotos}
                          onUpload={(files) => handleFacilityUpload(files, 'prevention', facility, instanceIndex)}
                          onPhotoSelect={handlePhotoSelect}
                          viewMode={viewMode}
                          dragHandlers={createDragHandlers(
                            `prevention-${facility.outlet}-${facility.number}-${instanceIndex}`,
                            (files) => handleFacilityUpload(files, 'prevention', facility, instanceIndex)
                          )}
                          dragZoneStyles={getDragZoneStyles}
                          recentPhotoIds={recentPhotoIds}
                          businessName={businessName}
                          loadUploadedFiles={loadUploadedFiles}
                        />
                      );
                    })
                  ).flat()}
                </div>
              )}
              
              {/* Î∞∞Ï∂úÏãúÏÑ§ */}
              {outletDischarge.length > 0 && (
                <div>
                  <h4 className="text-md font-medium text-orange-600 mb-3 flex items-center gap-2">
                    <Factory className="w-4 h-4" />
                    Î∞∞Ï∂úÏãúÏÑ§ ({outletDischarge.reduce((total, f) => total + f.quantity, 0)}Í∞ú)
                  </h4>
                  
                  {outletDischarge.map((facility) => 
                    Array.from({ length: facility.quantity }, (_, quantityIndex) => {
                      const instanceIndex = quantityIndex + 1;
                      const uploadKey = `discharge-${facility.outlet}-${facility.number}-${instanceIndex}`;
                      const isUploading = uploading[uploadKey];
                      const progress = uploadProgress[uploadKey] || 0;
                      
                      // Ìï¥Îãπ ÏãúÏÑ§Ïùò ÏÇ¨ÏßÑÎì§ Í∞ÄÏ†∏Ïò§Í∏∞ (JotaiÎ°ú ÏÇ≠Ï†úÎêú ÏÇ¨ÏßÑ ÌïÑÌÑ∞ÎßÅ)
                      const facilityPhotos = getFilteredPhotos(photoTracker.getFacilityPhotos('discharge', facility.number, facility.outlet));

                      return (
                        <FacilityCard
                          key={`discharge-${facility.outlet}-${facility.number}-${instanceIndex}`}
                          facility={facility}
                          facilityType="discharge"
                          instanceIndex={instanceIndex}
                          isUploading={isUploading}
                          progress={progress}
                          photos={facilityPhotos}
                          onUpload={(files) => handleFacilityUpload(files, 'discharge', facility, instanceIndex)}
                          onPhotoSelect={handlePhotoSelect}
                          viewMode={viewMode}
                          dragHandlers={createDragHandlers(
                            `discharge-${facility.outlet}-${facility.number}-${instanceIndex}`,
                            (files) => handleFacilityUpload(files, 'discharge', facility, instanceIndex)
                          )}
                          dragZoneStyles={getDragZoneStyles}
                          recentPhotoIds={recentPhotoIds}
                          businessName={businessName}
                          loadUploadedFiles={loadUploadedFiles}
                        />
                      );
                    })
                  ).flat()}
                </div>
              )}
            </div>
          );
        })}

        {/* Í∏∞Î≥∏ÏÇ¨ÏßÑ ÏÑπÏÖò */}
        <div className="bg-white rounded-lg p-3 md:p-4 border border-gray-200">
          <h3 className="text-lg font-semibold text-gray-800 mb-3 md:mb-6 flex items-center gap-2">
            <Building2 className="w-5 h-5 text-blue-600" />
            Í∏∞Î≥∏ÏÇ¨ÏßÑ
          </h3>
          
          <div className="space-y-3 md:space-y-6">
            {/* Í≤åÏù¥Ìä∏Ïõ®Ïù¥ */}
            <BasicPhotoCategory
              category="gateway"
              title="Í≤åÏù¥Ìä∏Ïõ®Ïù¥"
              icon={<Router className="w-4 h-4" />}
              color="purple"
              isUploading={uploading['basic-gateway']}
              progress={uploadProgress['basic-gateway'] || 0}
              photos={getFilteredPhotos(photoTracker.getFacilityPhotos('basic', undefined, undefined, 'gateway'))}
              onUpload={(files) => handleBasicUpload(files, 'gateway')}
              onPhotoSelect={handlePhotoSelect}
              viewMode={viewMode}
              dragHandlers={createDragHandlers(
                'basic-gateway',
                (files) => handleBasicUpload(files, 'gateway')
              )}
              dragZoneStyles={getDragZoneStyles}
              recentPhotoIds={recentPhotoIds}
              businessName={businessName}
              loadUploadedFiles={loadUploadedFiles}
            />

            {/* ÏÜ°ÌíçÌå¨ */}
            <BasicPhotoCategory
              category="fan"
              title="ÏÜ°ÌíçÌå¨"
              icon={<Zap className="w-4 h-4" />}
              color="cyan"
              isUploading={uploading['basic-fan']}
              progress={uploadProgress['basic-fan'] || 0}
              photos={getFilteredPhotos(photoTracker.getFacilityPhotos('basic', undefined, undefined, 'fan'))}
              onUpload={(files) => handleBasicUpload(files, 'fan')}
              onPhotoSelect={handlePhotoSelect}
              viewMode={viewMode}
              dragHandlers={createDragHandlers(
                'basic-fan',
                (files) => handleBasicUpload(files, 'fan')
              )}
              dragZoneStyles={getDragZoneStyles}
              recentPhotoIds={recentPhotoIds}
              businessName={businessName}
              loadUploadedFiles={loadUploadedFiles}
            />

            {/* Í∏∞ÌÉÄ */}
            <BasicPhotoCategory
              category="others"
              title="Í∏∞ÌÉÄ"
              icon={<Building2 className="w-4 h-4" />}
              color="gray"
              isUploading={uploading['basic-others']}
              progress={uploadProgress['basic-others'] || 0}
              photos={getFilteredPhotos(photoTracker.getFacilityPhotos('basic', undefined, undefined, 'others'))}
              onUpload={(files) => handleBasicUpload(files, 'others')}
              onPhotoSelect={handlePhotoSelect}
              viewMode={viewMode}
              dragHandlers={createDragHandlers(
                'basic-others',
                (files) => handleBasicUpload(files, 'others')
              )}
              dragZoneStyles={getDragZoneStyles}
              recentPhotoIds={recentPhotoIds}
              businessName={businessName}
              loadUploadedFiles={loadUploadedFiles}
            />
          </div>
        </div>
      </div>

      {/* ÏÇ¨ÏßÑ ÏÉÅÏÑ∏ Î™®Îã¨ */}
      {selectedPhoto && modalPosition && (
        <PhotoDetailModal
          ref={modalRef}
          photo={selectedPhoto}
          position={modalPosition}
          onClose={() => { setSelectedPhoto(null); setModalPosition(null); }}
          onDelete={() => deletePhoto(selectedPhoto)}
        />
      )}
    </div>
    </>
  );
}

// ÏãúÏÑ§ Ïπ¥Îìú Ïª¥Ìè¨ÎÑåÌä∏
interface FacilityCardProps {
  facility: Facility;
  facilityType: 'discharge' | 'prevention';
  instanceIndex: number;
  isUploading: boolean;
  progress: number;
  photos: FacilityPhoto[];
  onUpload: (files: FileList) => void;
  onPhotoSelect: (photo: FacilityPhoto, event: React.MouseEvent) => void;
  viewMode: ViewMode;
  dragHandlers: {
    onDragEnter: (e: React.DragEvent) => void;
    onDragLeave: (e: React.DragEvent) => void;
    onDragOver: (e: React.DragEvent) => void;
    onDrop: (e: React.DragEvent) => void;
  };
  dragZoneStyles: (zoneId: string, baseStyles?: string) => string;
  recentPhotoIds?: Set<string>;
  businessName: string;
  loadUploadedFiles: (forceRefresh?: boolean, highlightNew?: boolean) => Promise<void>;
}

function FacilityCard({ 
  facility, 
  facilityType, 
  instanceIndex, 
  isUploading, 
  progress, 
  photos,
  onUpload,
  onPhotoSelect,
  viewMode,
  dragHandlers,
  dragZoneStyles,
  recentPhotoIds,
  businessName,
  loadUploadedFiles
}: FacilityCardProps) {
  const displayNumber = `${facilityType === 'discharge' ? 'Î∞∞' : 'Î∞©'}${facility.number}${facility.quantity > 1 ? `-${instanceIndex}` : ''}`;
  const colorScheme = facilityType === 'discharge' ? 'orange' : 'green';

  return (
    <div className={`bg-${colorScheme}-50 border border-${colorScheme}-200 rounded-lg p-4 mb-3`}>
      {/* ÏãúÏÑ§ Ï†ïÎ≥¥ */}
      <div className="flex items-center gap-2 mb-3">
        <span className={`bg-${colorScheme}-600 text-white px-2 py-1 rounded text-sm font-medium`}>
          {displayNumber}
        </span>
        <span className="text-gray-600 text-sm">Î∞∞Ï∂úÍµ¨ {facility.outlet}</span>
        {facility.quantity > 1 && (
          <span className={`text-xs bg-${colorScheme}-100 text-${colorScheme}-700 px-2 py-1 rounded`}>
            {instanceIndex}/{facility.quantity}
          </span>
        )}
        <span className={`text-xs bg-${colorScheme}-100 text-${colorScheme}-700 px-2 py-1 rounded ml-auto`}>
          {photos.length}Ïû•
        </span>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <span className="text-sm text-gray-600 font-medium">ÏãúÏÑ§Î™Ö:</span>
          <div className="text-gray-900 font-semibold">{facility.name}</div>
        </div>
        <div>
          <span className="text-sm text-gray-600 font-medium">Ïö©Îüâ:</span>
          <div className="text-gray-900 font-semibold">{facility.capacity}</div>
        </div>
        <div>
          <span className="text-sm text-gray-600 font-medium">ÏàòÎüâ:</span>
          <div className="text-gray-900 font-semibold">{facility.quantity}Í∞ú</div>
        </div>
      </div>

      {/* ÏóÖÎ°úÎìú ÏßÑÌñâÎ•† */}
      {isUploading && (
        <div className="mb-3">
          <div className="flex items-center justify-between text-sm text-gray-600 mb-1">
            <span>ÏóÖÎ°úÎìú Ï§ë...</span>
            <span>{Math.round(progress)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className={`bg-${colorScheme}-600 h-2 rounded-full transition-all duration-300`}
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>
      )}

      {/* ÌååÏùº ÏóÖÎ°úÎìú ÏòÅÏó≠ */}
      <div className="relative mb-3">
        <input
          type="file"
          id={`upload-${facilityType}-${facility.outlet}-${facility.number}-${instanceIndex}`}
          multiple
          accept="image/*"
          onChange={(e) => e.target.files && onUpload(e.target.files)}
          disabled={isUploading}
          className="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed z-10"
        />
        <div 
          className={dragZoneStyles(
            `${facilityType}-${facility.outlet}-${facility.number}-${instanceIndex}`,
            `border-2 border-dashed border-${colorScheme}-300 rounded-lg p-4 text-center transition-all duration-200
            ${isUploading ? `bg-${colorScheme}-100 border-${colorScheme}-400` : `hover:border-${colorScheme}-400 hover:bg-${colorScheme}-50`}
            ${isUploading ? 'cursor-not-allowed' : 'cursor-pointer'}`
          )}
          {...dragHandlers}
        >
          <Upload className={`w-8 h-8 text-${colorScheme}-600 mx-auto mb-2 transition-transform duration-200`} />
          <p className={`text-${colorScheme}-700 font-medium`}>
            {isUploading ? 'ÏóÖÎ°úÎìú Ï§ë...' : 'ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú (Ïó¨Îü¨ Ïû• ÏÑ†ÌÉù Í∞ÄÎä•)'}
          </p>
          <p className={`text-${colorScheme}-600 text-sm mt-1`}>
            ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏóÖÎ°úÎìú
          </p>
        </div>
      </div>

      {/* ÏóÖÎ°úÎìúÎêú ÏÇ¨ÏßÑÎì§ */}
      {photos.length > 0 && (
        <InlinePhotoViewer 
          photos={photos} 
          onPhotoSelect={onPhotoSelect} 
          viewMode={viewMode}
          colorScheme={colorScheme}
          recentPhotoIds={recentPhotoIds}
          businessName={businessName}
          facilityType={facilityType}
          facilityNumber={facility.number}
          outletNumber={facility.outlet}
          category={undefined}
          loadUploadedFiles={loadUploadedFiles}
        />
      )}
    </div>
  );
}

// Í∏∞Î≥∏ÏÇ¨ÏßÑ Ïπ¥ÌÖåÍ≥†Î¶¨ Ïª¥Ìè¨ÎÑåÌä∏
interface BasicPhotoCategoryProps {
  category: string;
  title: string;
  icon: React.ReactNode;
  color: string;
  isUploading: boolean;
  progress: number;
  photos: FacilityPhoto[];
  onUpload: (files: FileList) => void;
  onPhotoSelect: (photo: FacilityPhoto, event: React.MouseEvent) => void;
  viewMode: ViewMode;
  dragHandlers: {
    onDragEnter: (e: React.DragEvent) => void;
    onDragLeave: (e: React.DragEvent) => void;
    onDragOver: (e: React.DragEvent) => void;
    onDrop: (e: React.DragEvent) => void;
  };
  dragZoneStyles: (zoneId: string, baseStyles?: string) => string;
  recentPhotoIds?: Set<string>;
  businessName: string;
  loadUploadedFiles: (forceRefresh?: boolean, highlightNew?: boolean) => Promise<void>;
}

function BasicPhotoCategory({
  category,
  title,
  icon,
  color,
  isUploading,
  progress,
  photos,
  onUpload,
  onPhotoSelect,
  viewMode,
  dragHandlers,
  dragZoneStyles,
  recentPhotoIds,
  businessName,
  loadUploadedFiles
}: BasicPhotoCategoryProps) {
  return (
    <div className={`bg-${color}-50 border border-${color}-200 rounded-lg p-4`}>
      <h4 className={`text-md font-medium text-${color}-700 mb-3 flex items-center gap-2`}>
        {icon}
        {title}
        <span className={`text-xs bg-${color}-100 text-${color}-700 px-2 py-1 rounded ml-auto`}>
          {photos.length}Ïû•
        </span>
      </h4>
      
      {/* ÏóÖÎ°úÎìú ÏßÑÌñâÎ•† */}
      {isUploading && (
        <div className="mb-3">
          <div className="flex items-center justify-between text-sm text-gray-600 mb-1">
            <span>ÏóÖÎ°úÎìú Ï§ë...</span>
            <span>{Math.round(progress)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className={`bg-${color}-600 h-2 rounded-full transition-all duration-300`}
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>
      )}

      {/* ÏóÖÎ°úÎìú ÏòÅÏó≠ */}
      <div className="relative mb-3">
        <input
          type="file"
          id={`upload-${category}`}
          multiple
          accept="image/*"
          onChange={(e) => e.target.files && onUpload(e.target.files)}
          disabled={isUploading}
          className="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed z-10"
        />
        <div 
          className={dragZoneStyles(
            `basic-${category}`,
            `border-2 border-dashed border-${color}-300 rounded-lg p-4 text-center transition-all duration-200
            ${isUploading ? `bg-${color}-100 border-${color}-400` : `hover:border-${color}-400 hover:bg-${color}-50`}
            ${isUploading ? 'cursor-not-allowed' : 'cursor-pointer'}`
          )}
          {...dragHandlers}
        >
          <Upload className={`w-8 h-8 text-${color}-600 mx-auto mb-2 transition-transform duration-200`} />
          <p className={`text-${color}-700 font-medium`}>
            {isUploading ? 'ÏóÖÎ°úÎìú Ï§ë...' : `${title} ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú`}
          </p>
          <p className={`text-${color}-600 text-sm mt-1`}>
            ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏóÖÎ°úÎìú
          </p>
        </div>
      </div>

      {/* ÏóÖÎ°úÎìúÎêú ÏÇ¨ÏßÑÎì§ */}
      {photos.length > 0 && (
        <InlinePhotoViewer 
          photos={photos} 
          onPhotoSelect={onPhotoSelect} 
          viewMode={viewMode}
          colorScheme={color}
          recentPhotoIds={recentPhotoIds}
          businessName={businessName}
          facilityType="basic"
          facilityNumber={undefined}
          outletNumber={undefined}
          category={category}
          loadUploadedFiles={loadUploadedFiles}
        />
      )}
    </div>
  );
}

// Ïù∏ÎùºÏù∏ ÌôïÏû• ÏÇ¨ÏßÑ Î∑∞Ïñ¥ Ïª¥Ìè¨ÎÑåÌä∏
interface InlinePhotoViewerProps {
  photos: FacilityPhoto[];
  onPhotoSelect: (photo: FacilityPhoto, event: React.MouseEvent) => void;
  viewMode: ViewMode;
  colorScheme: string;
  recentPhotoIds?: Set<string>;
  // ÏãúÏÑ§ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
  businessName: string;
  facilityType?: 'discharge' | 'prevention' | 'basic';
  facilityNumber?: number;
  outletNumber?: number;
  category?: string;
  loadUploadedFiles: (forceRefresh?: boolean, highlightNew?: boolean) => Promise<void>;
}

function InlinePhotoViewer({ photos, onPhotoSelect, viewMode, colorScheme, recentPhotoIds, businessName, facilityType, facilityNumber, outletNumber, category, loadUploadedFiles }: InlinePhotoViewerProps) {
  const [expandedIndex, setExpandedIndex] = useState<number | null>(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const expandedRef = useRef<HTMLDivElement>(null);
  const expandedContentRef = useRef<HTMLDivElement>(null);
  
  // üì∑ Î©îÏù∏ Ïª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú Ïù¥ÎØ∏ getFilteredPhotos()Î°ú ÌïÑÌÑ∞ÎßÅÎêú Î∞∞Ïó¥ÏùÑ Î∞õÏùå
  // Îî∞ÎùºÏÑú Ï∂îÍ∞Ä ÌïÑÌÑ∞ÎßÅ Î∂àÌïÑÏöî, photosÎ•º ÏßÅÏ†ë ÏÇ¨Ïö©
  console.log('üîç [INLINE-VIEWER-DEBUG]', {
    receivedPhotos: photos.length,
    facilityType,
    facilityNumber,
    outletNumber,
    category
  });

  // ÏÇ¨ÏßÑ ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ - Ïù∏ÎùºÏù∏ ÌôïÏû•
  const handlePhotoClick = useCallback((photo: FacilityPhoto, index: number, event: React.MouseEvent) => {
    event.stopPropagation();
    
    if (expandedIndex === index) {
      // Ïù¥ÎØ∏ ÌôïÏû•Îêú ÏÇ¨ÏßÑÏùÑ Îã§Ïãú ÌÅ¥Î¶≠ÌïòÎ©¥ Îã´Í∏∞
      setExpandedIndex(null);
    } else {
      setIsAnimating(true);
      setExpandedIndex(index);
      
      // ÌôïÏû• Ïï†ÎãàÎ©îÏù¥ÏÖò ÌõÑ Ïä§ÌÅ¨Î°§
      setTimeout(() => {
        expandedRef.current?.scrollIntoView({ 
          behavior: 'smooth',
          block: 'nearest'
        });
        setIsAnimating(false);
      }, 100);
    }
  }, [expandedIndex]);

  // ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞è Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ï≤òÎ¶¨
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (expandedIndex === null) return;

      switch (event.key) {
        case 'Escape':
          setExpandedIndex(null);
          break;
        case 'ArrowLeft':
          event.preventDefault();
          setExpandedIndex(prev => prev === null ? null : Math.max(0, prev - 1));
          break;
        case 'ArrowRight':
          event.preventDefault();
          setExpandedIndex(prev => prev === null ? null : Math.min(photos.length - 1, prev + 1));
          break;
      }
    };

    const handleClickOutside = (event: MouseEvent) => {
      if (expandedIndex === null) return;
      
      // ÌôïÏû•Îêú Î∑∞Ïñ¥ ÎÇ¥Î∂ÄÎ•º ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Îäî Îã´ÏßÄ ÏïäÏùå
      if (expandedContentRef.current?.contains(event.target as Node)) {
        return;
      }
      
      // ÌôïÏû• ÏòÅÏó≠ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
      if (expandedRef.current && !expandedRef.current.contains(event.target as Node)) {
        setExpandedIndex(null);
      }
    };

    if (expandedIndex !== null) {
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [expandedIndex, photos.length]);

  // Ïç∏ÎÑ§Ïùº Í∑∏Î¶¨Îìú Î†åÎçîÎßÅ
  const renderThumbnailGrid = () => {
    if (viewMode === 'list') {
      return (
        <div className="space-y-2">
          {photos.map((photo, index) => {
            const isRecentPhoto = recentPhotoIds?.has(photo.id);
            const isExpanded = expandedIndex === index;
            
            return (
              <div key={photo.id}>
                <div 
                  className={`flex items-center gap-3 p-2 bg-white rounded border cursor-pointer transition-all duration-300 ${
                    isExpanded ? 
                      `border-${colorScheme}-600 bg-${colorScheme}-100 shadow-md` :
                      isRecentPhoto ? 
                        `ring-2 ring-${colorScheme}-400 border-${colorScheme}-400 bg-${colorScheme}-50 animate-pulse shadow-lg` : 
                        `hover:border-${colorScheme}-400 border-gray-200`
                  }`}
                  onClick={(e) => handlePhotoClick(photo, index, e)}
                >
                  <div className={`w-12 h-12 bg-${colorScheme}-100 rounded flex items-center justify-center text-${colorScheme}-600 font-bold text-sm`}>
                    {index + 1}
                  </div>
                  <div className="flex-1">
                    <div className="font-medium text-sm">{photo.originalFileName}</div>
                    <div className="text-xs text-gray-500">
                      {(photo.fileSize / 1024 / 1024).toFixed(1)}MB ‚Ä¢ {new Date(photo.uploadedAt).toLocaleString()}
                    </div>
                  </div>
                  <Eye className="w-4 h-4 text-gray-400" />
                </div>
                
                {/* Ïù∏ÎùºÏù∏ ÌôïÏû• ÏòÅÏó≠ - Î¶¨Ïä§Ìä∏ Î™®Îìú */}
                {isExpanded && (
                  <div 
                    ref={expandedRef}
                    className={`mt-3 mb-3 bg-white border-2 border-${colorScheme}-200 rounded-lg overflow-hidden transition-all duration-300 ${
                      isAnimating ? 'opacity-0 transform scale-95' : 'opacity-100 transform scale-100'
                    }`}
                  >
                    <div ref={expandedContentRef}>
                      <ExpandedPhotoSection 
                        photo={photo} 
                        photos={photos}
                        currentIndex={index}
                        colorScheme={colorScheme}
                        onNavigate={setExpandedIndex}
                        onClose={() => setExpandedIndex(null)}
                        onRefresh={() => loadUploadedFiles(true, true)}
                        businessName={businessName}
                        facilityType={facilityType}
                        facilityNumber={facilityNumber}
                        outletNumber={outletNumber}
                        category={category}
                      />
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      );
    }

    // Í∑∏Î¶¨Îìú Î™®Îìú
    return (
      <div className="space-y-4">
        <div className="grid grid-cols-2 md:grid-cols-3 gap-1 md:gap-3">
          {photos.map((photo, index) => {
            const isRecentPhoto = recentPhotoIds?.has(photo.id);
            const isExpanded = expandedIndex === index;
            
            return (
              <div 
                key={photo.id}
                className={`relative group cursor-pointer bg-white rounded-lg border-2 overflow-hidden aspect-[4/3] transition-all duration-300 ${
                  isExpanded ? 
                    `border-${colorScheme}-600 shadow-xl ring-2 ring-${colorScheme}-300` :
                    isRecentPhoto ? 
                      `border-${colorScheme}-400 shadow-xl ring-4 ring-${colorScheme}-200 animate-pulse transform scale-[1.02]` : 
                      `border-gray-200 hover:border-${colorScheme}-400 hover:shadow-md`
                }`}
                onClick={(e) => handlePhotoClick(photo, index, e)}
              >
                <div className={`absolute top-2 left-2 bg-${colorScheme}-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10`}>
                  {index + 1}
                </div>
                
                <LazyImage
                  src={photo.thumbnailUrl}
                  alt={photo.originalFileName}
                  className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                  filePath={photo.filePath}
                />
                
                <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-300 flex items-center justify-center">
                  <Eye className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
                </div>
                
                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                  <p className="text-white text-xs font-medium truncate">
                    {index + 1}Î≤àÏß∏ - {photo.originalFileName}
                  </p>
                </div>
                
                {photo.isRecent && (
                  <div className={`absolute inset-0 bg-${colorScheme}-400 bg-opacity-20 animate-pulse`} />
                )}
              </div>
            );
          })}
        </div>
        
        {/* Ïù∏ÎùºÏù∏ ÌôïÏû• ÏòÅÏó≠ - Í∑∏Î¶¨Îìú Î™®Îìú */}
        {expandedIndex !== null && (
          <div 
            ref={expandedRef}
            className={`bg-white border-2 border-${colorScheme}-200 rounded-lg overflow-hidden transition-all duration-300 ${
              isAnimating ? 'opacity-0 transform scale-95' : 'opacity-100 transform scale-100'
            }`}
          >
            <div ref={expandedContentRef}>
              <ExpandedPhotoSection 
                photo={photos[expandedIndex]} 
                photos={photos}
                currentIndex={expandedIndex}
                colorScheme={colorScheme}
                onNavigate={setExpandedIndex}
                onClose={() => setExpandedIndex(null)}
                onRefresh={() => loadUploadedFiles(true, true)}
                businessName={businessName}
                facilityType={facilityType}
                facilityNumber={facilityNumber}
                outletNumber={outletNumber}
                category={category}
              />
            </div>
          </div>
        )}
      </div>
    );
  };

  return renderThumbnailGrid();
}

// ÌôïÏû•Îêú ÏÇ¨ÏßÑ ÏÑπÏÖò Ïª¥Ìè¨ÎÑåÌä∏
interface ExpandedPhotoSectionProps {
  photo: FacilityPhoto;
  photos: FacilityPhoto[];
  currentIndex: number;
  colorScheme: string;
  onNavigate: (index: number) => void;
  onClose: () => void;
  onRefresh?: () => Promise<void>; // ÏÇ≠Ï†ú ÌõÑ ÏÉàÎ°úÍ≥†Ïπ® ÏΩúÎ∞± Ï∂îÍ∞Ä
  // ÏãúÏÑ§ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
  businessName: string;
  facilityType?: 'discharge' | 'prevention' | 'basic';
  facilityNumber?: number;
  // Jotai ÏÇ≠Ï†ú Ìï®ÏàòÎì§ÏùÄ Ïª¥Ìè¨ÎÑåÌä∏ ÎÇ¥Î∂ÄÏóêÏÑú ÏßÅÏ†ë ÏÇ¨Ïö©
  outletNumber?: number;
  category?: string;
}

function ExpandedPhotoSection({ 
  photo, 
  photos, 
  currentIndex, 
  colorScheme, 
  onNavigate, 
  onClose,
  onRefresh,
  businessName,
  facilityType,
  facilityNumber,
  outletNumber,
  category
}: ExpandedPhotoSectionProps) {
  const toast = useToast();
  
  // üîß ExpandedPhotoSectionÏóêÏÑú ÏßÅÏ†ë Jotai ÏÇ¨Ïö©
  const markPhotoAsDeleted = useSetAtom(deletePhotoAtom);
  const markPhotoAsUndeleted = useSetAtom(undeletePhotoAtom);
  
  console.log('üîß [EXPANDED-SCOPE] ExpandedPhotoSectionÏóêÏÑú Jotai Ìï®Ïàò ÏßÅÏ†ë Ï†ïÏùò:', !!markPhotoAsDeleted);
  
  // üõ°Ô∏è Î∞©Ïñ¥ ÏΩîÎìú: photoÍ∞Ä undefinedÏù¥Í±∞ÎÇò ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ Ï≤òÎ¶¨
  if (!photo) {
    console.warn('‚ö†Ô∏è [EXPANDED-PHOTO] photo Í∞ùÏ≤¥Í∞Ä undefinedÏûÖÎãàÎã§. Î™®Îã¨ÏùÑ ÏûêÎèôÏúºÎ°ú Îã´ÏäµÎãàÎã§.');
    onClose();
    return null;
  }
  
  // Í∞úÎ≥Ñ Îã§Ïö¥Î°úÎìú
  const handleDownload = async () => {
    try {
      console.log('üì• [INDIVIDUAL-DOWNLOAD] Í∞úÎ≥Ñ Îã§Ïö¥Î°úÎìú ÏãúÏûë:', {
        photoId: photo.id,
        fileName: photo.originalFileName,
        currentIndex,
        totalPhotos: photos.length
      });
      
      // APIÎ•º ÌÜµÌïú Îã§Ïö¥Î°úÎìú
      const response = await fetch(`/api/facility-photos/${photo.id}?download=true`);
      
      if (!response.ok) {
        if (response.status === 404) {
          // ÌååÏùºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏùÑ Í∞ÄÎä•ÏÑ±
          toast.warning('ÌååÏùº ÏóÜÏùå', 'Ïù¥ ÌååÏùºÏùÄ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò Ïù¥ÎèôÎêòÏóàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.');
          if (onRefresh) {
            await onRefresh();
          }
          return;
        }
        
        const errorData = await response.json();
        throw new Error(errorData.error || 'Îã§Ïö¥Î°úÎìú ÏöîÏ≤≠ Ïã§Ìå®');
      }
      
      // BlobÏúºÎ°ú ÌååÏùº Îç∞Ïù¥ÌÑ∞ Î∞õÍ∏∞
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      
      // Îã§Ïö¥Î°úÎìú ÎßÅÌÅ¨ ÏÉùÏÑ± Î∞è ÌÅ¥Î¶≠
      const link = document.createElement('a');
      link.href = url;
      link.download = photo.originalFileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Î©îÎ™®Î¶¨ Ï†ïÎ¶¨
      window.URL.revokeObjectURL(url);
      
      console.log('‚úÖ [INDIVIDUAL-DOWNLOAD] Îã§Ïö¥Î°úÎìú ÏôÑÎ£å:', photo.originalFileName);
      toast.success('Îã§Ïö¥Î°úÎìú ÏôÑÎ£å', `${photo.originalFileName} ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
      
    } catch (error) {
      console.error('‚ùå [INDIVIDUAL-DOWNLOAD] Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
      toast.error('Îã§Ïö¥Î°úÎìú Ïã§Ìå®', error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  // Ï†ÑÏ≤¥ ZIP Îã§Ïö¥Î°úÎìú
  const handleDownloadAll = async () => {
    try {
      const requestBody = {
        businessName,
        facilityType,
        facilityNumber,
        outletNumber,
        category
      };

      console.log('üì¶ [ZIP-DOWNLOAD] ÏöîÏ≤≠ ÏãúÏûë:', requestBody);

      const response = await fetch('/api/facility-photos/download-zip', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'ZIP Îã§Ïö¥Î°úÎìú ÏöîÏ≤≠ Ïã§Ìå®');
      }

      // ZIP ÌååÏùº Îã§Ïö¥Î°úÎìú
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      
      // Content-Disposition Ìó§ÎçîÏóêÏÑú ÌååÏùºÎ™Ö Ï∂îÏ∂ú
      const contentDisposition = response.headers.get('Content-Disposition');
      let fileName = 'ÏÇ¨ÏßÑÎ™®Ïùå.zip';
      
      if (contentDisposition) {
        const fileNameMatch = contentDisposition.match(/filename\*?=['"]?([^'"]+)['"]?/);
        if (fileNameMatch) {
          fileName = decodeURIComponent(fileNameMatch[1]);
        }
      }

      // Îã§Ïö¥Î°úÎìú ÎßÅÌÅ¨ ÏÉùÏÑ± Î∞è ÌÅ¥Î¶≠
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      
      // Ï†ïÎ¶¨
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
      
      console.log('‚úÖ [ZIP-DOWNLOAD] Îã§Ïö¥Î°úÎìú ÏôÑÎ£å:', fileName);
      
    } catch (error) {
      console.error('‚ùå [ZIP-DOWNLOAD] Ïò§Î•ò:', error);
      alert(`ZIP Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ${error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
    }
  };

  return (
    <div className="p-4">
      {/* Ìó§Îçî */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <span className={`bg-${colorScheme}-600 text-white px-3 py-1 rounded-full text-sm font-medium`}>
            {currentIndex + 1} / {photos.length}
          </span>
          <h3 className="font-semibold text-gray-900 truncate">
            {photo?.originalFileName || photo?.fileName || 'ÌååÏùºÎ™Ö ÏóÜÏùå'}
          </h3>
        </div>
        <button
          onClick={onClose}
          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          title="Îã´Í∏∞ (ESC)"
        >
          <X className="w-5 h-5 text-gray-500" />
        </button>
      </div>

      {/* Î©îÏù∏ Î†àÏù¥ÏïÑÏõÉ: Ï¢åÏ∏° Î©îÏù∏ÏÇ¨ÏßÑ + Ïö∞Ï∏° Ïç∏ÎÑ§Ïùº */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        {/* Ï¢åÏ∏°: Î©îÏù∏ ÏÇ¨ÏßÑ */}
        <div className="lg:col-span-2">
          <div className="relative bg-gray-100 rounded-lg overflow-hidden aspect-[4/3]">
            <LazyImage
              src={photo.downloadUrl}
              alt={photo.originalFileName}
              className="w-full h-full object-contain"
              filePath={photo.filePath}
            />
            
            {/* ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌôîÏÇ¥Ìëú */}
            {currentIndex > 0 && (
              <button
                onClick={() => onNavigate(currentIndex - 1)}
                className={`absolute left-2 top-1/2 transform -translate-y-1/2 bg-${colorScheme}-600 text-white p-2 rounded-full hover:bg-${colorScheme}-700 transition-colors`}
                title="Ïù¥Ï†Ñ ÏÇ¨ÏßÑ (‚Üê)"
              >
                <ChevronLeft className="w-5 h-5" />
              </button>
            )}
            
            {currentIndex < photos.length - 1 && (
              <button
                onClick={() => onNavigate(currentIndex + 1)}
                className={`absolute right-2 top-1/2 transform -translate-y-1/2 bg-${colorScheme}-600 text-white p-2 rounded-full hover:bg-${colorScheme}-700 transition-colors`}
                title="Îã§Ïùå ÏÇ¨ÏßÑ (‚Üí)"
              >
                <ChevronRight className="w-5 h-5" />
              </button>
            )}
          </div>
          
          {/* ÏÇ¨ÏßÑ Ï†ïÎ≥¥ */}
          <div className="mt-2 text-sm text-gray-600">
            <div>{(photo.fileSize / 1024 / 1024).toFixed(1)}MB ‚Ä¢ {new Date(photo.uploadedAt).toLocaleString()}</div>
          </div>
        </div>

        {/* Ïö∞Ï∏°: Ïç∏ÎÑ§Ïùº Î¶¨Ïä§Ìä∏ */}
        <div className="lg:col-span-1">
          <h4 className="font-medium text-gray-900 mb-2">Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ</h4>
          <div className="space-y-2 max-h-80 overflow-y-auto">
            {photos.map((thumbPhoto, index) => (
              <div 
                key={thumbPhoto.id}
                className={`flex items-center gap-2 p-2 rounded cursor-pointer transition-all duration-200 ${
                  index === currentIndex 
                    ? `bg-${colorScheme}-100 border-2 border-${colorScheme}-400` 
                    : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                }`}
                onClick={() => onNavigate(index)}
              >
                <div className="w-12 h-12 bg-gray-200 rounded overflow-hidden flex-shrink-0">
                  <LazyImage
                    src={thumbPhoto.thumbnailUrl}
                    alt={thumbPhoto.originalFileName}
                    className="w-full h-full object-cover"
                    filePath={thumbPhoto.filePath}
                  />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-xs font-medium text-gray-900 truncate">
                    {index + 1}. {thumbPhoto.originalFileName}
                  </div>
                  <div className="text-xs text-gray-500">
                    {(thumbPhoto.fileSize / 1024 / 1024).toFixed(1)}MB
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* ÌïòÎã®: Ïï°ÏÖò Î≤ÑÌäºÎì§ */}
      <div className="flex flex-col md:flex-row gap-2 md:gap-3 justify-center pt-4 border-t">
        <button
          onClick={handleDownload}
          className={`bg-${colorScheme}-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-${colorScheme}-700 transition-colors flex items-center gap-1 md:gap-2 text-sm md:text-base font-medium`}
        >
          <Download className="w-3 md:w-4 h-3 md:h-4" />
          Í∞úÎ≥Ñ Îã§Ïö¥Î°úÎìú
        </button>
        
        <button
          onClick={handleDownloadAll}
          className="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1 md:gap-2 text-sm md:text-base font-medium"
        >
          <Archive className="w-3 md:w-4 h-3 md:h-4" />
          Ï†ÑÏ≤¥ ZIP
        </button>
        
        <button
          onClick={async () => {
            console.log('üî•üî• [EXPANDED-VIEWER-DELETE] ÌôïÏû• Î∑∞Ïñ¥Ïùò ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠Îê®!');
            if (confirm(`"${photo.originalFileName}" ÌååÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
              console.log('üöÄ [EXPANDED-DELETE-START] ÌôïÏû• Î∑∞Ïñ¥ÏóêÏÑú ÏÇ≠Ï†ú ÏßÑÌñâ');
              
              // üéØ JotaiÎ•º ÏÇ¨Ïö©Ìïú Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏
              markPhotoAsDeleted(photo.id);
              console.log('‚ö° [EXPANDED-INSTANT-DELETE] markPhotoAsDeleted Ìò∏Ï∂úÏôÑÎ£å');
              
              // ‚úÖ Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå - ÏÇ¨Ïö©ÏûêÍ∞Ä Í≥ÑÏÜç Îã§Î•∏ ÏÇ¨ÏßÑÎì§ÏùÑ Î≥º Ïàò ÏûàÎèÑÎ°ù
              // onClose(); // Ï£ºÏÑù Ï≤òÎ¶¨ - Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå
              console.log('üëÅÔ∏è [EXPANDED-MODAL-KEEP] ÌôïÏû• Î∑∞Ïñ¥ Ïú†ÏßÄ - Î™®Îã¨ Îã´ÏßÄ ÏïäÏùå');
              
              // ÏÑ±Í≥µ Î©îÏãúÏßÄ Ï¶âÏãú ÌëúÏãú
              toast.success('ÏÇ≠Ï†ú ÏôÑÎ£å', 'ÏÇ¨ÏßÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
              
              try {
                // Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Ïã§Ï†ú API ÏÇ≠Ï†ú
                const response = await fetch('/api/facility-photos', {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                    photoId: photo.id, 
                    businessName: businessName
                  })
                });

                const result = await response.json();
                
                if (!result.success) {
                  // API Ïã§Ìå® Ïãú Î°§Î∞±
                  console.error('‚ùå [EXPANDED-DELETE-API-FAILED]', result.message);
                  markPhotoAsUndeleted(photo.id);
                  toast.error('ÏÇ≠Ï†ú Ïã§Ìå®', result.message || 'ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                } else {
                  console.log('‚úÖ [EXPANDED-DELETE-API-SUCCESS] ÏÑúÎ≤ÑÏóêÏÑúÎèÑ ÏÇ≠Ï†ú ÏôÑÎ£å');
                }
              } catch (error) {
                console.error('‚ùå [EXPANDED-DELETE-API-ERROR]', error);
                markPhotoAsUndeleted(photo.id);
                toast.error('ÏÇ≠Ï†ú Ïò§Î•ò', 'ÏÇ¨ÏßÑ ÏÇ≠Ï†ú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
              }
            }
          }}
          className="bg-red-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-1 md:gap-2 text-sm md:text-base font-medium"
        >
          <Trash2 className="w-3 md:w-4 h-3 md:h-4" />
          ÏÇ≠Ï†ú
        </button>
      </div>
    </div>
  );
}

// ÏÇ¨ÏßÑ ÏÉÅÏÑ∏ Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏
interface PhotoDetailModalProps {
  photo: FacilityPhoto;
  position: { x: number; y: number };
  onClose: () => void;
  onDelete: () => void;
}

const PhotoDetailModal = forwardRef<HTMLDivElement, PhotoDetailModalProps>(
  ({ photo, position, onClose, onDelete }, ref) => {
    return (
      <div 
        className="fixed inset-0 bg-black bg-opacity-50 z-50 animate-fade-in"
        style={{ backdropFilter: 'blur(4px)' }}
      >
        <div 
          ref={ref}
          tabIndex={-1}
          className="fixed bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden focus:outline-none"
          style={{
            left: `${position.x}px`,
            top: `${position.y}px`,
            maxWidth: '600px',
            maxHeight: '80vh',
            minWidth: '400px',
            transform: 'scale(0.95)',
            animation: 'modalSlideIn 0.2s ease-out forwards'
          }}
        >
          {/* Î™®Îã¨ Ìó§Îçî */}
          <div className="flex items-center justify-between p-4 bg-gray-50 border-b">
            <div>
              <h3 className="font-semibold text-gray-900 truncate">
                {photo.originalFileName}
              </h3>
              <p className="text-sm text-gray-600">
                {(photo.fileSize / 1024 / 1024).toFixed(1)}MB ‚Ä¢ {new Date(photo.uploadedAt).toLocaleString()}
              </p>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
            >
              <X className="w-5 h-5 text-gray-500" />
            </button>
          </div>

          {/* Î™®Îã¨ Ïù¥ÎØ∏ÏßÄ */}
          <div className="p-4">
            <div className="relative bg-gray-100 rounded-lg overflow-hidden">
              <LazyImage
                src={photo.downloadUrl}
                alt={photo.originalFileName}
                className="w-full max-h-[70vh] object-contain"
                filePath={photo.filePath}
              />
            </div>
            
            {/* Ïï°ÏÖò Î≤ÑÌäº */}
            <div className="flex flex-col md:flex-row gap-2 md:gap-3 justify-center mt-4">
              <a
                href={photo.downloadUrl}
                download={photo.originalFileName}
                className="bg-blue-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1 md:gap-2 text-sm md:text-base font-medium"
              >
                <Download className="w-3 md:w-4 h-3 md:h-4" />
                Îã§Ïö¥Î°úÎìú
              </a>
              
              <button
                onClick={() => {
                  console.log('üî• [DEBUG] ÏÇ≠Ï†ú Î≤ÑÌäºÏù¥ ÌÅ¥Î¶≠ÎêòÏóàÏäµÎãàÎã§!');
                  onDelete();
                }}
                className="bg-red-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-1 md:gap-2 text-sm md:text-base font-medium"
              >
                <Trash2 className="w-3 md:w-4 h-3 md:h-4" />
                ÏÇ≠Ï†ú
              </button>
            </div>
          </div>

          {/* ESC ÌûåÌä∏ */}
          <div className="absolute top-4 right-16 text-xs text-gray-500 bg-white bg-opacity-90 px-2 py-1 rounded">
            ESC ÎòêÎäî Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
          </div>
        </div>
      </div>
    );
  }
);

PhotoDetailModal.displayName = 'PhotoDetailModal';