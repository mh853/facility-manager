# 실시간 알림 시스템 테스트 가이드

## 📋 테스트 목표
- Supabase Realtime 연결이 정상적으로 작동하는지 확인
- 알림이 페이지 새로고침 없이 실시간으로 나타나는지 검증
- 브라우저 푸시 알림과 인앱 토스트 알림이 정상 표시되는지 확인

---

## 방법 1️⃣: 테스트 알림 버튼 (가장 간단)

### 단계
1. **브라우저에서 접속**
   ```
   http://localhost:3000/notifications/settings
   ```

2. **"테스트 알림 보내기" 버튼 클릭**

3. **확인 사항**
   - ✅ 브라우저 푸시 알림이 즉시 표시
   - ✅ 인앱 토스트 알림이 우측 상단에 표시
   - ✅ `/notifications` 페이지에 알림이 추가됨

### 장점
- 가장 빠르고 간단한 테스트
- 별도 설정 불필요
- 현재 로그인한 사용자로 즉시 테스트 가능

### 단점
- 단일 사용자 관점에서만 테스트
- 실제 업무 흐름과 다른 테스트

---

## 방법 2️⃣: 다중 브라우저 세션 테스트 (권장 ⭐)

### 준비
1. **브라우저 A**: Chrome 일반 모드
2. **브라우저 B**: Chrome 시크릿 모드 또는 다른 브라우저 (Safari, Firefox 등)

### 단계

#### 브라우저 A (알림 발신자)
1. 계정 A로 로그인 (예: 최문호)
2. `/admin/tasks` 페이지 접속
3. 새 업무 생성 또는 기존 업무 상태 변경

#### 브라우저 B (알림 수신자)
1. 계정 B로 로그인 (예: 다른 직원)
2. `/notifications` 페이지를 열어둠
3. **중요**: 페이지를 새로고침하지 말고 대기

#### 확인 사항
- ✅ 브라우저 A에서 업무를 생성/수정하면
- ✅ 브라우저 B에서 **페이지 새로고침 없이** 알림이 실시간으로 나타남
- ✅ 브라우저 푸시 알림도 즉시 표시됨
- ✅ 인앱 토스트 알림이 우측 상단에 표시됨

### 장점
- 실제 사용 시나리오와 가장 유사
- 다중 사용자 환경에서의 실시간 동기화 검증
- 네트워크 지연 등 실제 조건 반영

### 단점
- 두 개의 브라우저와 계정 필요
- 테스트 설정에 시간 소요

---

## 방법 3️⃣: 자동화 테스트 스크립트 (고급)

### 사용법

#### 기본 테스트 (1회)
```bash
node scripts/test-realtime-notification.js
```

#### 특정 사용자에게 알림 전송
```bash
node scripts/test-realtime-notification.js <USER_ID>
```

#### 연속 테스트 (10초마다 반복)
```bash
node scripts/test-realtime-notification.js --continuous
```

### 실행 전 준비
1. **개발 서버 실행 확인**
   ```bash
   npm run dev
   ```

2. **브라우저에서 알림 페이지 열어두기**
   ```
   http://localhost:3000/notifications
   ```

3. **스크립트 실행**
   ```bash
   node scripts/test-realtime-notification.js
   ```

### 확인 사항
- ✅ 터미널에 "✅ 테스트 알림 생성 성공!" 메시지 표시
- ✅ 브라우저에서 **새로고침 없이** 알림이 나타남
- ✅ 브라우저 푸시 알림 표시
- ✅ 인앱 토스트 알림이 우측 상단에 표시

### 장점
- 정확한 타이밍으로 테스트 가능
- 반복 테스트 가능 (연속 모드)
- 다양한 사용자로 테스트 가능

### 단점
- 터미널 사용 필요
- Node.js 환경 필요

---

## 방법 4️⃣: Supabase Studio 직접 조작

### 단계
1. **Supabase Studio 접속**
   ```
   https://supabase.com/dashboard/project/qdfqoykhmuiambtrrlnf
   ```

2. **Table Editor에서 `task_notifications` 테이블 선택**

3. **"Insert" → "Insert row" 클릭**

4. **새 알림 데이터 입력**
   ```json
   {
     "user_id": "502da2f0-fd81-449a-87c3-5be924067d4c",
     "title": "수동 테스트 알림",
     "message": "Supabase Studio에서 직접 생성한 테스트 알림입니다.",
     "category": "system",
     "priority": "high",
     "is_read": false,
     "created_by": "502da2f0-fd81-449a-87c3-5be924067d4c"
   }
   ```

5. **"Save" 클릭**

6. **브라우저에서 즉시 알림 확인**

### 장점
- GUI 환경에서 직관적으로 테스트
- 데이터베이스 레벨에서 검증 가능
- 다양한 알림 데이터 조합 테스트 가능

### 단점
- Supabase Studio 접속 권한 필요
- 수동 입력으로 시간 소요

---

## 🔍 실시간 연결 상태 확인 방법

### 브라우저 콘솔에서 확인
1. **브라우저 개발자 도구 열기** (F12 또는 Cmd+Option+I)
2. **Console 탭 선택**
3. **로그 확인**:
   ```
   ✅ [REALTIME] Supabase Realtime 연결 성공
   🔔 [REALTIME] task_notifications 채널 구독 성공
   ```

### 연결 문제 해결
만약 다음 로그가 보이면:
```
❌ [REALTIME] 연결 오류: ...
```

**해결 방법**:
1. 페이지 새로고침 (F5)
2. 브라우저 캐시 삭제
3. 개발 서버 재시작
4. 네트워크 연결 확인

---

## 🎯 테스트 체크리스트

### 기본 기능
- [ ] 브라우저 푸시 알림이 표시되는가?
- [ ] 인앱 토스트 알림이 우측 상단에 표시되는가?
- [ ] 페이지 새로고침 없이 알림 목록이 업데이트되는가?
- [ ] 알림 클릭 시 관련 페이지로 이동하는가?
- [ ] "모두 읽음" 버튼이 정상 작동하는가?

### 실시간 동기화
- [ ] 다른 브라우저에서 생성한 알림이 즉시 나타나는가?
- [ ] 알림 읽음 처리가 실시간으로 반영되는가?
- [ ] 알림 삭제가 실시간으로 반영되는가?
- [ ] 네트워크 재연결 시 알림이 정상 수신되는가?

### 우선순위별 동작
- [ ] Critical 알림이 빨간색으로 표시되는가?
- [ ] High 알림이 주황색으로 표시되는가?
- [ ] Critical/High 알림의 토스트가 2배 더 오래 표시되는가?
- [ ] Low 알림이 파란색으로 표시되는가?

### 삭제된 업무 처리
- [ ] 삭제된 업무 알림 클릭 시 "[삭제됨]" 표시가 나타나는가?
- [ ] 삭제된 업무 상세 페이지가 회색 스타일로 표시되는가?
- [ ] 404 오류 없이 정상 표시되는가?

---

## 📊 성능 테스트

### 대량 알림 부하 테스트
```bash
# 연속 모드로 10초마다 알림 생성
node scripts/test-realtime-notification.js --continuous
```

### 확인 사항
- 알림이 누적되어도 UI가 느려지지 않는가?
- 메모리 사용량이 비정상적으로 증가하지 않는가?
- 네트워크 연결이 안정적으로 유지되는가?

---

## 🐛 문제 해결

### 알림이 나타나지 않는 경우
1. **Supabase Realtime 연결 확인**
   - 브라우저 콘솔에서 연결 로그 확인
   - 네트워크 탭에서 WebSocket 연결 상태 확인

2. **알림 권한 확인**
   - 브라우저 설정에서 알림 권한이 허용되어 있는지 확인
   - macOS: 시스템 환경설정 → 알림 → Chrome/Safari

3. **환경 변수 확인**
   - `.env.local` 파일에 Supabase 설정이 올바른지 확인
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### 알림이 중복으로 나타나는 경우
1. **중복 구독 확인**
   - 페이지를 새로고침하여 연결 재설정
   - 브라우저 콘솔에서 구독 로그 확인

2. **캐시 삭제**
   - 브라우저 캐시 및 쿠키 삭제
   - 하드 새로고침 (Cmd+Shift+R 또는 Ctrl+Shift+R)

---

## 📝 권장 테스트 시나리오

### 시나리오 1: 업무 할당 알림
1. 사용자 A가 업무를 생성하고 사용자 B에게 할당
2. 사용자 B 브라우저에서 실시간으로 알림 수신 확인
3. 알림 클릭하여 업무 상세 페이지로 이동 확인

### 시나리오 2: 업무 상태 변경 알림
1. 사용자 A가 업무 상태를 "진행중"으로 변경
2. 관련자들에게 실시간 알림 전송 확인
3. 여러 브라우저에서 동시 수신 확인

### 시나리오 3: 삭제된 업무 알림 처리
1. 알림이 있는 업무를 소프트 삭제
2. 알림 클릭 시 "[삭제됨]" 표시 확인
3. 404 오류 없이 정상 표시 확인

---

## ✅ 성공 기준

모든 테스트 방법에서 다음이 확인되어야 합니다:

1. **즉시성**: 알림이 생성 후 1초 이내에 표시
2. **정확성**: 올바른 사용자에게만 알림 전송
3. **안정성**: 네트워크 재연결 후에도 정상 작동
4. **완전성**: 푸시 알림, 인앱 토스트, 목록 업데이트 모두 정상
5. **사용성**: 삭제된 업무도 적절하게 표시

---

## 📚 참고 자료

- [Supabase Realtime 공식 문서](https://supabase.com/docs/guides/realtime)
- [Web Push API 문서](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [NotificationContext 코드](/contexts/NotificationContext.tsx)
- [테스트 스크립트](/scripts/test-realtime-notification.js)
