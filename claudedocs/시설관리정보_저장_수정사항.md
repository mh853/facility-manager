# ì‹œì„¤ ê´€ë¦¬ ì •ë³´ ì €ì¥ ë¬¸ì œ í•´ê²°

## ë¬¸ì œ ìš”ì•½

`/business/[ì‚¬ì—…ì¥ëª…]` í˜ì´ì§€ì—ì„œ ì‹¤ì‚¬ì ì •ë³´ì™€ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ê³  ì €ì¥í–ˆì„ ë•Œ:
- âŒ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì§€ ì•ŠìŒ
- âŒ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì…ë ¥í•œ ì •ë³´ê°€ ì‚¬ë¼ì§
- âŒ API ì‘ë‹µ: `{success: false, error: {...}}`

## ì›ì¸ ë¶„ì„

### 1. API ì—”ë“œí¬ì¸íŠ¸ ë¶€ì¬ (ì´ˆê¸° ë¬¸ì œ)
- ì»´í¬ë„ŒíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” API (`/api/inspector-info`, `/api/special-notes`)ë¥¼ í˜¸ì¶œ
- ì‹¤ì œë¡œëŠ” `/api/facility-management` APIê°€ ì´ ê¸°ëŠ¥ì„ ë‹´ë‹¹

### 2. React ìƒíƒœ ì—…ë°ì´íŠ¸ ë¹„ë™ê¸° ë¬¸ì œ
- `onUpdate(editData)` í˜¸ì¶œ í›„ ì¦‰ì‹œ `onSave()` í˜¸ì¶œ
- Reactì˜ ë¹„ë™ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸ë¡œ ì¸í•´ `onSave()`ê°€ ì´ì „ ê°’ ì‚¬ìš©
- **í•´ê²°**: ì»´í¬ë„ŒíŠ¸ì—ì„œ í¸ì§‘ëœ ê°’ì„ ì§ì ‘ ì „ë‹¬ (`await onSave(editData)`)

### 3. businessId ëˆ„ë½
- `/api/facilities-supabase` ì‘ë‹µì˜ `businessInfo` ê°ì²´ì— `id` í•„ë“œ ì—†ìŒ
- **í•´ê²°**: `id: business.id` ì¶”ê°€

### 4. **í•µì‹¬ ë¬¸ì œ 1: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì˜¤ë¥˜**
- GET ìš”ì²­ì—ì„œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ë“¤ì„ ëª…ì‹œì ìœ¼ë¡œ ì¡°íšŒ
- ì—ëŸ¬: `column business_info.installation_phase does not exist` (PostgreSQL error code: 42703)
- **í•´ê²°**: `select('*')`ë¡œ ë³€ê²½í•˜ì—¬ ëª¨ë“  ì»¬ëŸ¼ ìë™ ì¡°íšŒ

### 5. **í•µì‹¬ ë¬¸ì œ 2: CSRF í† í° ê²€ì¦ ì‹¤íŒ¨**
- `/api/facility-management`ê°€ CSRF ì˜ˆì™¸ ëª©ë¡ì— ì—†ìŒ
- ë¯¸ë“¤ì›¨ì–´ì—ì„œ 403 Forbidden ë°˜í™˜: `CSRF_TOKEN_INVALID`
- **í•´ê²°**: CSRF ì˜ˆì™¸ ëª©ë¡ì— `/api/facility-management` ì¶”ê°€

### 6. **ì¶”ê°€ ë¬¸ì œ: Supabase UPDATE ì¿¼ë¦¬ ì˜¤ë¥˜**
- APIê°€ ìš”ì²­ ë³¸ë¬¸ì—ì„œ ì œê³µëœ í•„ë“œë§Œ ì—…ë°ì´íŠ¸í•˜ì§€ ì•Šê³  **ëª¨ë“  í•„ë“œë¥¼ ì—…ë°ì´íŠ¸**
- ì˜ˆ: `special_notes`ë§Œ ì €ì¥í•˜ë ¤ê³  í•´ë„ `installation_phase`, `surveyor_name` ë“±ì„ `undefined`ë¡œ ì„¤ì •
- ì´ë¡œ ì¸í•´ ê¸°ì¡´ ë°ì´í„°ê°€ `null`/`undefined`ë¡œ ë®ì–´ì”Œì›Œì§

```typescript
// âŒ ê¸°ì¡´ ì½”ë“œ (ë¬¸ì œ)
let updateQuery = supabaseAdmin.from('business_info').update({
  installation_phase,        // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  surveyor_name,            // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  surveyor_contact,         // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  surveyor_company,         // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  survey_date,              // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  installation_date,        // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  completion_date,          // undefined â†’ ê¸°ì¡´ ê°’ ë®ì–´ì”Œì›€
  special_notes,            // ê°’ ìˆìŒ
  updated_at: new Date().toISOString()
});
```

```typescript
// âœ… ìˆ˜ì •ëœ ì½”ë“œ
const updateData: any = {
  updated_at: new Date().toISOString()
};

// ì œê³µëœ í•„ë“œë§Œ ì—…ë°ì´íŠ¸ ê°ì²´ì— ì¶”ê°€
if (installation_phase !== undefined) updateData.installation_phase = installation_phase;
if (surveyor_name !== undefined) updateData.surveyor_name = surveyor_name;
if (surveyor_contact !== undefined) updateData.surveyor_contact = surveyor_contact;
if (surveyor_company !== undefined) updateData.surveyor_company = surveyor_company;
if (survey_date !== undefined) updateData.survey_date = survey_date;
if (installation_date !== undefined) updateData.installation_date = installation_date;
if (completion_date !== undefined) updateData.completion_date = completion_date;
if (special_notes !== undefined) updateData.special_notes = special_notes;

let updateQuery = supabaseAdmin.from('business_info').update(updateData);
```

## ìˆ˜ì • ì‚¬í•­

### 1. `/app/api/facility-management/route.ts`
- âœ… GET ë©”ì„œë“œ: `select('*')`ë¡œ ë³€ê²½í•˜ì—¬ ëª…ì‹œì  ì»¬ëŸ¼ ë‚˜ì—´ ì œê±° (line 27)
- âœ… PUT ë©”ì„œë“œ: ì œê³µëœ í•„ë“œë§Œ ì—…ë°ì´íŠ¸í•˜ë„ë¡ ìˆ˜ì • (line 172-188)
- âœ… ìƒì„¸ ë¡œê¹… ì¶”ê°€ (ì—…ë°ì´íŠ¸í•  ë°ì´í„° êµ¬ì¡° ì¶œë ¥)

### 2. `/app/business/[businessName]/page.tsx`
- âœ… `saveInspectorInfo()`, `saveSpecialNotes()` í•¨ìˆ˜: íŒŒë¼ë¯¸í„°ë¡œ ê°’ ì „ë‹¬ë°›ë„ë¡ ìˆ˜ì •
- âœ… ìƒì„¸ ì—ëŸ¬ ë¡œê¹… ì¶”ê°€ (HTTP ìƒíƒœ, ì—ëŸ¬ ë©”ì‹œì§€, ì—ëŸ¬ ê°ì²´)

### 3. `/components/sections/InspectorInfoSection.tsx`
- âœ… `handleSave()`: í¸ì§‘ëœ ê°’ì„ ì§ì ‘ ì „ë‹¬ (`await onSave(editData)`)

### 4. `/components/sections/SpecialNotesSection.tsx`
- âœ… `handleSave()`: í¸ì§‘ëœ ê°’ì„ ì§ì ‘ ì „ë‹¬ (`await onSave(editNotes)`)

### 5. `/app/api/facilities-supabase/[businessName]/route.ts`
- âœ… `businessInfo` ê°ì²´ì— `id` í•„ë“œ ì¶”ê°€

### 6. `/lib/security/csrf-protection.ts`
- âœ… CSRF ì˜ˆì™¸ ëª©ë¡ì— `/api/facility-management` ì¶”ê°€ (line 105)

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. íŠ¹ì´ì‚¬í•­ ì €ì¥ í…ŒìŠ¤íŠ¸
```
1. ì‚¬ì—…ì¥ í˜ì´ì§€ ì ‘ì†: http://localhost:3000/business/[ì‚¬ì—…ì¥ëª…]
2. "íŠ¹ì´ì‚¬í•­" ì„¹ì…˜ì—ì„œ [í¸ì§‘] ë²„íŠ¼ í´ë¦­
3. í…ìŠ¤íŠ¸ ì…ë ¥ (ì˜ˆ: "í…ŒìŠ¤íŠ¸ íŠ¹ì´ì‚¬í•­ ë‚´ìš©")
4. [ì €ì¥] ë²„íŠ¼ í´ë¦­
5. ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸:
   - "íŠ¹ì´ì‚¬í•­ ì €ì¥ ì‘ë‹µ: {success: true, ...}" í‘œì‹œë˜ì–´ì•¼ í•¨
   - ì—ëŸ¬ ë©”ì‹œì§€ ì—†ì–´ì•¼ í•¨
6. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (F5)
7. íŠ¹ì´ì‚¬í•­ ì„¹ì…˜ì— ì €ì¥í•œ ë‚´ìš©ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
```

### 2. ì‹¤ì‚¬ì ì •ë³´ ì €ì¥ í…ŒìŠ¤íŠ¸
```
1. ì‚¬ì—…ì¥ í˜ì´ì§€ ì ‘ì†
2. "ì‹¤ì‚¬ì ì •ë³´" ì„¹ì…˜ì—ì„œ [í¸ì§‘] ë²„íŠ¼ í´ë¦­
3. ì •ë³´ ì…ë ¥:
   - ì‹¤ì‚¬ìëª…: "í™ê¸¸ë™"
   - ì—°ë½ì²˜: "010-1234-5678"
   - ì‹¤ì‚¬ì¼ì: ë‚ ì§œ ì„ íƒ
4. [ì €ì¥] ë²„íŠ¼ í´ë¦­
5. ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸: "ì‹¤ì‚¬ì ì •ë³´ ì €ì¥ ì‘ë‹µ: {success: true, ...}"
6. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
7. ì‹¤ì‚¬ì ì •ë³´ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
```

### 3. ì„œë²„ ë¡œê·¸ í™•ì¸ (ì„ íƒì‚¬í•­)
í„°ë¯¸ë„ì—ì„œ `npm run dev`ë¥¼ ì‹¤í–‰í•œ í™”ë©´ì—ì„œ ë‹¤ìŒ ë¡œê·¸ í™•ì¸:
```
ğŸ“ [FACILITY-MGMT] ì‹œì„¤ ê´€ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸: {...}
ğŸ“ [FACILITY-MGMT] ì—…ë°ì´íŠ¸í•  ë°ì´í„°: {...}
ğŸ“ [FACILITY-MGMT] businessIdë¡œ ì—…ë°ì´íŠ¸: [UUID]
ğŸ“ [FACILITY-MGMT] ì—…ë°ì´íŠ¸ ê²°ê³¼: {updatedBusiness: {...}, updateError: null}
âœ… [FACILITY-MGMT] ì‹œì„¤ ê´€ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ: [ì‚¬ì—…ì¥ëª…]
```

## ê¸°ëŒ€ ê²°ê³¼

- âœ… íŠ¹ì´ì‚¬í•­ ì €ì¥ â†’ DB ì €ì¥ â†’ ìƒˆë¡œê³ ì¹¨ ì‹œ ë°ì´í„° ìœ ì§€
- âœ… ì‹¤ì‚¬ì ì •ë³´ ì €ì¥ â†’ DB ì €ì¥ â†’ ìƒˆë¡œê³ ì¹¨ ì‹œ ë°ì´í„° ìœ ì§€
- âœ… ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸° ë°©ì§€ (íŠ¹ì´ì‚¬í•­ë§Œ ì €ì¥í•´ë„ ì‹¤ì‚¬ì ì •ë³´ëŠ” ìœ ì§€)
- âœ… ìƒì„¸í•œ ì—ëŸ¬ ë¡œê¹…ìœ¼ë¡œ ë¬¸ì œ ë””ë²„ê¹… ìš©ì´

## ì¶”ê°€ ê°œì„ ì‚¬í•­

í–¥í›„ ê³ ë ¤í•  ìˆ˜ ìˆëŠ” ê°œì„ :
1. ë‚™ê´€ì  UI ì—…ë°ì´íŠ¸ (ì €ì¥ ì „ UI ë¨¼ì € ì—…ë°ì´íŠ¸, ì‹¤íŒ¨ ì‹œ ë¡¤ë°±)
2. ìë™ ì €ì¥ ê¸°ëŠ¥ (ì¼ì • ì‹œê°„ í›„ ìë™ ì €ì¥)
3. ë³€ê²½ ì‚¬í•­ ì¶”ì  (unsaved changes warning)
4. ì €ì¥ ì„±ê³µ/ì‹¤íŒ¨ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ê°œì„ 
