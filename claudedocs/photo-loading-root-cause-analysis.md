# Photo Loading Issue - Root Cause Analysis Report

## Executive Summary

**Root Cause Found**: Critical table name mismatch between photo upload and retrieval systems causing zero photos to display despite successful uploads.

**Impact**: All photos uploaded are inaccessible through the UI, affecting all businesses including "오메가칼라"

**Severity**: Critical - Complete photo functionality failure

## Investigation Process

### 1. Evidence Collection
- ✅ API returns `{"files":[],"totalCount":0}` for "오메가칼라"
- ✅ Business "오메가칼라" exists in business list API (confirmed 937 businesses loaded)
- ✅ Upload functionality appears to work (no errors reported by users)
- ✅ Component filtering logic is properly implemented

### 2. System Flow Analysis
```
Photo Upload Flow:
User uploads → upload-supabase API → businesses table → uploaded_files table

Photo Retrieval Flow:
Component loads → uploaded-files-supabase API → business_info table → NO MATCH FOUND
```

### 3. Root Cause Identification

**Critical Table Mismatch**:

**Upload System** (`/app/api/upload-supabase/route.ts:19`):
```typescript
const { data: existingBusiness, error: selectError } = await supabaseAdmin
  .from('businesses')  // ❌ USES 'businesses' TABLE
  .select('id')
  .eq('name', businessName)
```

**Retrieval System** (`/app/api/uploaded-files-supabase/route.ts:24`):
```typescript
const { data: business, error: businessError } = await supabaseAdmin
  .from('business_info')  // ❌ USES 'business_info' TABLE  
  .select('id')
  .eq('business_name', businessName)  // Different column name too!
```

### 4. Schema Analysis

The system has two business tables:
- `businesses` - Used by upload system (column: `name`)
- `business_info` - Used by retrieval system (column: `business_name`)

**Data Flow Disconnect**:
1. Photos uploaded → `businesses.id` → `uploaded_files.business_id`
2. Photos retrieved → `business_info.id` → NO MATCH in `uploaded_files` 
3. Result: 0 files returned despite existing uploads

### 5. Impact Assessment

**Affected Operations**:
- ✅ Photo uploads (working - uses `businesses` table)
- ❌ Photo display (broken - uses `business_info` table)
- ❌ Photo deletion (broken - depends on display)
- ❌ Photo preview (broken - depends on display)

**Scope**:
- All businesses affected (not just "오메가칼라")
- All photo categories (basic, discharge, prevention)
- Both systemTypes (completion, presurvey)

## Fix Strategy

### Immediate Fix (Recommended)
**Align retrieval API to use `businesses` table** to match upload system:

**File**: `/app/api/uploaded-files-supabase/route.ts`
**Change**:
```typescript
// BEFORE (line 23-27):
const { data: business, error: businessError } = await supabaseAdmin
  .from('business_info')
  .select('id')
  .eq('business_name', businessName)

// AFTER:
const { data: business, error: businessError } = await supabaseAdmin  
  .from('businesses')
  .select('id')
  .eq('name', businessName)
```

### Alternative Fix
Align upload API to use `business_info` table, but this requires:
1. Updating upload API table reference
2. Data migration for existing uploads
3. More complex change with higher risk

### Verification Steps
After implementing fix:
1. Test photo retrieval for "오메가칼라": `GET /api/uploaded-files-supabase?businessName=오메가칼라`
2. Verify photos display in component
3. Test with other businesses
4. Verify all photo categories load correctly

## Prevention Measures

1. **Database Abstraction Layer**: Create centralized business lookup functions
2. **Schema Documentation**: Document which table should be used for what purpose  
3. **Integration Tests**: Add tests that verify upload→retrieval round trip
4. **Code Reviews**: Flag table name inconsistencies

## Timeline
- **Discovery**: 2025-09-02 10:12 AM
- **Root Cause Identified**: Table mismatch between upload (`businesses`) and retrieval (`business_info`)
- **Fix Complexity**: Simple (1 line change)
- **Testing Required**: Medium (verify across multiple businesses and photo types)

---
*Generated by Claude Code Root Cause Analysis*
*Report Date: 2025-09-02*