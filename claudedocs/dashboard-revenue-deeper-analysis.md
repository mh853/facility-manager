# 대시보드 매입금액 심층 분석

## 📊 분석 일시
2026-01-15 (추가 분석)

## 🎯 문제 재확인

개발 서버 재시작 후에도 대시보드의 2025-07월 매입금액이 여전히 **₩163,489,000**으로 변화 없음.

---

## 🔍 심층 분석 결과

### 1. 제조사 맵핑 검증 ✅

**테스트 결과:**
- 제조사 코드 변환 맵 빌드: **정상**
- 맵 키 목록: `['cleanearth', 'ecosense', 'gaia_cns', 'evs']`
- 각 제조사별 장비 수: 11개
- 사업장 제조사명 → 영문 코드 변환: **100% 성공**

**샘플 검증:**
```
"에코센스" → "ecosense" → ✅ 매칭
"크린어스" → "cleanearth" → ✅ 매칭
```

**결론**: 제조사 맵핑 로직은 정상 작동하고 있음.

---

### 2. 실제 원가 계산 검증 ⚠️

**2025-07월 샘플 사업장 분석:**

#### 사업장 1: 정진 P&G(보조금 동시진행)
- 제조사: "에코센스" → "ecosense" ✅
- 원가 데이터 존재: ✅
- 계산:
  ```
  discharge_current_meter: 2개 × 70,000원 = 140,000원
  fan_current_meter: 2개 × 70,000원 = 140,000원
  ph_meter: 2개 × 580,000원 = 1,160,000원
  총 매입금액: 1,440,000원
  ```

#### 사업장 2: 정진 P&G
- 제조사: "에코센스" → "ecosense" ✅
- 원가 데이터 존재: ✅
- **⚠️ vpn_wireless: 1개, 원가 0원 (데이터 누락?)**
- 계산:
  ```
  discharge_current_meter: 1개 × 70,000원 = 70,000원
  fan_current_meter: 1개 × 70,000원 = 70,000원
  ph_meter: 1개 × 580,000원 = 580,000원
  vpn_wireless: 1개 × 0원 = 0원 ❌
  총 매입금액: 720,000원 (vpn_wireless 누락)
  ```

#### 사업장 4: 서산농협미곡종합처리장
- 제조사: "에코센스" → "ecosense" ✅
- **⚠️ vpn_wireless: 4개, 원가 0원 (데이터 누락?)**
- 계산:
  ```
  discharge_current_meter: 14개 × 70,000원 = 980,000원
  fan_current_meter: 15개 × 70,000원 = 1,050,000원
  vpn_wireless: 4개 × 0원 = 0원 ❌
  총 매입금액: 2,030,000원 (vpn_wireless 누락)
  ```

#### 사업장 5: 동진하우징
- 제조사: "크린어스" → "cleanearth" ✅
- **⚠️ vpn_wireless: 2개, 원가 0원 (데이터 누락?)**
- 계산:
  ```
  discharge_current_meter: 1개 × 35,000원 = 35,000원
  fan_current_meter: 5개 × 35,000원 = 175,000원
  vpn_wireless: 2개 × 0원 = 0원 ❌
  총 매입금액: 210,000원 (vpn_wireless 누락)
  ```

---

### 3. DB 원가 데이터 확인 ❌

**manufacturer_pricing 테이블 - vpn_wireless 장비:**
```
크린어스: 0원 ❌
에코센스: 0원 ❌
가이아씨앤에스: 90,000원 ✅
이브이에스: 0원 ❌
```

**문제점:**
- vpn_wireless 장비의 원가가 대부분 **0원**으로 DB에 저장되어 있음
- 가이아씨앤에스만 90,000원으로 정상 저장
- 이로 인해 해당 장비가 설치된 사업장의 매입금액이 과소계산됨

---

## 🔧 근본 원인 분석

### 문제 1: 제조사 맵핑 (해결됨 ✅)
- **상태**: 수정 완료
- **내용**: 한글 제조사명 → 영문 코드 변환 로직 추가
- **검증**: 테스트 스크립트로 100% 매칭 확인

### 문제 2: DB 원가 데이터 누락 (현재 문제 ❌)
- **상태**: 미해결
- **내용**: manufacturer_pricing 테이블의 일부 장비 원가가 0원
- **영향**: vpn_wireless 등 특정 장비의 매입금액이 계산되지 않음
- **범위**: 전체 제조사의 vpn_wireless 원가가 0원 (가이아씨앤에스 제외)

---

## 📊 매출 관리 vs 대시보드 비교

### 매출 관리 페이지가 정상적인 이유?

사용자가 제공한 스크린샷의 매출 관리 페이지에서는:
- (주)병산산업: 매입 ₩889,600
- 대송레미판(주): 매입 ₩4,100,000
- 포성오앤피(주): 매입 ₩2,300,000

**가능한 원인:**
1. 매출 관리 페이지가 **다른 원가 데이터 소스**를 사용하고 있을 수 있음
2. 매출 관리 페이지가 **0원 원가에 대한 대체 로직**을 사용하고 있을 수 있음
3. 매출 관리 페이지에 표시되는 데이터와 대시보드 집계 데이터가 **다른 시점의 DB 스냅샷**일 수 있음

**확인 필요:**
- `/app/api/revenue/calculate/route.ts`의 원가 계산 로직 상세 분석
- `/app/admin/revenue/page.tsx`가 어떤 API를 호출하는지 확인
- 두 API 간 원가 데이터 소스 차이 확인

---

## 🎯 다음 단계 제안

### 즉시 조치
1. **DB 원가 데이터 보완**
   - manufacturer_pricing 테이블의 vpn_wireless 원가를 실제 값으로 업데이트
   - 다른 장비의 원가도 전수 검사

2. **매출 관리 API 로직 확인**
   - `/api/revenue/calculate` API가 어떻게 정상적인 매입금액을 계산하는지 분석
   - 대시보드 API와 로직 차이 파악

3. **원가 0원 처리 로직 추가**
   - 원가가 0원일 때 경고 로그 출력 (현재 있음)
   - 필요 시 기본값 또는 대체 로직 추가

### 검증 방법
1. DB에서 manufacturer_pricing 테이블의 모든 cost_price가 0인 항목 조회
2. 매출 관리 페이지와 대시보드의 동일 사업장 데이터 비교
3. 두 API의 원가 계산 로직 라인별 비교

---

## 📋 기술 상세

### 테스트 스크립트 위치
- `/scripts/check-manufacturers.js` - DB 제조사 목록 확인
- `/scripts/test-manufacturer-map.js` - 제조사 맵 변환 테스트
- `/scripts/verify-cost-calculation.js` - 실제 원가 계산 검증

### 수정된 파일
- `/app/api/dashboard/revenue/route.ts`
  - Line 110-116: manufacturerCodeMap 추가
  - Line 118-129: 맵 빌드 시 한글 → 영문 변환
  - Line 279-285: 맵 조회 시 한글 → 영문 변환

### DB 테이블 구조
```sql
CREATE TABLE manufacturer_pricing (
  id UUID PRIMARY KEY,
  manufacturer VARCHAR(50), -- 한글 이름 저장 (에코센스, 크린어스 등)
  equipment_type VARCHAR(50),
  cost_price DECIMAL(10, 2), -- 원가 (일부가 0원으로 저장됨)
  is_active BOOLEAN,
  effective_from DATE,
  effective_to DATE
);
```

---

## ✅ 확인된 사실

1. **제조사 맵핑 로직**: 정상 작동 ✅
2. **제조사 원가 맵 빌드**: 영문 코드로 정상 빌드 ✅
3. **사업장 제조사 조회**: 영문 코드로 정상 매칭 ✅
4. **DB 원가 데이터**: **일부 장비가 0원** ❌
5. **매입금액 계산**: DB 원가를 그대로 사용 (0원도 그대로) ⚠️

---

## 🔍 미해결 질문

1. **매출 관리 페이지는 왜 정상적인 매입금액을 표시하는가?**
   - 다른 원가 데이터 소스를 사용하는가?
   - 0원 원가에 대한 대체 로직이 있는가?
   - 다른 시점의 데이터를 사용하는가?

2. **DB의 vpn_wireless 원가는 왜 0원인가?**
   - 데이터 입력 오류인가?
   - 의도적으로 0원인 경우가 있는가?
   - 다른 테이블에 실제 원가가 저장되어 있는가?

3. **원가 0원 처리 로직이 필요한가?**
   - 0원일 때 기본값을 사용해야 하는가?
   - 다른 제조사의 평균값을 사용해야 하는가?
   - 아니면 경고만 출력하고 0원으로 계산해야 하는가?

---

**작성자**: Claude Code
**분석일**: 2026-01-15
**심각도**: 🔴 Critical (데이터 정확성 문제)
**상태**: 🔍 추가 조사 필요
