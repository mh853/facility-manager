<!DOCTYPE html>
<html>
<head>
    <title>Production Notification Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .result { margin: 10px 0; padding: 15px; border-left: 4px solid #007cba; background: #f0f8ff; border-radius: 4px; }
        .error { border-left-color: #dc3545; background: #f8d7da; color: #721c24; }
        .success { border-left-color: #28a745; background: #d4edda; color: #155724; }
        .warning { border-left-color: #ffc107; background: #fff3cd; color: #856404; }
        button { padding: 12px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 15px; overflow-x: auto; border-radius: 4px; font-size: 12px; white-space: pre-wrap; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007cba; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Production Notification Debug Tool</h1>
        <p>ë°°í¬ëœ í™˜ê²½ì—ì„œ ì•Œë¦¼ ì‹œìŠ¤í…œ API ì‘ë‹µ êµ¬ì¡°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>

        <div class="section">
            <div class="section-title">ğŸ”§ Quick Actions</div>
            <button onclick="checkAuth()" id="authBtn">1. ì¸ì¦ ìƒíƒœ í™•ì¸</button>
            <button onclick="testNotificationAPIs()" id="apiBtn" disabled>2. ì•Œë¦¼ API í…ŒìŠ¤íŠ¸</button>
            <button onclick="analyzeResponseStructure()" id="structBtn" disabled>3. ì‘ë‹µ êµ¬ì¡° ë¶„ì„</button>
            <button onclick="runFullDiagnosis()" id="diagBtn" disabled>4. ì „ì²´ ì§„ë‹¨ ì‹¤í–‰</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ ê²°ê³¼ ì§€ìš°ê¸°</button>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="generalCount">0</div>
                <div class="stat-label">ì¼ë°˜ ì•Œë¦¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="taskCount">0</div>
                <div class="stat-label">ì—…ë¬´ ì•Œë¦¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadCount">0</div>
                <div class="stat-label">ì½ì§€ ì•ŠìŒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ì „ì²´ ì•Œë¦¼</div>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let authToken = null;
        let apiResponses = {};

        function log(message, type = 'result') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;

            if (typeof message === 'object') {
                div.innerHTML = `<pre>${JSON.stringify(message, null, 2)}</pre>`;
            } else {
                div.innerHTML = message;
            }

            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
        }

        function updateStats(general = 0, tasks = 0, unread = 0) {
            document.getElementById('generalCount').textContent = general;
            document.getElementById('taskCount').textContent = tasks;
            document.getElementById('unreadCount').textContent = unread;
            document.getElementById('totalCount').textContent = general + tasks;
            document.getElementById('stats').style.display = 'grid';
        }

        async function checkAuth() {
            log('ğŸ” ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...', 'result');

            // ë‹¤ì–‘í•œ í† í° ìœ„ì¹˜ í™•ì¸
            const localToken = localStorage.getItem('auth_token');
            const supabaseToken = localStorage.getItem('supabase_auth_token');
            const cookieToken = document.cookie.split('; ').find(row => row.startsWith('auth_token='));

            log({
                'localStorage auth_token': localToken ? `ì¡´ì¬í•¨ (${localToken.substring(0, 30)}...)` : 'ì—†ìŒ',
                'localStorage supabase_token': supabaseToken ? `ì¡´ì¬í•¨` : 'ì—†ìŒ',
                'cookie auth_token': cookieToken ? `ì¡´ì¬í•¨ (${cookieToken.split('=')[1].substring(0, 30)}...)` : 'ì—†ìŒ',
                'current_url': window.location.href,
                'timestamp': new Date().toISOString()
            });

            authToken = localToken || (cookieToken ? cookieToken.split('=')[1] : null);

            if (authToken) {
                log('âœ… ì¸ì¦ í† í° ë°œê²¬ - API í…ŒìŠ¤íŠ¸ ê°€ëŠ¥', 'success');
                document.getElementById('apiBtn').disabled = false;
                return true;
            } else {
                log('âŒ ì¸ì¦ í† í° ì—†ìŒ - ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”', 'error');
                return false;
            }
        }

        async function testNotificationAPIs() {
            if (!authToken) {
                log('âŒ ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¸ì¦ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            log('ğŸ“Š ì•Œë¦¼ API í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'result');

            try {
                // 1. ì¼ë°˜ ì•Œë¦¼ API
                log('ğŸ”„ ì¼ë°˜ ì•Œë¦¼ API í˜¸ì¶œ ì¤‘...', 'result');
                const generalResponse = await fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                // 2. ì—…ë¬´ ì•Œë¦¼ API
                log('ğŸ”„ ì—…ë¬´ ì•Œë¦¼ API í˜¸ì¶œ ì¤‘...', 'result');
                const taskResponse = await fetch('/api/notifications?taskNotifications=true', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                // ì‘ë‹µ ë¶„ì„
                if (generalResponse.ok) {
                    const generalData = await generalResponse.json();
                    apiResponses.general = generalData;
                    log(`âœ… ì¼ë°˜ ì•Œë¦¼ API ì„±ê³µ (${generalResponse.status})`, 'success');
                    log({ 'general_response_structure': generalData });
                } else {
                    const generalError = await generalResponse.text();
                    log(`âŒ ì¼ë°˜ ì•Œë¦¼ API ì‹¤íŒ¨ (${generalResponse.status}): ${generalError}`, 'error');
                }

                if (taskResponse.ok) {
                    const taskData = await taskResponse.json();
                    apiResponses.task = taskData;
                    log(`âœ… ì—…ë¬´ ì•Œë¦¼ API ì„±ê³µ (${taskResponse.status})`, 'success');
                    log({ 'task_response_structure': taskData });
                } else {
                    const taskError = await taskResponse.text();
                    log(`âŒ ì—…ë¬´ ì•Œë¦¼ API ì‹¤íŒ¨ (${taskResponse.status}): ${taskError}`, 'error');
                }

                document.getElementById('structBtn').disabled = false;
                document.getElementById('diagBtn').disabled = false;

            } catch (error) {
                log(`ğŸ’¥ API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function analyzeResponseStructure() {
            log('ğŸ” API ì‘ë‹µ êµ¬ì¡° ë¶„ì„...', 'result');

            if (!apiResponses.general && !apiResponses.task) {
                log('âŒ ë¨¼ì € API í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¼ë°˜ ì•Œë¦¼ êµ¬ì¡° ë¶„ì„
            if (apiResponses.general) {
                log('ğŸ“‹ ì¼ë°˜ ì•Œë¦¼ API ì‘ë‹µ êµ¬ì¡° ë¶„ì„:', 'result');
                const general = apiResponses.general;

                log({
                    'response_keys': Object.keys(general),
                    'success': general.success,
                    'data_structure': general.data ? Object.keys(general.data) : 'no data key',
                    'notifications_array': Array.isArray(general.data) ? `ë°°ì—´ (ê¸¸ì´: ${general.data.length})` :
                                         Array.isArray(general.notifications) ? `ë°°ì—´ (ê¸¸ì´: ${general.notifications.length})` : 'ë°°ì—´ ì•„ë‹˜',
                    'first_item_structure': (general.data && general.data[0]) ? Object.keys(general.data[0]) :
                                          (general.notifications && general.notifications[0]) ? Object.keys(general.notifications[0]) : 'í•­ëª© ì—†ìŒ'
                });
            }

            // ì—…ë¬´ ì•Œë¦¼ êµ¬ì¡° ë¶„ì„
            if (apiResponses.task) {
                log('ğŸ“‹ ì—…ë¬´ ì•Œë¦¼ API ì‘ë‹µ êµ¬ì¡° ë¶„ì„:', 'result');
                const task = apiResponses.task;

                log({
                    'response_keys': Object.keys(task),
                    'success': task.success,
                    'data_structure': task.data ? Object.keys(task.data) : 'no data key',
                    'taskNotifications_array': task.data?.taskNotifications ?
                                             `ë°°ì—´ (ê¸¸ì´: ${task.data.taskNotifications.length})` :
                                             task.taskNotifications ? `ì§ì ‘ ë°°ì—´ (ê¸¸ì´: ${task.taskNotifications.length})` : 'ì—†ìŒ',
                    'first_item_structure': (task.data?.taskNotifications && task.data.taskNotifications[0]) ?
                                          Object.keys(task.data.taskNotifications[0]) :
                                          (task.taskNotifications && task.taskNotifications[0]) ?
                                          Object.keys(task.taskNotifications[0]) : 'í•­ëª© ì—†ìŒ'
                });
            }

            // í†µê³„ ì—…ë°ì´íŠ¸
            const generalCount = apiResponses.general?.data?.length || apiResponses.general?.notifications?.length || 0;
            const taskCount = apiResponses.task?.data?.taskNotifications?.length || apiResponses.task?.taskNotifications?.length || 0;
            const generalUnread = apiResponses.general?.data?.filter(n => !n.is_read)?.length || 0;
            const taskUnread = apiResponses.task?.data?.taskNotifications?.filter(n => !n.is_read)?.length || 0;

            updateStats(generalCount, taskCount, generalUnread + taskUnread);
        }

        async function runFullDiagnosis() {
            log('ğŸš€ ì „ì²´ ì§„ë‹¨ ì‹œì‘...', 'result');

            // NotificationContext ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
            log('ğŸ”„ NotificationContext ë°ì´í„° í†µí•© ë¡œì§ ì‹œë®¬ë ˆì´ì…˜...', 'result');

            try {
                const general = apiResponses.general;
                const task = apiResponses.task;

                // ì¼ë°˜ ì•Œë¦¼ ë³€í™˜ (ì‹¤ì œ ì½”ë“œì™€ ë™ì¼í•œ ë¡œì§)
                let allNotifications = [];

                if (general && general.success && general.data) {
                    const generalNotifications = Array.isArray(general.data) ? general.data : [];
                    log(`ğŸ“ ì¼ë°˜ ì•Œë¦¼ ë³€í™˜: ${generalNotifications.length}ê°œ`, 'result');
                    allNotifications.push(...generalNotifications);
                }

                // ì—…ë¬´ ì•Œë¦¼ ë³€í™˜ (ì‹¤ì œ ì½”ë“œì™€ ë™ì¼í•œ ë¡œì§)
                const taskNotificationsArray = task?.data?.taskNotifications || task?.taskNotifications || [];
                if (task && task.success && Array.isArray(taskNotificationsArray)) {
                    log(`ğŸ“ ì—…ë¬´ ì•Œë¦¼ ë³€í™˜: ${taskNotificationsArray.length}ê°œ`, 'result');

                    const taskNotifications = taskNotificationsArray.map(notif => ({
                        id: `task-${notif.id}`,
                        title: `ì—…ë¬´ í• ë‹¹: ${notif.business_name}`,
                        message: notif.message,
                        category: 'task_assigned',
                        priority: (notif.priority === 'urgent' ? 'critical' : notif.priority),
                        relatedResourceType: 'task',
                        relatedResourceId: notif.task_id,
                        relatedUrl: `/admin/tasks/${notif.task_id}`,
                        metadata: {
                            business_name: notif.business_name,
                            task_id: notif.task_id,
                            notification_type: notif.notification_type
                        },
                        createdById: notif.user_id,
                        createdByName: notif.user_name || 'ì‹œìŠ¤í…œ',
                        createdAt: notif.created_at,
                        expiresAt: notif.expires_at || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        isSystemNotification: false,
                        isRead: notif.is_read
                    }));

                    allNotifications.push(...taskNotifications);
                    log(`âœ… ì—…ë¬´ ì•Œë¦¼ ë³€í™˜ ì™„ë£Œ: ${taskNotifications.length}ê°œ`, 'success');
                    log({ 'converted_task_notifications_sample': taskNotifications[0] || 'no items' });
                } else {
                    log(`âš ï¸ ì—…ë¬´ ì•Œë¦¼ ë³€í™˜ ì‹¤íŒ¨: task.success=${task?.success}, isArray=${Array.isArray(taskNotificationsArray)}, length=${taskNotificationsArray.length}`, 'warning');
                }

                // ìµœì¢… ê²°ê³¼
                allNotifications.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

                log('ğŸ¯ ìµœì¢… ì§„ë‹¨ ê²°ê³¼:', 'result');
                log({
                    'ì „ì²´_ì•Œë¦¼_ìˆ˜': allNotifications.length,
                    'ì½ì§€_ì•Šì€_ì•Œë¦¼': allNotifications.filter(n => !n.isRead).length,
                    'API_ìƒíƒœ': {
                        'ì¼ë°˜_ì•Œë¦¼_API': apiResponses.general?.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨',
                        'ì—…ë¬´_ì•Œë¦¼_API': apiResponses.task?.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'
                    },
                    'ë°ì´í„°_êµ¬ì¡°_ë¬¸ì œ': {
                        'ì¼ë°˜_ì•Œë¦¼_ë°°ì—´': Array.isArray(apiResponses.general?.data),
                        'ì—…ë¬´_ì•Œë¦¼_ë°°ì—´': Array.isArray(taskNotificationsArray),
                        'ì—…ë¬´_ì•Œë¦¼_ê²½ë¡œ': task?.data?.taskNotifications ? 'data.taskNotifications' :
                                       task?.taskNotifications ? 'taskNotifications' : 'ì—†ìŒ'
                    }
                });

                if (allNotifications.length === 0) {
                    log('âŒ ìµœì¢… ê²°ê³¼: ì•Œë¦¼ì´ ì „í˜€ í‘œì‹œë˜ì§€ ì•ŠëŠ” ì´ìœ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!', 'error');
                } else {
                    log('âœ… ë°ì´í„° í†µí•© ì„±ê³µ - í™”ë©´ì— í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.', 'success');
                }

            } catch (error) {
                log(`ğŸ’¥ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            }
        }

        // ìë™ ì‹¤í–‰
        window.onload = function() {
            log('ğŸ”§ Production Notification Debug Tool ë¡œë“œ ì™„ë£Œ');
            log('ë°°í¬ëœ í™˜ê²½ì—ì„œ ì•Œë¦¼ ì‹œìŠ¤í…œ ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.');
            log('1. ì¸ì¦ ìƒíƒœ í™•ì¸ë¶€í„° ì‹œì‘í•˜ì„¸ìš”.');
        };
    </script>
</body>
</html>