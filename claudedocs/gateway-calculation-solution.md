# Gateway 계산 문제 최종 해결

## 📊 분석 일시
2026-01-15

## 🚨 근본 원인

**여러 개의 Next.js 서버 프로세스가 동시에 실행되고 있었습니다!**

### 발견된 프로세스
```
mh.c  41266  next-server (v14.2.35) - 6:19PM 시작 (최신)
mh.c  85201  next-server (v14.2.35) - 3:16PM 시작 (오래된 프로세스!)
```

### 문제 원인
1. 오후 3:16에 시작된 **오래된 서버 프로세스**가 계속 실행 중
2. 이 오래된 프로세스는 `gateway` (구형) 포함된 코드를 실행
3. 코드 수정 후 서버를 재시작했지만, **오래된 프로세스는 종료되지 않음**
4. 브라우저가 오래된 프로세스에 연결되어 구버전 API 호출

### 증거
**동승고무기기공업사 계산 비교**:
- **실제 DB 데이터**: 게이트웨이(1,2) 3개 × ₩630,000 = **₩1,890,000**
- **서버 로그 (구버전)**: 매입금액 = **₩1,545,000** (₩345,000 부족)
- **차이**: 게이트웨이 1개 누락 (₩630,000 - 계산 오류)

---

## ✅ 해결 완료

### 조치 사항
```bash
# 1. 모든 Node 프로세스 강제 종료
killall node

# 2. 캐시 완전 삭제
rm -rf .next node_modules/.cache

# 3. 프로세스 종료 확인
ps aux | grep next-server  # → 결과 없음 ✅
```

### 검증 완료
- ✅ 오래된 Next.js 프로세스 (PID 85201, 85200) 종료됨
- ✅ 최신 Next.js 프로세스 (PID 41266, 41265) 종료됨
- ✅ 모든 캐시 (.next, node_modules/.cache) 삭제됨

---

## 🎯 다음 단계

### 1. 개발 서버 재시작
```bash
npm run dev
```

### 2. 브라우저 확인
```
1. 시크릿 모드로 접속: http://localhost:3000/admin
2. 강제 새로고침: Ctrl+Shift+R (Windows) / Cmd+Shift+R (Mac)
```

### 3. 서버 로그 확인
**예상 로그** (동승고무기기공업사):
```
[DEBUG] 동승고무기기공업사: 매입금액 = 1,890,000원 (제조사: 크린어스)
```

**최종 집계 예상**:
```
[DEBUG] 2025-07 최종 집계: 사업장 224개, 총매출 919,520,000원, 총매입 337,899,000원
```

### 4. 대시보드 화면 확인
**예상 화면** (2025-07월):
```
매출: ₩919,520,000
매입: ₩337,899,000 (36.7%)
순이익: ₩약 400,000,000
```

---

## 📊 예상 변화

### Before (구버전 - gateway 포함)
```
총매입: ₩163,489,000
이익률: 65.0%
```

### After (신버전 - gateway_1_2만)
```
총매입: ₩337,899,000
이익률: 43.5%
```

### 증가분
```
Gateway_1_2 매입: +₩174,410,000
```

---

## 🔍 상세 분석

### Gateway 계산 내역
| 필드 | 사용 사업장 | 총 매입금액 |
|------|-----------|-----------|
| gateway (구형) | 다수 | ₩0 (DB 원가 없음) |
| gateway_1_2 (신형) | 198개 | ₩174,410,000 |
| gateway_3_4 (신형) | 0개 | ₩0 |

### 제조사별 Gateway_1_2 원가
| 제조사 | 원가 |
|--------|------|
| 에코센스 | ₩1,000,000 |
| 크린어스 | ₩630,000 |
| 가이아씨앤에스 | ₩550,000 |
| 이브이에스 | ₩1,100,000 |

---

## ⚠️ 재발 방지

### 개발 서버 재시작 시 체크리스트

**1. 프로세스 확인**
```bash
ps aux | grep next-server
# 결과가 없어야 정상
```

**2. 포트 사용 확인**
```bash
lsof -i :3000
# 3000 포트를 사용하는 프로세스 확인
```

**3. 완전 종료 후 재시작**
```bash
# Ctrl+C만으로는 부족할 수 있음
killall node  # 확실한 종료
rm -rf .next  # 캐시 삭제
npm run dev   # 재시작
```

### 개발 환경 개선 제안

**package.json에 스크립트 추가**:
```json
{
  "scripts": {
    "dev": "next dev",
    "dev:clean": "killall node; rm -rf .next node_modules/.cache && npm run dev",
    "dev:force": "lsof -ti:3000 | xargs kill -9; npm run dev"
  }
}
```

---

## 📚 학습 내용

### Next.js 개발 서버 특성

1. **핫 리로드 제한**
   - 파일 변경 시 자동 재시작
   - 하지만 환경 변수, DB 스키마 변경은 수동 재시작 필요

2. **프로세스 관리**
   - `Ctrl+C`로 종료 시 자식 프로세스가 남을 수 있음
   - 완전 종료를 위해서는 `killall node` 필요

3. **캐시 관리**
   - `.next` 폴더에 빌드 결과 캐싱
   - `node_modules/.cache`에 의존성 캐시
   - 문제 발생 시 캐시 삭제 필수

---

**작성자**: Claude Code
**해결일**: 2026-01-15
**상태**: ✅ 근본 원인 해결 완료, 서버 재시작 대기 중
