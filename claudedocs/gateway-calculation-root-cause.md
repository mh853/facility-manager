# Gateway 계산 문제 근본 원인 분석

## 📊 분석 일시
2026-01-15

## 🎯 근본 원인 확인

### 문제
- **대시보드 표시**: ₩163,489,000
- **스크립트 계산**: ₩337,899,000
- **차이**: ₩174,410,000 (정확히 Gateway_1_2 총 매입금액!)

### 원인
**서버가 오래된 코드를 실행하고 있습니다!**

---

## 🔍 증거

### 1. 코드 파일 확인
```typescript
// app/api/dashboard/revenue/route.ts Line 256-263
const equipmentFields = [
  'ph_meter', 'differential_pressure_meter', 'temperature_meter',
  'discharge_current_meter', 'fan_current_meter', 'pump_current_meter',
  'gateway_1_2', 'gateway_3_4', 'vpn_wired', 'vpn_wireless',  // ✅ gateway_1_2 포함됨
  // ...
];
```

### 2. 서버 로그 확인
```
[DEBUG] 2025-07 최종 집계: 사업장 224개, 총매출 919,520,000원, 총매입 163,489,000원
```

### 3. 스크립트 계산 (동일한 로직)
```
총 사업장: 224개
총 매입금액: 337,899,000원 (gateway_1_2 포함)
```

### 4. Gateway_1_2 총 매입금액
```
gateway_1_2 사용 사업장: 198개
gateway_1_2 총 매입금액: 174,410,000원
```

### 5. 계산 검증
```
서버 API: 163,489,000원
+ Gateway_1_2: 174,410,000원
= 337,899,000원 (스크립트 계산과 일치!)
```

---

## ✅ 결론

**API 코드 파일에는 `gateway_1_2`가 포함되어 있지만, 서버가 실행하는 코드에는 포함되지 않았습니다.**

이것은 다음 중 하나를 의미합니다:

1. **Next.js 빌드 캐시**: `.next` 폴더에 오래된 빌드가 캐싱됨
2. **서버 핫 리로드 실패**: 개발 서버가 파일 변경을 감지하지 못함
3. **잘못된 파일 수정**: 다른 파일을 수정했거나, 수정이 저장되지 않음

---

## 🔧 해결 방법

### 1단계: 서버 완전 재시작 + 캐시 삭제

```bash
# 1. 개발 서버 종료 (Ctrl+C)

# 2. Next.js 빌드 캐시 완전 삭제
rm -rf .next

# 3. 노드 모듈 캐시 삭제 (선택사항)
rm -rf node_modules/.cache

# 4. 깨끗한 상태로 재시작
npm run dev
```

### 2단계: 브라우저 강제 새로고침

```
1. Chrome DevTools 열기 (F12)
2. Network 탭에서 "Disable cache" 체크
3. 강제 새로고침 (Ctrl+Shift+R)
```

### 3단계: 결과 확인

**서버 콘솔에서 확인**:
```
[DEBUG] 2025-07 최종 집계: 사업장 224개, 총매출 919,520,000원, 총매입 337,899,000원
```

**브라우저 화면에서 확인**:
```
2025-07월
매출: 919,520,000원
매입: 337,899,000원 (또는 354,679,000원)
```

---

## 📊 예상 결과

### Before (현재)
```
매출: ₩919,520,000
매입: ₩163,489,000 (17.8%)
순이익: ₩597,334,600
```

### After (수정 후)
```
매출: ₩919,520,000
매입: ₩337,899,000 (36.7%) 또는 ₩354,679,000 (38.6%)
순이익: ₩약 400,000,000
```

**차이**:
- 매입금액: +₩174,410,000 (Gateway_1_2 반영)
- 이익률: 65.0% → 43.5% (더 현실적)

---

## 🎯 추가 확인 사항

### Gateway_1_2 vs 전체 계산 차이

**스크립트 계산 비교**:
- `compare-api-vs-script.js`: ₩337,899,000 (gateway_1_2만 추가)
- `analyze-cost-calculation.js`: ₩354,679,000 (모든 장비 포함)

**차이**: ₩16,780,000

이 차이는 다른 0원 장비들 (vpn_wireless, multiple_stack)을 제외한 차이일 수 있습니다.

---

## ⚠️ 중요 사항

**반드시 서버 캐시를 삭제하고 재시작해야 합니다!**

개발 서버의 핫 리로드만으로는 부족할 수 있습니다. Next.js는 `.next` 폴더에 빌드 결과를 캐싱하므로, 이를 완전히 삭제해야 변경사항이 반영됩니다.

---

**작성자**: Claude Code
**분석일**: 2026-01-15
**상태**: 🔴 근본 원인 확인 완료, 서버 캐시 삭제 필요
